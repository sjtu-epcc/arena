
------------------------------------------------------------------
- (1/3) Profiling moe_1.3B with batch size: 256...
------------------------------------------------------------------
[TMP] Existed profiling results in `./jaxpr/prof_log/optimal/moe_1.3B_256.pkl`, updating/rewriting it...
[I] Ray Cluster & Alpa backend initialization is completed.
[I] Device Info:
    - Devices num per node: 2
    - Nodes num: 2
[I] Loading flax model....
[I] Model 'moe' loads sucessfully. Model Info: 

FlaxMoEForLMModule(
    # attributes
    config = <model.moe_model.MoEConfig object at 0x7f1fa74919d0>
    dtype = float16
    bias_init = zeros
) 

[I] Manually constructing dummy batch...
[I] Initialize training state...
[I] Training state initialization is completed.
[I] Constructing Alpa parallelized train step func...
[I] Alpa parallelized train step func construction is completed.
-------------------- Automatic stage clustering --------------------
submesh_choices: ((1, 1), (1, 2), (2, 2))
- Profiling for submesh 2 (2, 2):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(0, 7, 2, 0), 0] = ModuleProfileResult(compute_cost=0.023, peak_memory=2.494 GB, invar_size=2.201 GB, outvar_size=0.041 GB, temp_buffer_size=0.252 GB, available_memory=35.242 GB)
result[(0, 7, 2, 1), 0] = ModuleProfileResult(compute_cost=0.044, peak_memory=1.531 GB, invar_size=1.101 GB, outvar_size=0.041 GB, temp_buffer_size=0.389 GB, available_memory=35.242 GB)
result[(0, 7, 2, 2), 0] = ModuleProfileResult(compute_cost=0.061, peak_memory=1.017 GB, invar_size=0.724 GB, outvar_size=0.041 GB, temp_buffer_size=0.252 GB, available_memory=35.242 GB)
result[(0, 7, 2, 0), 1] = ModuleProfileResult(compute_cost=0.210, peak_memory=7.705 GB, invar_size=5.150 GB, outvar_size=2.554 GB, temp_buffer_size=2.555 GB, available_memory=35.242 GB)
result[(0, 7, 2, 1), 1] = ModuleProfileResult(compute_cost=0.299, peak_memory=4.284 GB, invar_size=2.596 GB, outvar_size=1.277 GB, temp_buffer_size=1.688 GB, available_memory=35.242 GB)
result[(0, 7, 2, 2), 1] = ModuleProfileResult(compute_cost=0.182, peak_memory=3.225 GB, invar_size=1.775 GB, outvar_size=0.867 GB, temp_buffer_size=1.450 GB, available_memory=35.242 GB)
Profiling for submesh 2 (2, 2) takes 87.20 seconds
--------------------------------------------------
- Profiling for submesh 1 (1, 2):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(1, 4, 1, 0), 0] = ModuleProfileResult(compute_cost=0.024, peak_memory=1.694 GB, invar_size=1.260 GB, outvar_size=0.047 GB, temp_buffer_size=0.387 GB, available_memory=35.242 GB)
result[(1, 4, 1, 2), 0] = ModuleProfileResult(compute_cost=0.034, peak_memory=1.131 GB, invar_size=0.698 GB, outvar_size=0.047 GB, temp_buffer_size=0.387 GB, available_memory=35.242 GB)
result[(0, 3, 1, 2), 0] = ModuleProfileResult(compute_cost=0.034, peak_memory=1.249 GB, invar_size=0.698 GB, outvar_size=0.047 GB, temp_buffer_size=0.504 GB, available_memory=35.242 GB)
result[(0, 3, 1, 0), 0] = ModuleProfileResult(compute_cost=0.025, peak_memory=1.811 GB, invar_size=1.260 GB, outvar_size=0.047 GB, temp_buffer_size=0.504 GB, available_memory=35.242 GB)
result[(0, 3, 1, 1), 0] = ModuleProfileResult(compute_cost=0.080, peak_memory=1.201 GB, invar_size=0.630 GB, outvar_size=0.082 GB, temp_buffer_size=0.488 GB, available_memory=35.242 GB)
result[(1, 4, 1, 1), 0] = ModuleProfileResult(compute_cost=0.086, peak_memory=1.140 GB, invar_size=0.648 GB, outvar_size=0.094 GB, temp_buffer_size=0.399 GB, available_memory=35.242 GB)
result[(1, 5, 1, 0), 0] = ModuleProfileResult(compute_cost=0.030, peak_memory=2.013 GB, invar_size=1.568 GB, outvar_size=0.059 GB, temp_buffer_size=0.387 GB, available_memory=35.242 GB)
result[(1, 5, 1, 1), 0] = ModuleProfileResult(compute_cost=0.106, peak_memory=1.318 GB, invar_size=0.802 GB, outvar_size=0.117 GB, temp_buffer_size=0.399 GB, available_memory=35.242 GB)
result[(0, 3, 1, 1), 1] = ModuleProfileResult(compute_cost=0.181, peak_memory=4.001 GB, invar_size=1.354 GB, outvar_size=0.630 GB, temp_buffer_size=2.647 GB, available_memory=35.242 GB)
result[(1, 4, 1, 0), 1] = ModuleProfileResult(compute_cost=0.082, peak_memory=4.772 GB, invar_size=2.555 GB, outvar_size=1.260 GB, temp_buffer_size=2.205 GB, available_memory=35.242 GB)
result[(0, 3, 1, 0), 1] = ModuleProfileResult(compute_cost=0.082, peak_memory=4.832 GB, invar_size=2.568 GB, outvar_size=1.260 GB, temp_buffer_size=2.264 GB, available_memory=35.242 GB)
result[(1, 4, 1, 1), 1] = ModuleProfileResult(compute_cost=0.189, peak_memory=4.163 GB, invar_size=1.366 GB, outvar_size=0.648 GB, temp_buffer_size=2.774 GB, available_memory=35.242 GB)
result[(0, 3, 1, 2), 1] = ModuleProfileResult(compute_cost=0.090, peak_memory=3.707 GB, invar_size=1.443 GB, outvar_size=0.698 GB, temp_buffer_size=2.264 GB, available_memory=35.242 GB)
result[(2, 5, 1, 0), 0] = ModuleProfileResult(compute_cost=0.024, peak_memory=1.694 GB, invar_size=1.260 GB, outvar_size=0.047 GB, temp_buffer_size=0.387 GB, available_memory=35.242 GB)
result[(1, 4, 1, 2), 1] = ModuleProfileResult(compute_cost=0.090, peak_memory=3.671 GB, invar_size=1.442 GB, outvar_size=0.698 GB, temp_buffer_size=2.217 GB, available_memory=35.242 GB)
result[(2, 5, 1, 1), 0] = ModuleProfileResult(compute_cost=0.086, peak_memory=1.140 GB, invar_size=0.648 GB, outvar_size=0.094 GB, temp_buffer_size=0.399 GB, available_memory=35.242 GB)
result[(2, 5, 1, 2), 0] = ModuleProfileResult(compute_cost=0.034, peak_memory=1.131 GB, invar_size=0.698 GB, outvar_size=0.047 GB, temp_buffer_size=0.387 GB, available_memory=35.242 GB)
result[(1, 5, 1, 2), 0] = ModuleProfileResult(compute_cost=0.042, peak_memory=1.310 GB, invar_size=0.865 GB, outvar_size=0.059 GB, temp_buffer_size=0.387 GB, available_memory=35.242 GB)
result[(1, 5, 1, 0), 1] = ModuleProfileResult(compute_cost=0.102, peak_memory=5.411 GB, invar_size=3.182 GB, outvar_size=1.568 GB, temp_buffer_size=2.217 GB, available_memory=35.242 GB)
result[(2, 6, 1, 0), 0] = ModuleProfileResult(compute_cost=0.030, peak_memory=2.013 GB, invar_size=1.568 GB, outvar_size=0.059 GB, temp_buffer_size=0.387 GB, available_memory=35.242 GB)
result[(3, 6, 1, 0), 0] = ModuleProfileResult(compute_cost=0.024, peak_memory=1.694 GB, invar_size=1.260 GB, outvar_size=0.047 GB, temp_buffer_size=0.387 GB, available_memory=35.242 GB)
result[(2, 5, 1, 0), 1] = ModuleProfileResult(compute_cost=0.082, peak_memory=4.784 GB, invar_size=2.555 GB, outvar_size=1.260 GB, temp_buffer_size=2.217 GB, available_memory=35.242 GB)
result[(2, 6, 1, 1), 0] = ModuleProfileResult(compute_cost=0.106, peak_memory=1.318 GB, invar_size=0.802 GB, outvar_size=0.117 GB, temp_buffer_size=0.399 GB, available_memory=35.242 GB)
result[(2, 5, 1, 1), 1] = ModuleProfileResult(compute_cost=0.189, peak_memory=4.093 GB, invar_size=1.366 GB, outvar_size=0.648 GB, temp_buffer_size=2.704 GB, available_memory=35.242 GB)
result[(2, 6, 1, 2), 0] = ModuleProfileResult(compute_cost=0.042, peak_memory=1.310 GB, invar_size=0.865 GB, outvar_size=0.059 GB, temp_buffer_size=0.387 GB, available_memory=35.242 GB)
result[(1, 5, 1, 1), 1] = ModuleProfileResult(compute_cost=0.234, peak_memory=4.544 GB, invar_size=1.697 GB, outvar_size=0.801 GB, temp_buffer_size=2.824 GB, available_memory=35.242 GB)
result[(3, 6, 1, 1), 0] = ModuleProfileResult(compute_cost=0.086, peak_memory=1.140 GB, invar_size=0.648 GB, outvar_size=0.094 GB, temp_buffer_size=0.399 GB, available_memory=35.242 GB)
result[(1, 5, 1, 2), 1] = ModuleProfileResult(compute_cost=0.112, peak_memory=4.005 GB, invar_size=1.776 GB, outvar_size=0.865 GB, temp_buffer_size=2.217 GB, available_memory=35.242 GB)
result[(2, 5, 1, 2), 1] = ModuleProfileResult(compute_cost=0.090, peak_memory=3.659 GB, invar_size=1.430 GB, outvar_size=0.698 GB, temp_buffer_size=2.217 GB, available_memory=35.242 GB)
result[(4, 7, 1, 0), 0] = ModuleProfileResult(compute_cost=0.018, peak_memory=1.375 GB, invar_size=0.952 GB, outvar_size=0.035 GB, temp_buffer_size=0.387 GB, available_memory=35.242 GB)
result[(4, 7, 1, 2), 0] = ModuleProfileResult(compute_cost=0.025, peak_memory=0.953 GB, invar_size=0.530 GB, outvar_size=0.035 GB, temp_buffer_size=0.387 GB, available_memory=35.242 GB)
result[(3, 6, 1, 2), 0] = ModuleProfileResult(compute_cost=0.034, peak_memory=1.131 GB, invar_size=0.698 GB, outvar_size=0.047 GB, temp_buffer_size=0.387 GB, available_memory=35.242 GB)
result[(4, 7, 1, 1), 0] = ModuleProfileResult(compute_cost=0.065, peak_memory=0.963 GB, invar_size=0.494 GB, outvar_size=0.070 GB, temp_buffer_size=0.399 GB, available_memory=35.242 GB)
result[(2, 6, 1, 0), 1] = ModuleProfileResult(compute_cost=0.102, peak_memory=5.411 GB, invar_size=3.182 GB, outvar_size=1.568 GB, temp_buffer_size=2.217 GB, available_memory=35.242 GB)
result[(3, 6, 1, 0), 1] = ModuleProfileResult(compute_cost=0.082, peak_memory=4.784 GB, invar_size=2.555 GB, outvar_size=1.260 GB, temp_buffer_size=2.217 GB, available_memory=35.242 GB)
result[(2, 6, 1, 2), 1] = ModuleProfileResult(compute_cost=0.112, peak_memory=4.005 GB, invar_size=1.776 GB, outvar_size=0.865 GB, temp_buffer_size=2.217 GB, available_memory=35.242 GB)
result[(2, 6, 1, 1), 1] = ModuleProfileResult(compute_cost=0.234, peak_memory=4.567 GB, invar_size=1.697 GB, outvar_size=0.801 GB, temp_buffer_size=2.847 GB, available_memory=35.242 GB)
result[(3, 6, 1, 1), 1] = ModuleProfileResult(compute_cost=0.189, peak_memory=4.141 GB, invar_size=1.366 GB, outvar_size=0.648 GB, temp_buffer_size=2.752 GB, available_memory=35.242 GB)
result[(3, 6, 1, 2), 1] = ModuleProfileResult(compute_cost=0.090, peak_memory=3.659 GB, invar_size=1.430 GB, outvar_size=0.698 GB, temp_buffer_size=2.217 GB, available_memory=35.242 GB)
result[(4, 7, 1, 1), 1] = ModuleProfileResult(compute_cost=0.201, peak_memory=4.385 GB, invar_size=1.388 GB, outvar_size=0.671 GB, temp_buffer_size=2.973 GB, available_memory=35.242 GB)
result[(4, 7, 1, 0), 1] = ModuleProfileResult(compute_cost=0.091, peak_memory=5.536 GB, invar_size=2.635 GB, outvar_size=1.306 GB, temp_buffer_size=2.889 GB, available_memory=35.242 GB)
result[(4, 7, 1, 2), 1] = ModuleProfileResult(compute_cost=0.104, peak_memory=4.377 GB, invar_size=1.464 GB, outvar_size=0.720 GB, temp_buffer_size=2.901 GB, available_memory=35.242 GB)
Profiling for submesh 1 (1, 2) takes 71.90 seconds
--------------------------------------------------
- Profiling for submesh 0 (1, 1):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(1, 2, 0, 0), 0] = ModuleProfileResult(compute_cost=0.021, peak_memory=1.460 GB, invar_size=0.639 GB, outvar_size=0.047 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(0, 1, 0, 0), 0] = ModuleProfileResult(compute_cost=0.025, peak_memory=1.700 GB, invar_size=0.645 GB, outvar_size=0.047 GB, temp_buffer_size=1.008 GB, available_memory=35.242 GB)
result[(0, 1, 0, 1), 0] = ModuleProfileResult(compute_cost=0.025, peak_memory=1.700 GB, invar_size=0.645 GB, outvar_size=0.047 GB, temp_buffer_size=1.008 GB, available_memory=35.242 GB)
result[(2, 3, 0, 1), 0] = ModuleProfileResult(compute_cost=0.021, peak_memory=1.460 GB, invar_size=0.639 GB, outvar_size=0.047 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(2, 3, 0, 0), 0] = ModuleProfileResult(compute_cost=0.021, peak_memory=1.460 GB, invar_size=0.639 GB, outvar_size=0.047 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(1, 2, 0, 1), 0] = ModuleProfileResult(compute_cost=0.021, peak_memory=1.460 GB, invar_size=0.639 GB, outvar_size=0.047 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(3, 4, 0, 0), 0] = ModuleProfileResult(compute_cost=0.024, peak_memory=1.477 GB, invar_size=0.656 GB, outvar_size=0.047 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(2, 3, 0, 0), 1] = ModuleProfileResult(compute_cost=0.062, peak_memory=5.575 GB, invar_size=1.301 GB, outvar_size=0.639 GB, temp_buffer_size=4.250 GB, available_memory=35.242 GB)
result[(0, 1, 0, 1), 1] = ModuleProfileResult(compute_cost=0.067, peak_memory=6.123 GB, invar_size=1.337 GB, outvar_size=0.645 GB, temp_buffer_size=4.786 GB, available_memory=35.242 GB)
result[(0, 1, 0, 0), 1] = ModuleProfileResult(compute_cost=0.067, peak_memory=6.123 GB, invar_size=1.337 GB, outvar_size=0.645 GB, temp_buffer_size=4.786 GB, available_memory=35.242 GB)
result[(1, 2, 0, 0), 1] = ModuleProfileResult(compute_cost=0.062, peak_memory=5.575 GB, invar_size=1.301 GB, outvar_size=0.639 GB, temp_buffer_size=4.250 GB, available_memory=35.242 GB)
result[(1, 2, 0, 1), 1] = ModuleProfileResult(compute_cost=0.062, peak_memory=5.575 GB, invar_size=1.301 GB, outvar_size=0.639 GB, temp_buffer_size=4.250 GB, available_memory=35.242 GB)
result[(2, 3, 0, 1), 1] = ModuleProfileResult(compute_cost=0.062, peak_memory=5.575 GB, invar_size=1.301 GB, outvar_size=0.639 GB, temp_buffer_size=4.250 GB, available_memory=35.242 GB)
result[(3, 4, 0, 0), 1] = ModuleProfileResult(compute_cost=0.068, peak_memory=5.887 GB, invar_size=1.336 GB, outvar_size=0.656 GB, temp_buffer_size=4.527 GB, available_memory=35.242 GB)
result[(4, 5, 0, 0), 0] = ModuleProfileResult(compute_cost=0.024, peak_memory=1.477 GB, invar_size=0.656 GB, outvar_size=0.047 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(3, 4, 0, 1), 0] = ModuleProfileResult(compute_cost=0.024, peak_memory=1.477 GB, invar_size=0.656 GB, outvar_size=0.047 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(4, 5, 0, 1), 0] = ModuleProfileResult(compute_cost=0.024, peak_memory=1.477 GB, invar_size=0.656 GB, outvar_size=0.047 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(5, 6, 0, 0), 0] = ModuleProfileResult(compute_cost=0.021, peak_memory=1.460 GB, invar_size=0.639 GB, outvar_size=0.047 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(6, 7, 0, 0), 0] = ModuleProfileResult(compute_cost=0.011, peak_memory=1.129 GB, invar_size=0.331 GB, outvar_size=0.023 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(6, 7, 0, 1), 0] = ModuleProfileResult(compute_cost=0.011, peak_memory=1.129 GB, invar_size=0.331 GB, outvar_size=0.023 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(5, 6, 0, 1), 0] = ModuleProfileResult(compute_cost=0.021, peak_memory=1.460 GB, invar_size=0.639 GB, outvar_size=0.047 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(3, 4, 0, 1), 1] = ModuleProfileResult(compute_cost=0.068, peak_memory=5.887 GB, invar_size=1.336 GB, outvar_size=0.656 GB, temp_buffer_size=4.527 GB, available_memory=35.242 GB)
result[(4, 5, 0, 1), 1] = ModuleProfileResult(compute_cost=0.068, peak_memory=6.240 GB, invar_size=1.336 GB, outvar_size=0.656 GB, temp_buffer_size=4.881 GB, available_memory=35.242 GB)
result[(4, 5, 0, 0), 1] = ModuleProfileResult(compute_cost=0.068, peak_memory=6.240 GB, invar_size=1.336 GB, outvar_size=0.656 GB, temp_buffer_size=4.881 GB, available_memory=35.242 GB)
result[(5, 6, 0, 0), 1] = ModuleProfileResult(compute_cost=0.062, peak_memory=5.762 GB, invar_size=1.301 GB, outvar_size=0.639 GB, temp_buffer_size=4.438 GB, available_memory=35.242 GB)
result[(5, 6, 0, 1), 1] = ModuleProfileResult(compute_cost=0.062, peak_memory=5.762 GB, invar_size=1.301 GB, outvar_size=0.639 GB, temp_buffer_size=4.438 GB, available_memory=35.242 GB)
result[(6, 7, 0, 0), 1] = ModuleProfileResult(compute_cost=0.079, peak_memory=7.195 GB, invar_size=1.369 GB, outvar_size=0.685 GB, temp_buffer_size=5.802 GB, available_memory=35.242 GB)
result[(6, 7, 0, 1), 1] = ModuleProfileResult(compute_cost=0.079, peak_memory=7.195 GB, invar_size=1.369 GB, outvar_size=0.685 GB, temp_buffer_size=5.802 GB, available_memory=35.242 GB)
Profiling for submesh 0 (1, 1) takes 26.49 seconds
--------------------------------------------------
----------------------------------------------------------------------
Result forward_stage_layer_ids: [[0, 1], [2, 3], [4, 5], [6, 7]]
Result mesh_shapes: [(1, 1), (1, 1), (1, 1), (1, 1)]
Result logical_mesh_shapes: [(1, 1), (1, 1), (1, 1), (1, 1)]
Result autosharding_option_dicts: [{'force_batch_dim_to_mesh_dim': 0}, {}, {}, {'force_batch_dim_to_mesh_dim': 0}]
 - Compile (driver): 221.53 s
compilation time breakdown: {'stage-construction': '189.12', 'stage-construction-dp': '1.30', 'stage-construction-compilation': '90.00', 'stage-construction-profiling': '47.21'}
 - Compile (worker): 8.98 s
[I] Training process warmup (2 rounds) with dummy input batch...
    - Warmup iteration: 1/2
    - Warmup iteration: 2/2
[I] Ready to perform training process.
[I] Benchmark the training process with entire dataset and profile with driver overhead...
    - Iteration 1 / 5 is performed...
    - Iteration 2 / 5 is performed...
    - Iteration 3 / 5 is performed...
    - Iteration 4 / 5 is performed...
 - Benchmark: 48.67 s

[12.920560359954834, 5.349018335342407, 5.39795708656311, 5.500809669494629, 5.410709619522095, 5.4395668506622314, 5.514821767807007]


[I] Performance metrics:
 - Iteration count: 5.
 - Total e2e training time : 28.371 s.
 - Average e2e iteration time: 5.674000263214111 s.
 - Total local training time: 27.264001846313477 s.
 - Average local iteration time: 5.453000068664551 s.
 - Max allocated memory among devices: 9.224 GB.
 - Compilation times:  {'stage-construction': 189.12116503715515, 'stage-construction-dp': 1.3029141426086426, 'stage-construction-compilation': 90.00458550453186, 'stage-construction-profiling': 47.20907163619995}
 - Metadata:  []
 - Is need save result:  True

[TMP] Current profiling results of key `2_a40_2_n_2_d`: 5.452773094177246
[TMP] Updated profiling results stored in `./jaxpr/prof_log/optimal/moe_1.3B_256.pkl`...

------------------------------------------------------------------
- (2/3) Profiling moe_1.3B with batch size: 512...
------------------------------------------------------------------
[TMP] Existed profiling results in `./jaxpr/prof_log/optimal/moe_1.3B_512.pkl`, updating/rewriting it...
[I] Ray Cluster & Alpa backend initialization is completed.
[I] Device Info:
    - Devices num per node: 2
    - Nodes num: 2
[I] Loading flax model....
[I] Model 'moe' loads sucessfully. Model Info: 

FlaxMoEForLMModule(
    # attributes
    config = <model.moe_model.MoEConfig object at 0x7f880f40a8b0>
    dtype = float16
    bias_init = zeros
) 

[I] Manually constructing dummy batch...
[I] Initialize training state...
[I] Training state initialization is completed.
[I] Constructing Alpa parallelized train step func...
[I] Alpa parallelized train step func construction is completed.
-------------------- Automatic stage clustering --------------------
submesh_choices: ((1, 1), (1, 2), (2, 2))
- Profiling for submesh 2 (2, 2):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(0, 7, 2, 0), 0] = ModuleProfileResult(compute_cost=0.043, peak_memory=2.787 GB, invar_size=2.201 GB, outvar_size=0.082 GB, temp_buffer_size=0.504 GB, available_memory=35.242 GB)
result[(0, 7, 2, 1), 0] = ModuleProfileResult(compute_cost=0.072, peak_memory=1.722 GB, invar_size=1.109 GB, outvar_size=0.082 GB, temp_buffer_size=0.532 GB, available_memory=35.242 GB)
result[(0, 7, 2, 2), 0] = ModuleProfileResult(compute_cost=0.109, peak_memory=1.310 GB, invar_size=0.725 GB, outvar_size=0.082 GB, temp_buffer_size=0.504 GB, available_memory=35.242 GB)
result[(0, 7, 2, 0), 1] = ModuleProfileResult(compute_cost=0.279, peak_memory=8.092 GB, invar_size=5.191 GB, outvar_size=2.554 GB, temp_buffer_size=2.901 GB, available_memory=35.242 GB)
result[(0, 7, 2, 1), 1] = ModuleProfileResult(compute_cost=0.430, peak_memory=6.472 GB, invar_size=2.655 GB, outvar_size=1.286 GB, temp_buffer_size=3.818 GB, available_memory=35.242 GB)
result[(0, 7, 2, 2), 1] = ModuleProfileResult(compute_cost=0.314, peak_memory=4.717 GB, invar_size=1.816 GB, outvar_size=0.867 GB, temp_buffer_size=2.901 GB, available_memory=35.242 GB)
Profiling for submesh 2 (2, 2) takes 86.33 seconds
--------------------------------------------------
- Profiling for submesh 1 (1, 2):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(1, 4, 1, 2), 0] = ModuleProfileResult(compute_cost=0.063, peak_memory=1.577 GB, invar_size=0.709 GB, outvar_size=0.094 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(0, 3, 1, 2), 0] = ModuleProfileResult(compute_cost=0.064, peak_memory=1.800 GB, invar_size=0.698 GB, outvar_size=0.094 GB, temp_buffer_size=1.008 GB, available_memory=35.242 GB)
result[(1, 4, 1, 0), 0] = ModuleProfileResult(compute_cost=0.045, peak_memory=2.140 GB, invar_size=1.272 GB, outvar_size=0.094 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(1, 4, 1, 1), 0] = ModuleProfileResult(compute_cost=0.165, peak_memory=1.657 GB, invar_size=0.671 GB, outvar_size=0.188 GB, temp_buffer_size=0.798 GB, available_memory=35.242 GB)
result[(0, 3, 1, 0), 0] = ModuleProfileResult(compute_cost=0.046, peak_memory=2.362 GB, invar_size=1.261 GB, outvar_size=0.094 GB, temp_buffer_size=1.008 GB, available_memory=35.242 GB)
result[(0, 3, 1, 1), 0] = ModuleProfileResult(compute_cost=0.152, peak_memory=1.771 GB, invar_size=0.631 GB, outvar_size=0.164 GB, temp_buffer_size=0.977 GB, available_memory=35.242 GB)
result[(1, 5, 1, 0), 0] = ModuleProfileResult(compute_cost=0.055, peak_memory=2.471 GB, invar_size=1.579 GB, outvar_size=0.117 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(1, 5, 1, 1), 0] = ModuleProfileResult(compute_cost=0.204, peak_memory=1.857 GB, invar_size=0.825 GB, outvar_size=0.234 GB, temp_buffer_size=0.798 GB, available_memory=35.242 GB)
result[(0, 3, 1, 2), 1] = ModuleProfileResult(compute_cost=0.166, peak_memory=6.018 GB, invar_size=1.490 GB, outvar_size=0.698 GB, temp_buffer_size=4.528 GB, available_memory=35.242 GB)
result[(1, 4, 1, 0), 1] = ModuleProfileResult(compute_cost=0.142, peak_memory=7.048 GB, invar_size=2.614 GB, outvar_size=1.272 GB, temp_buffer_size=4.411 GB, available_memory=35.242 GB)
result[(1, 4, 1, 1), 1] = ModuleProfileResult(compute_cost=0.364, peak_memory=7.076 GB, invar_size=1.483 GB, outvar_size=0.671 GB, temp_buffer_size=5.546 GB, available_memory=35.242 GB)
result[(1, 4, 1, 2), 1] = ModuleProfileResult(compute_cost=0.167, peak_memory=5.970 GB, invar_size=1.512 GB, outvar_size=0.709 GB, temp_buffer_size=4.434 GB, available_memory=35.242 GB)
result[(0, 3, 1, 0), 1] = ModuleProfileResult(compute_cost=0.141, peak_memory=7.143 GB, invar_size=2.615 GB, outvar_size=1.260 GB, temp_buffer_size=4.528 GB, available_memory=35.242 GB)
result[(0, 3, 1, 1), 1] = ModuleProfileResult(compute_cost=0.349, peak_memory=6.738 GB, invar_size=1.448 GB, outvar_size=0.630 GB, temp_buffer_size=5.290 GB, available_memory=35.242 GB)
result[(2, 5, 1, 0), 0] = ModuleProfileResult(compute_cost=0.045, peak_memory=2.140 GB, invar_size=1.272 GB, outvar_size=0.094 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(2, 5, 1, 1), 0] = ModuleProfileResult(compute_cost=0.165, peak_memory=1.657 GB, invar_size=0.671 GB, outvar_size=0.188 GB, temp_buffer_size=0.798 GB, available_memory=35.242 GB)
result[(1, 5, 1, 2), 0] = ModuleProfileResult(compute_cost=0.078, peak_memory=1.768 GB, invar_size=0.876 GB, outvar_size=0.117 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(2, 5, 1, 2), 0] = ModuleProfileResult(compute_cost=0.063, peak_memory=1.577 GB, invar_size=0.709 GB, outvar_size=0.094 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(1, 5, 1, 0), 1] = ModuleProfileResult(compute_cost=0.176, peak_memory=7.710 GB, invar_size=3.253 GB, outvar_size=1.579 GB, temp_buffer_size=4.434 GB, available_memory=35.242 GB)
result[(2, 5, 1, 0), 1] = ModuleProfileResult(compute_cost=0.142, peak_memory=7.071 GB, invar_size=2.614 GB, outvar_size=1.272 GB, temp_buffer_size=4.434 GB, available_memory=35.242 GB)
result[(2, 6, 1, 0), 0] = ModuleProfileResult(compute_cost=0.055, peak_memory=2.471 GB, invar_size=1.579 GB, outvar_size=0.117 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(2, 5, 1, 1), 1] = ModuleProfileResult(compute_cost=0.364, peak_memory=6.935 GB, invar_size=1.483 GB, outvar_size=0.671 GB, temp_buffer_size=5.406 GB, available_memory=35.242 GB)
result[(3, 6, 1, 0), 0] = ModuleProfileResult(compute_cost=0.045, peak_memory=2.140 GB, invar_size=1.272 GB, outvar_size=0.094 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(2, 6, 1, 2), 0] = ModuleProfileResult(compute_cost=0.078, peak_memory=1.768 GB, invar_size=0.876 GB, outvar_size=0.117 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(3, 6, 1, 1), 0] = ModuleProfileResult(compute_cost=0.165, peak_memory=1.657 GB, invar_size=0.671 GB, outvar_size=0.188 GB, temp_buffer_size=0.798 GB, available_memory=35.242 GB)
result[(2, 6, 1, 1), 0] = ModuleProfileResult(compute_cost=0.204, peak_memory=1.857 GB, invar_size=0.825 GB, outvar_size=0.234 GB, temp_buffer_size=0.798 GB, available_memory=35.242 GB)
result[(1, 5, 1, 1), 1] = ModuleProfileResult(compute_cost=0.452, peak_memory=7.528 GB, invar_size=1.837 GB, outvar_size=0.825 GB, temp_buffer_size=5.644 GB, available_memory=35.242 GB)
result[(1, 5, 1, 2), 1] = ModuleProfileResult(compute_cost=0.207, peak_memory=6.304 GB, invar_size=1.846 GB, outvar_size=0.876 GB, temp_buffer_size=4.434 GB, available_memory=35.242 GB)
result[(4, 7, 1, 0), 0] = ModuleProfileResult(compute_cost=0.034, peak_memory=1.808 GB, invar_size=0.964 GB, outvar_size=0.070 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(2, 5, 1, 2), 1] = ModuleProfileResult(compute_cost=0.167, peak_memory=5.946 GB, invar_size=1.489 GB, outvar_size=0.709 GB, temp_buffer_size=4.434 GB, available_memory=35.242 GB)
result[(3, 6, 1, 2), 0] = ModuleProfileResult(compute_cost=0.063, peak_memory=1.577 GB, invar_size=0.709 GB, outvar_size=0.094 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(4, 7, 1, 1), 0] = ModuleProfileResult(compute_cost=0.126, peak_memory=1.456 GB, invar_size=0.517 GB, outvar_size=0.141 GB, temp_buffer_size=0.798 GB, available_memory=35.242 GB)
result[(4, 7, 1, 2), 0] = ModuleProfileResult(compute_cost=0.048, peak_memory=1.387 GB, invar_size=0.542 GB, outvar_size=0.070 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(3, 6, 1, 0), 1] = ModuleProfileResult(compute_cost=0.142, peak_memory=7.072 GB, invar_size=2.614 GB, outvar_size=1.272 GB, temp_buffer_size=4.434 GB, available_memory=35.242 GB)
result[(2, 6, 1, 0), 1] = ModuleProfileResult(compute_cost=0.176, peak_memory=7.710 GB, invar_size=3.253 GB, outvar_size=1.579 GB, temp_buffer_size=4.434 GB, available_memory=35.242 GB)
result[(2, 6, 1, 2), 1] = ModuleProfileResult(compute_cost=0.207, peak_memory=6.304 GB, invar_size=1.846 GB, outvar_size=0.876 GB, temp_buffer_size=4.434 GB, available_memory=35.242 GB)
result[(2, 6, 1, 1), 1] = ModuleProfileResult(compute_cost=0.452, peak_memory=7.575 GB, invar_size=1.837 GB, outvar_size=0.825 GB, temp_buffer_size=5.691 GB, available_memory=35.242 GB)
result[(3, 6, 1, 1), 1] = ModuleProfileResult(compute_cost=0.364, peak_memory=7.030 GB, invar_size=1.483 GB, outvar_size=0.671 GB, temp_buffer_size=5.500 GB, available_memory=35.242 GB)
result[(4, 7, 1, 0), 1] = ModuleProfileResult(compute_cost=0.159, peak_memory=8.484 GB, invar_size=2.682 GB, outvar_size=1.318 GB, temp_buffer_size=5.778 GB, available_memory=35.242 GB)
result[(3, 6, 1, 2), 1] = ModuleProfileResult(compute_cost=0.167, peak_memory=5.947 GB, invar_size=1.489 GB, outvar_size=0.709 GB, temp_buffer_size=4.434 GB, available_memory=35.242 GB)
result[(4, 7, 1, 1), 1] = ModuleProfileResult(compute_cost=0.389, peak_memory=7.474 GB, invar_size=1.482 GB, outvar_size=0.694 GB, temp_buffer_size=5.946 GB, available_memory=35.242 GB)
result[(4, 7, 1, 2), 1] = ModuleProfileResult(compute_cost=0.185, peak_memory=7.359 GB, invar_size=1.557 GB, outvar_size=0.755 GB, temp_buffer_size=5.778 GB, available_memory=35.242 GB)
Profiling for submesh 1 (1, 2) takes 70.79 seconds
--------------------------------------------------
- Profiling for submesh 0 (1, 1):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(1, 2, 0, 0), 0] = ModuleProfileResult(compute_cost=0.041, peak_memory=2.304 GB, invar_size=0.662 GB, outvar_size=0.094 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(0, 1, 0, 0), 0] = ModuleProfileResult(compute_cost=0.049, peak_memory=2.755 GB, invar_size=0.645 GB, outvar_size=0.094 GB, temp_buffer_size=2.016 GB, available_memory=35.242 GB)
result[(3, 4, 0, 0), 0] = ModuleProfileResult(compute_cost=0.046, peak_memory=2.322 GB, invar_size=0.680 GB, outvar_size=0.094 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(0, 1, 0, 1), 0] = ModuleProfileResult(compute_cost=0.049, peak_memory=2.755 GB, invar_size=0.645 GB, outvar_size=0.094 GB, temp_buffer_size=2.016 GB, available_memory=35.242 GB)
result[(1, 2, 0, 1), 0] = ModuleProfileResult(compute_cost=0.041, peak_memory=2.304 GB, invar_size=0.662 GB, outvar_size=0.094 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(2, 3, 0, 1), 0] = ModuleProfileResult(compute_cost=0.041, peak_memory=2.304 GB, invar_size=0.662 GB, outvar_size=0.094 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(2, 3, 0, 0), 0] = ModuleProfileResult(compute_cost=0.041, peak_memory=2.304 GB, invar_size=0.662 GB, outvar_size=0.094 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(0, 1, 0, 0), 1] = ModuleProfileResult(compute_cost=0.131, peak_memory=10.956 GB, invar_size=1.384 GB, outvar_size=0.645 GB, temp_buffer_size=9.572 GB, available_memory=35.242 GB)
result[(1, 2, 0, 0), 1] = ModuleProfileResult(compute_cost=0.120, peak_memory=9.917 GB, invar_size=1.371 GB, outvar_size=0.662 GB, temp_buffer_size=8.498 GB, available_memory=35.242 GB)
result[(0, 1, 0, 1), 1] = ModuleProfileResult(compute_cost=0.131, peak_memory=10.956 GB, invar_size=1.384 GB, outvar_size=0.645 GB, temp_buffer_size=9.572 GB, available_memory=35.242 GB)
result[(2, 3, 0, 0), 1] = ModuleProfileResult(compute_cost=0.120, peak_memory=9.917 GB, invar_size=1.371 GB, outvar_size=0.662 GB, temp_buffer_size=8.498 GB, available_memory=35.242 GB)
result[(2, 3, 0, 1), 1] = ModuleProfileResult(compute_cost=0.120, peak_memory=9.917 GB, invar_size=1.371 GB, outvar_size=0.662 GB, temp_buffer_size=8.498 GB, available_memory=35.242 GB)
result[(1, 2, 0, 1), 1] = ModuleProfileResult(compute_cost=0.120, peak_memory=9.917 GB, invar_size=1.371 GB, outvar_size=0.662 GB, temp_buffer_size=8.498 GB, available_memory=35.242 GB)
result[(4, 5, 0, 0), 0] = ModuleProfileResult(compute_cost=0.046, peak_memory=2.322 GB, invar_size=0.680 GB, outvar_size=0.094 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(3, 4, 0, 0), 1] = ModuleProfileResult(compute_cost=0.132, peak_memory=10.507 GB, invar_size=1.407 GB, outvar_size=0.680 GB, temp_buffer_size=9.054 GB, available_memory=35.242 GB)
result[(3, 4, 0, 1), 0] = ModuleProfileResult(compute_cost=0.046, peak_memory=2.322 GB, invar_size=0.680 GB, outvar_size=0.094 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(4, 5, 0, 1), 0] = ModuleProfileResult(compute_cost=0.046, peak_memory=2.322 GB, invar_size=0.680 GB, outvar_size=0.094 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(5, 6, 0, 0), 0] = ModuleProfileResult(compute_cost=0.041, peak_memory=2.304 GB, invar_size=0.662 GB, outvar_size=0.094 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(6, 7, 0, 0), 0] = ModuleProfileResult(compute_cost=0.021, peak_memory=1.949 GB, invar_size=0.355 GB, outvar_size=0.047 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(6, 7, 0, 1), 0] = ModuleProfileResult(compute_cost=0.021, peak_memory=1.949 GB, invar_size=0.355 GB, outvar_size=0.047 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(5, 6, 0, 1), 0] = ModuleProfileResult(compute_cost=0.041, peak_memory=2.304 GB, invar_size=0.662 GB, outvar_size=0.094 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(3, 4, 0, 1), 1] = ModuleProfileResult(compute_cost=0.132, peak_memory=10.507 GB, invar_size=1.407 GB, outvar_size=0.680 GB, temp_buffer_size=9.054 GB, available_memory=35.242 GB)
result[(4, 5, 0, 0), 1] = ModuleProfileResult(compute_cost=0.132, peak_memory=11.214 GB, invar_size=1.407 GB, outvar_size=0.680 GB, temp_buffer_size=9.761 GB, available_memory=35.242 GB)
result[(4, 5, 0, 1), 1] = ModuleProfileResult(compute_cost=0.132, peak_memory=11.214 GB, invar_size=1.407 GB, outvar_size=0.680 GB, temp_buffer_size=9.761 GB, available_memory=35.242 GB)
result[(5, 6, 0, 0), 1] = ModuleProfileResult(compute_cost=0.120, peak_memory=10.292 GB, invar_size=1.371 GB, outvar_size=0.662 GB, temp_buffer_size=8.874 GB, available_memory=35.242 GB)
result[(5, 6, 0, 1), 1] = ModuleProfileResult(compute_cost=0.120, peak_memory=10.292 GB, invar_size=1.371 GB, outvar_size=0.662 GB, temp_buffer_size=8.874 GB, available_memory=35.242 GB)
result[(6, 7, 0, 0), 1] = ModuleProfileResult(compute_cost=0.155, peak_memory=13.066 GB, invar_size=1.416 GB, outvar_size=0.708 GB, temp_buffer_size=11.603 GB, available_memory=35.242 GB)
result[(6, 7, 0, 1), 1] = ModuleProfileResult(compute_cost=0.155, peak_memory=13.066 GB, invar_size=1.416 GB, outvar_size=0.708 GB, temp_buffer_size=11.603 GB, available_memory=35.242 GB)
Profiling for submesh 0 (1, 1) takes 25.64 seconds
--------------------------------------------------
----------------------------------------------------------------------
Result forward_stage_layer_ids: [[0, 1, 2, 3], [4, 5, 6, 7]]
Result mesh_shapes: [(1, 2), (1, 2)]
Result logical_mesh_shapes: [(2, 1), (2, 1)]
Result autosharding_option_dicts: [{'force_batch_dim_to_mesh_dim': 0}, {'force_batch_dim_to_mesh_dim': 0}]
 - Compile (driver): 232.61 s
compilation time breakdown: {'stage-construction': '186.78', 'stage-construction-dp': '1.40', 'stage-construction-compilation': '86.47', 'stage-construction-profiling': '48.93'}
 - Compile (worker): 14.90 s
[I] Training process warmup (2 rounds) with dummy input batch...
    - Warmup iteration: 1/2
    - Warmup iteration: 2/2
[I] Ready to perform training process.
[I] Benchmark the training process with entire dataset and profile with driver overhead...
    - Iteration 1 / 5 is performed...
    - Iteration 2 / 5 is performed...
    - Iteration 3 / 5 is performed...
    - Iteration 4 / 5 is performed...
 - Benchmark: 75.69 s

[13.63497519493103, 9.544122219085693, 9.45762324333191, 9.661939859390259, 9.608484268188477, 9.471542596817017, 9.732895374298096]


[I] Performance metrics:
 - Iteration count: 5.
 - Total e2e training time : 49.046 s.
 - Average e2e iteration time: 9.809000015258789 s.
 - Total local training time: 47.932003021240234 s.
 - Average local iteration time: 9.586000442504883 s.
 - Max allocated memory among devices: 11.19 GB.
 - Compilation times:  {'stage-construction': 186.77583742141724, 'stage-construction-dp': 1.399956464767456, 'stage-construction-compilation': 86.47271466255188, 'stage-construction-profiling': 48.92655611038208}
 - Metadata:  []
 - Is need save result:  True

[TMP] Current profiling results of key `2_a40_2_n_2_d`: 9.58649730682373
[TMP] Updated profiling results stored in `./jaxpr/prof_log/optimal/moe_1.3B_512.pkl`...

------------------------------------------------------------------
- (3/3) Profiling moe_1.3B with batch size: 1024...
------------------------------------------------------------------
[TMP] Existed profiling results in `./jaxpr/prof_log/optimal/moe_1.3B_1024.pkl`, updating/rewriting it...
[I] Ray Cluster & Alpa backend initialization is completed.
[I] Device Info:
    - Devices num per node: 2
    - Nodes num: 2
[I] Loading flax model....
[I] Model 'moe' loads sucessfully. Model Info: 

FlaxMoEForLMModule(
    # attributes
    config = <model.moe_model.MoEConfig object at 0x7fe532968eb0>
    dtype = float16
    bias_init = zeros
) 

[I] Manually constructing dummy batch...
[I] Initialize training state...
[I] Training state initialization is completed.
[I] Constructing Alpa parallelized train step func...
[I] Alpa parallelized train step func construction is completed.
-------------------- Automatic stage clustering --------------------
submesh_choices: ((1, 1), (1, 2), (2, 2))
- Profiling for submesh 2 (2, 2):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(0, 7, 2, 1), 0] = ModuleProfileResult(compute_cost=0.120, peak_memory=2.403 GB, invar_size=1.184 GB, outvar_size=0.164 GB, temp_buffer_size=1.055 GB, available_memory=35.242 GB)
result[(0, 7, 2, 0), 0] = ModuleProfileResult(compute_cost=0.080, peak_memory=3.373 GB, invar_size=2.201 GB, outvar_size=0.164 GB, temp_buffer_size=1.008 GB, available_memory=35.242 GB)
result[(0, 7, 2, 2), 0] = ModuleProfileResult(compute_cost=0.189, peak_memory=1.897 GB, invar_size=0.725 GB, outvar_size=0.164 GB, temp_buffer_size=1.008 GB, available_memory=35.242 GB)
result[(0, 7, 2, 0), 1] = ModuleProfileResult(compute_cost=0.406, peak_memory=11.075 GB, invar_size=5.273 GB, outvar_size=2.554 GB, temp_buffer_size=5.801 GB, available_memory=35.242 GB)
result[(0, 7, 2, 1), 1] = ModuleProfileResult(compute_cost=0.482, peak_memory=8.738 GB, invar_size=2.913 GB, outvar_size=1.374 GB, temp_buffer_size=5.825 GB, available_memory=35.242 GB)
result[(0, 7, 2, 2), 1] = ModuleProfileResult(compute_cost=0.541, peak_memory=7.700 GB, invar_size=1.898 GB, outvar_size=0.867 GB, temp_buffer_size=5.801 GB, available_memory=35.242 GB)
Profiling for submesh 2 (2, 2) takes 84.35 seconds
--------------------------------------------------
- Profiling for submesh 1 (1, 2):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(1, 4, 1, 2), 0] = ModuleProfileResult(compute_cost=0.122, peak_memory=2.468 GB, invar_size=0.733 GB, outvar_size=0.188 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(0, 3, 1, 2), 0] = ModuleProfileResult(compute_cost=0.125, peak_memory=2.901 GB, invar_size=0.698 GB, outvar_size=0.188 GB, temp_buffer_size=2.016 GB, available_memory=35.242 GB)
result[(1, 4, 1, 0), 0] = ModuleProfileResult(compute_cost=0.087, peak_memory=3.031 GB, invar_size=1.295 GB, outvar_size=0.188 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(0, 3, 1, 0), 0] = ModuleProfileResult(compute_cost=0.090, peak_memory=3.464 GB, invar_size=1.261 GB, outvar_size=0.188 GB, temp_buffer_size=2.016 GB, available_memory=35.242 GB)
result[(0, 3, 1, 1), 0] = ModuleProfileResult(compute_cost=0.299, peak_memory=2.912 GB, invar_size=0.631 GB, outvar_size=0.328 GB, temp_buffer_size=1.953 GB, available_memory=35.242 GB)
result[(1, 4, 1, 1), 0] = ModuleProfileResult(compute_cost=0.324, peak_memory=2.689 GB, invar_size=0.718 GB, outvar_size=0.375 GB, temp_buffer_size=1.596 GB, available_memory=35.242 GB)
result[(1, 5, 1, 0), 0] = ModuleProfileResult(compute_cost=0.107, peak_memory=3.385 GB, invar_size=1.603 GB, outvar_size=0.234 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(1, 5, 1, 1), 0] = ModuleProfileResult(compute_cost=0.401, peak_memory=2.937 GB, invar_size=0.872 GB, outvar_size=0.469 GB, temp_buffer_size=1.596 GB, available_memory=35.242 GB)
result[(0, 3, 1, 1), 1] = ModuleProfileResult(compute_cost=0.689, peak_memory=12.212 GB, invar_size=1.636 GB, outvar_size=0.630 GB, temp_buffer_size=10.576 GB, available_memory=35.242 GB)
result[(1, 4, 1, 2), 1] = ModuleProfileResult(compute_cost=0.324, peak_memory=10.568 GB, invar_size=1.653 GB, outvar_size=0.733 GB, temp_buffer_size=8.868 GB, available_memory=35.242 GB)
result[(0, 3, 1, 0), 1] = ModuleProfileResult(compute_cost=0.263, peak_memory=11.765 GB, invar_size=2.709 GB, outvar_size=1.260 GB, temp_buffer_size=9.056 GB, available_memory=35.242 GB)
result[(2, 5, 1, 0), 0] = ModuleProfileResult(compute_cost=0.087, peak_memory=3.031 GB, invar_size=1.295 GB, outvar_size=0.188 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(0, 3, 1, 2), 1] = ModuleProfileResult(compute_cost=0.323, peak_memory=10.640 GB, invar_size=1.584 GB, outvar_size=0.698 GB, temp_buffer_size=9.056 GB, available_memory=35.242 GB)
result[(1, 4, 1, 1), 1] = ModuleProfileResult(compute_cost=0.718, peak_memory=12.900 GB, invar_size=1.717 GB, outvar_size=0.718 GB, temp_buffer_size=11.089 GB, available_memory=35.242 GB)
result[(1, 4, 1, 0), 1] = ModuleProfileResult(compute_cost=0.264, peak_memory=11.599 GB, invar_size=2.731 GB, outvar_size=1.295 GB, temp_buffer_size=8.821 GB, available_memory=35.242 GB)
result[(2, 5, 1, 1), 0] = ModuleProfileResult(compute_cost=0.324, peak_memory=2.689 GB, invar_size=0.718 GB, outvar_size=0.375 GB, temp_buffer_size=1.596 GB, available_memory=35.242 GB)
result[(1, 5, 1, 2), 0] = ModuleProfileResult(compute_cost=0.152, peak_memory=2.682 GB, invar_size=0.900 GB, outvar_size=0.234 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(2, 5, 1, 2), 0] = ModuleProfileResult(compute_cost=0.122, peak_memory=2.468 GB, invar_size=0.733 GB, outvar_size=0.188 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(1, 5, 1, 0), 1] = ModuleProfileResult(compute_cost=0.327, peak_memory=12.309 GB, invar_size=3.393 GB, outvar_size=1.603 GB, temp_buffer_size=8.868 GB, available_memory=35.242 GB)
result[(2, 5, 1, 0), 1] = ModuleProfileResult(compute_cost=0.264, peak_memory=11.646 GB, invar_size=2.731 GB, outvar_size=1.295 GB, temp_buffer_size=8.868 GB, available_memory=35.242 GB)
result[(2, 6, 1, 0), 0] = ModuleProfileResult(compute_cost=0.107, peak_memory=3.385 GB, invar_size=1.603 GB, outvar_size=0.234 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(3, 6, 1, 0), 0] = ModuleProfileResult(compute_cost=0.087, peak_memory=3.031 GB, invar_size=1.295 GB, outvar_size=0.188 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(2, 6, 1, 1), 0] = ModuleProfileResult(compute_cost=0.401, peak_memory=2.937 GB, invar_size=0.872 GB, outvar_size=0.469 GB, temp_buffer_size=1.596 GB, available_memory=35.242 GB)
result[(2, 6, 1, 2), 0] = ModuleProfileResult(compute_cost=0.152, peak_memory=2.682 GB, invar_size=0.900 GB, outvar_size=0.234 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(2, 5, 1, 1), 1] = ModuleProfileResult(compute_cost=0.718, peak_memory=12.619 GB, invar_size=1.717 GB, outvar_size=0.718 GB, temp_buffer_size=10.808 GB, available_memory=35.242 GB)
result[(1, 5, 1, 1), 1] = ModuleProfileResult(compute_cost=0.891, peak_memory=13.495 GB, invar_size=2.119 GB, outvar_size=0.872 GB, temp_buffer_size=11.283 GB, available_memory=35.242 GB)
result[(1, 5, 1, 2), 1] = ModuleProfileResult(compute_cost=0.402, peak_memory=10.902 GB, invar_size=1.987 GB, outvar_size=0.900 GB, temp_buffer_size=8.868 GB, available_memory=35.242 GB)
result[(3, 6, 1, 1), 0] = ModuleProfileResult(compute_cost=0.324, peak_memory=2.689 GB, invar_size=0.718 GB, outvar_size=0.375 GB, temp_buffer_size=1.596 GB, available_memory=35.242 GB)
result[(2, 5, 1, 2), 1] = ModuleProfileResult(compute_cost=0.324, peak_memory=10.521 GB, invar_size=1.606 GB, outvar_size=0.733 GB, temp_buffer_size=8.868 GB, available_memory=35.242 GB)
result[(4, 7, 1, 0), 0] = ModuleProfileResult(compute_cost=0.066, peak_memory=2.676 GB, invar_size=0.988 GB, outvar_size=0.141 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(3, 6, 1, 2), 0] = ModuleProfileResult(compute_cost=0.122, peak_memory=2.468 GB, invar_size=0.733 GB, outvar_size=0.188 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(3, 6, 1, 0), 1] = ModuleProfileResult(compute_cost=0.264, peak_memory=11.646 GB, invar_size=2.731 GB, outvar_size=1.295 GB, temp_buffer_size=8.868 GB, available_memory=35.242 GB)
result[(4, 7, 1, 1), 0] = ModuleProfileResult(compute_cost=0.248, peak_memory=2.441 GB, invar_size=0.564 GB, outvar_size=0.281 GB, temp_buffer_size=1.596 GB, available_memory=35.242 GB)
result[(4, 7, 1, 2), 0] = ModuleProfileResult(compute_cost=0.093, peak_memory=2.254 GB, invar_size=0.566 GB, outvar_size=0.141 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(2, 6, 1, 0), 1] = ModuleProfileResult(compute_cost=0.327, peak_memory=12.309 GB, invar_size=3.393 GB, outvar_size=1.603 GB, temp_buffer_size=8.868 GB, available_memory=35.242 GB)
result[(2, 6, 1, 1), 1] = ModuleProfileResult(compute_cost=0.891, peak_memory=13.589 GB, invar_size=2.119 GB, outvar_size=0.872 GB, temp_buffer_size=11.376 GB, available_memory=35.242 GB)
result[(2, 6, 1, 2), 1] = ModuleProfileResult(compute_cost=0.402, peak_memory=10.902 GB, invar_size=1.987 GB, outvar_size=0.900 GB, temp_buffer_size=8.868 GB, available_memory=35.242 GB)
result[(3, 6, 1, 1), 1] = ModuleProfileResult(compute_cost=0.718, peak_memory=12.807 GB, invar_size=1.717 GB, outvar_size=0.718 GB, temp_buffer_size=10.996 GB, available_memory=35.242 GB)
result[(3, 6, 1, 2), 1] = ModuleProfileResult(compute_cost=0.324, peak_memory=10.521 GB, invar_size=1.606 GB, outvar_size=0.733 GB, temp_buffer_size=8.868 GB, available_memory=35.242 GB)
result[(4, 7, 1, 0), 1] = ModuleProfileResult(compute_cost=0.299, peak_memory=14.379 GB, invar_size=2.776 GB, outvar_size=1.341 GB, temp_buffer_size=11.556 GB, available_memory=35.242 GB)
result[(4, 7, 1, 1), 1] = ModuleProfileResult(compute_cost=0.767, peak_memory=13.653 GB, invar_size=1.670 GB, outvar_size=0.741 GB, temp_buffer_size=11.890 GB, available_memory=35.242 GB)
result[(4, 7, 1, 2), 1] = ModuleProfileResult(compute_cost=0.359, peak_memory=13.254 GB, invar_size=1.651 GB, outvar_size=0.779 GB, temp_buffer_size=11.556 GB, available_memory=35.242 GB)
Profiling for submesh 1 (1, 2) takes 73.00 seconds
--------------------------------------------------
- Profiling for submesh 0 (1, 1):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(1, 2, 0, 0), 0] = ModuleProfileResult(compute_cost=0.081, peak_memory=3.993 GB, invar_size=0.709 GB, outvar_size=0.188 GB, temp_buffer_size=3.096 GB, available_memory=35.242 GB)
result[(0, 1, 0, 1), 0] = ModuleProfileResult(compute_cost=0.096, peak_memory=4.864 GB, invar_size=0.646 GB, outvar_size=0.188 GB, temp_buffer_size=4.031 GB, available_memory=35.242 GB)
result[(0, 1, 0, 0), 0] = ModuleProfileResult(compute_cost=0.096, peak_memory=4.864 GB, invar_size=0.646 GB, outvar_size=0.188 GB, temp_buffer_size=4.031 GB, available_memory=35.242 GB)
result[(1, 2, 0, 1), 0] = ModuleProfileResult(compute_cost=0.081, peak_memory=3.993 GB, invar_size=0.709 GB, outvar_size=0.188 GB, temp_buffer_size=3.096 GB, available_memory=35.242 GB)
result[(2, 3, 0, 1), 0] = ModuleProfileResult(compute_cost=0.081, peak_memory=3.993 GB, invar_size=0.709 GB, outvar_size=0.188 GB, temp_buffer_size=3.096 GB, available_memory=35.242 GB)
result[(2, 3, 0, 0), 0] = ModuleProfileResult(compute_cost=0.081, peak_memory=3.993 GB, invar_size=0.709 GB, outvar_size=0.188 GB, temp_buffer_size=3.096 GB, available_memory=35.242 GB)
result[(3, 4, 0, 0), 0] = ModuleProfileResult(compute_cost=0.089, peak_memory=4.010 GB, invar_size=0.727 GB, outvar_size=0.188 GB, temp_buffer_size=3.096 GB, available_memory=35.242 GB)
result[(1, 2, 0, 0), 1] = ModuleProfileResult(compute_cost=0.236, peak_memory=18.600 GB, invar_size=1.512 GB, outvar_size=0.709 GB, temp_buffer_size=16.994 GB, available_memory=35.242 GB)
result[(0, 1, 0, 1), 1] = ModuleProfileResult(compute_cost=0.257, peak_memory=20.622 GB, invar_size=1.478 GB, outvar_size=0.645 GB, temp_buffer_size=19.143 GB, available_memory=35.242 GB)
result[(2, 3, 0, 1), 1] = ModuleProfileResult(compute_cost=0.236, peak_memory=18.600 GB, invar_size=1.512 GB, outvar_size=0.709 GB, temp_buffer_size=16.994 GB, available_memory=35.242 GB)
result[(0, 1, 0, 0), 1] = ModuleProfileResult(compute_cost=0.257, peak_memory=20.622 GB, invar_size=1.478 GB, outvar_size=0.645 GB, temp_buffer_size=19.143 GB, available_memory=35.242 GB)
result[(3, 4, 0, 0), 1] = ModuleProfileResult(compute_cost=0.258, peak_memory=19.748 GB, invar_size=1.547 GB, outvar_size=0.727 GB, temp_buffer_size=18.107 GB, available_memory=35.242 GB)
result[(2, 3, 0, 0), 1] = ModuleProfileResult(compute_cost=0.236, peak_memory=18.600 GB, invar_size=1.512 GB, outvar_size=0.709 GB, temp_buffer_size=16.994 GB, available_memory=35.242 GB)
result[(1, 2, 0, 1), 1] = ModuleProfileResult(compute_cost=0.236, peak_memory=18.600 GB, invar_size=1.512 GB, outvar_size=0.709 GB, temp_buffer_size=16.994 GB, available_memory=35.242 GB)
result[(3, 4, 0, 1), 0] = ModuleProfileResult(compute_cost=0.089, peak_memory=4.010 GB, invar_size=0.727 GB, outvar_size=0.188 GB, temp_buffer_size=3.096 GB, available_memory=35.242 GB)
result[(4, 5, 0, 0), 0] = ModuleProfileResult(compute_cost=0.089, peak_memory=4.010 GB, invar_size=0.727 GB, outvar_size=0.188 GB, temp_buffer_size=3.096 GB, available_memory=35.242 GB)
result[(4, 5, 0, 1), 0] = ModuleProfileResult(compute_cost=0.089, peak_memory=4.010 GB, invar_size=0.727 GB, outvar_size=0.188 GB, temp_buffer_size=3.096 GB, available_memory=35.242 GB)
result[(5, 6, 0, 0), 0] = ModuleProfileResult(compute_cost=0.081, peak_memory=3.993 GB, invar_size=0.709 GB, outvar_size=0.188 GB, temp_buffer_size=3.096 GB, available_memory=35.242 GB)
result[(6, 7, 0, 0), 0] = ModuleProfileResult(compute_cost=0.040, peak_memory=3.591 GB, invar_size=0.402 GB, outvar_size=0.094 GB, temp_buffer_size=3.096 GB, available_memory=35.242 GB)
result[(6, 7, 0, 1), 0] = ModuleProfileResult(compute_cost=0.040, peak_memory=3.591 GB, invar_size=0.402 GB, outvar_size=0.094 GB, temp_buffer_size=3.096 GB, available_memory=35.242 GB)
result[(5, 6, 0, 1), 0] = ModuleProfileResult(compute_cost=0.081, peak_memory=3.993 GB, invar_size=0.709 GB, outvar_size=0.188 GB, temp_buffer_size=3.096 GB, available_memory=35.242 GB)
result[(3, 4, 0, 1), 1] = ModuleProfileResult(compute_cost=0.258, peak_memory=19.748 GB, invar_size=1.547 GB, outvar_size=0.727 GB, temp_buffer_size=18.107 GB, available_memory=35.242 GB)
result[(4, 5, 0, 1), 1] = ModuleProfileResult(compute_cost=0.258, peak_memory=21.162 GB, invar_size=1.547 GB, outvar_size=0.727 GB, temp_buffer_size=19.521 GB, available_memory=35.242 GB)
result[(4, 5, 0, 0), 1] = ModuleProfileResult(compute_cost=0.258, peak_memory=21.162 GB, invar_size=1.547 GB, outvar_size=0.727 GB, temp_buffer_size=19.521 GB, available_memory=35.242 GB)
result[(5, 6, 0, 0), 1] = ModuleProfileResult(compute_cost=0.236, peak_memory=19.350 GB, invar_size=1.512 GB, outvar_size=0.709 GB, temp_buffer_size=17.744 GB, available_memory=35.242 GB)
result[(5, 6, 0, 1), 1] = ModuleProfileResult(compute_cost=0.236, peak_memory=19.350 GB, invar_size=1.512 GB, outvar_size=0.709 GB, temp_buffer_size=17.744 GB, available_memory=35.242 GB)
result[(6, 7, 0, 0), 1] = ModuleProfileResult(compute_cost=0.305, peak_memory=24.810 GB, invar_size=1.510 GB, outvar_size=0.755 GB, temp_buffer_size=23.206 GB, available_memory=35.242 GB)
result[(6, 7, 0, 1), 1] = ModuleProfileResult(compute_cost=0.305, peak_memory=24.810 GB, invar_size=1.510 GB, outvar_size=0.755 GB, temp_buffer_size=23.206 GB, available_memory=35.242 GB)
Profiling for submesh 0 (1, 1) takes 24.98 seconds
--------------------------------------------------
----------------------------------------------------------------------
Result forward_stage_layer_ids: [[0, 1, 2, 3], [4, 5, 6, 7]]
Result mesh_shapes: [(1, 2), (1, 2)]
Result logical_mesh_shapes: [(2, 1), (2, 1)]
Result autosharding_option_dicts: [{'force_batch_dim_to_mesh_dim': 0}, {'force_batch_dim_to_mesh_dim': 0}]
 - Compile (driver): 232.23 s
compilation time breakdown: {'stage-construction': '186.36', 'stage-construction-dp': '1.40', 'stage-construction-compilation': '86.45', 'stage-construction-profiling': '47.35'}
 - Compile (worker): 15.31 s
[I] Training process warmup (2 rounds) with dummy input batch...
    - Warmup iteration: 1/2
    - Warmup iteration: 2/2
[I] Ready to perform training process.
[I] Benchmark the training process with entire dataset and profile with driver overhead...
    - Iteration 1 / 5 is performed...
    - Iteration 2 / 5 is performed...
    - Iteration 3 / 5 is performed...
    - Iteration 4 / 5 is performed...
 - Benchmark: 138.99 s

[23.43135929107666, 18.6396541595459, 18.49036931991577, 18.545677423477173, 18.564230918884277, 18.679033994674683, 18.492146492004395]


[I] Performance metrics:
 - Iteration count: 5.
 - Total e2e training time : 93.916 s.
 - Average e2e iteration time: 18.783000946044922 s.
 - Total local training time: 92.77100372314453 s.
 - Average local iteration time: 18.554000854492188 s.
 - Max allocated memory among devices: 18.493 GB.
 - Compilation times:  {'stage-construction': 186.35696005821228, 'stage-construction-dp': 1.4014034271240234, 'stage-construction-compilation': 86.45171666145325, 'stage-construction-profiling': 47.353336572647095}
 - Metadata:  []
 - Is need save result:  True

[TMP] Current profiling results of key `2_a40_2_n_2_d`: 18.554290771484375
[TMP] Updated profiling results stored in `./jaxpr/prof_log/optimal/moe_1.3B_1024.pkl`...
