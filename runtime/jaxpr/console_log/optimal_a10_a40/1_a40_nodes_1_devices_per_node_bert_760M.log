
------------------------------------------------------------------
- (1/3) Profiling bert_760M with batch size: 128...
------------------------------------------------------------------
[TMP] Existed profiling results in `./jaxpr/prof_log/optimal/bert_760M_128.pkl`, updating/rewriting it...
[I] Ray Cluster & Alpa backend initialization is completed.
[I] Device Info:
    - Devices num per node: 1
    - Nodes num: 1
[I] Loading flax model....
[I] Model 'bert' loads sucessfully. Model Info: 

FlaxBertForMaskedLMModule(
    # attributes
    config = <model.bert_model.BertConfig object at 0x7fef1d2b0d60>
    dtype = float16
) 

[I] Manually constructing dummy batch...
[I] Initialize training state...
[I] Training state initialization is completed.
[I] Constructing Alpa parallelized train step func...
[I] Alpa parallelized train step func construction is completed.
-------------------- Automatic stage clustering --------------------
submesh_choices: ((1, 1),)
- Profiling for submesh 0 (1, 1):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(0, 5, 0, 0), 0] = ModuleProfileResult(compute_cost=0.134, peak_memory=2.120 GB, invar_size=1.221 GB, outvar_size=0.117 GB, temp_buffer_size=0.781 GB, available_memory=35.242 GB)
result[(0, 5, 0, 1), 0] = ModuleProfileResult(compute_cost=0.134, peak_memory=2.120 GB, invar_size=1.221 GB, outvar_size=0.117 GB, temp_buffer_size=0.781 GB, available_memory=35.242 GB)
result[(0, 5, 0, 0), 1] = ModuleProfileResult(compute_cost=0.490, peak_memory=8.954 GB, invar_size=3.248 GB, outvar_size=1.565 GB, temp_buffer_size=5.706 GB, available_memory=35.242 GB)
result[(0, 5, 0, 1), 1] = ModuleProfileResult(compute_cost=0.490, peak_memory=8.954 GB, invar_size=3.248 GB, outvar_size=1.565 GB, temp_buffer_size=5.706 GB, available_memory=35.242 GB)
Profiling for submesh 0 (1, 1) takes 26.63 seconds
--------------------------------------------------
Profile result saved to: profile-results-2023-11-17-13-26-27.npy
----------------------------------------------------------------------
Result forward_stage_layer_ids: [[0, 1, 2, 3, 4, 5]]
Result mesh_shapes: [(1, 1)]
Result logical_mesh_shapes: [(1, 1)]
Result autosharding_option_dicts: [{}]
 - Compile (driver): 60.99 s
compilation time breakdown: {'stage-construction': '29.74', 'stage-construction-dp': '1.06', 'stage-construction-compilation': '3.71', 'stage-construction-profiling': '16.02'}
 - Compile (worker): 17.98 s
[I] Training process warmup (2 rounds) with dummy input batch...
    - Warmup iteration: 1/2
    - Warmup iteration: 2/2
[I] Ready to perform training process.
[I] Benchmark the training process with entire dataset and profile with driver overhead...
    - Iteration 1 / 5 is performed...
    - Iteration 2 / 5 is performed...
    - Iteration 3 / 5 is performed...
    - Iteration 4 / 5 is performed...
 - Benchmark: 102.12 s

[14.920986652374268, 13.480386972427368, 13.509425401687622, 13.503109216690063, 13.530541181564331, 13.500821590423584, 13.499818563461304]


[I] Performance metrics:
 - Iteration count: 5.
 - Total e2e training time : 69.973 s.
 - Average e2e iteration time: 13.995000839233398 s.
 - Total local training time: 67.54400634765625 s.
 - Average local iteration time: 13.509000778198242 s.
 - Max allocated memory among devices: 20.106 GB.
 - Compilation times:  {'stage-construction': 29.737964630126953, 'stage-construction-dp': 1.0645325183868408, 'stage-construction-compilation': 3.7118079662323, 'stage-construction-profiling': 16.021708965301514}
 - Metadata:  []
 - Is need save result:  True

[TMP] Current profiling results of key `1_a40_1_n_1_d`: 13.508743286132812
[TMP] Updated profiling results stored in `./jaxpr/prof_log/optimal/bert_760M_128.pkl`...

------------------------------------------------------------------
- (2/3) Profiling bert_760M with batch size: 256...
------------------------------------------------------------------
[TMP] Existed profiling results in `./jaxpr/prof_log/optimal/bert_760M_256.pkl`, updating/rewriting it...
[I] Ray Cluster & Alpa backend initialization is completed.
[I] Device Info:
    - Devices num per node: 1
    - Nodes num: 1
[I] Loading flax model....
[I] Model 'bert' loads sucessfully. Model Info: 

FlaxBertForMaskedLMModule(
    # attributes
    config = <model.bert_model.BertConfig object at 0x7fc44aa35cd0>
    dtype = float16
) 

[I] Manually constructing dummy batch...
[I] Initialize training state...
[I] Training state initialization is completed.
[I] Constructing Alpa parallelized train step func...
[I] Alpa parallelized train step func construction is completed.
-------------------- Automatic stage clustering --------------------
submesh_choices: ((1, 1),)
- Profiling for submesh 0 (1, 1):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(0, 5, 0, 0), 0] = ModuleProfileResult(compute_cost=0.262, peak_memory=3.018 GB, invar_size=1.221 GB, outvar_size=0.234 GB, temp_buffer_size=1.563 GB, available_memory=35.242 GB)
result[(0, 5, 0, 1), 0] = ModuleProfileResult(compute_cost=0.262, peak_memory=3.018 GB, invar_size=1.221 GB, outvar_size=0.234 GB, temp_buffer_size=1.563 GB, available_memory=35.242 GB)
result[(0, 5, 0, 0), 1] = ModuleProfileResult(compute_cost=0.963, peak_memory=14.768 GB, invar_size=3.366 GB, outvar_size=1.565 GB, temp_buffer_size=11.403 GB, available_memory=35.242 GB)
result[(0, 5, 0, 1), 1] = ModuleProfileResult(compute_cost=0.963, peak_memory=14.768 GB, invar_size=3.366 GB, outvar_size=1.565 GB, temp_buffer_size=11.403 GB, available_memory=35.242 GB)
Profiling for submesh 0 (1, 1) takes 25.94 seconds
--------------------------------------------------
Profile result saved to: profile-results-2023-11-17-13-29-37.npy
----------------------------------------------------------------------
Result forward_stage_layer_ids: [[0, 1, 2, 3, 4, 5]]
Result mesh_shapes: [(1, 1)]
Result logical_mesh_shapes: [(1, 1)]
Result autosharding_option_dicts: [{}]
 - Compile (driver): 59.23 s
compilation time breakdown: {'stage-construction': '29.31', 'stage-construction-dp': '1.31', 'stage-construction-compilation': '3.65', 'stage-construction-profiling': '15.46'}
 - Compile (worker): 17.94 s
[I] Training process warmup (2 rounds) with dummy input batch...
    - Warmup iteration: 1/2
    - Warmup iteration: 2/2
[I] Ready to perform training process.
[I] Benchmark the training process with entire dataset and profile with driver overhead...
    - Iteration 1 / 5 is performed...
    - Iteration 2 / 5 is performed...
    - Iteration 3 / 5 is performed...
    - Iteration 4 / 5 is performed...
 - Benchmark: 198.39 s

[28.549187660217285, 26.878494262695312, 26.86980652809143, 26.874511003494263, 26.837810277938843, 26.862598180770874, 26.85487389564514]


[I] Performance metrics:
 - Iteration count: 5.
 - Total e2e training time : 138.712 s.
 - Average e2e iteration time: 27.742000579833984 s.
 - Total local training time: 134.3000030517578 s.
 - Average local iteration time: 26.860000610351562 s.
 - Max allocated memory among devices: 27.68 GB.
 - Compilation times:  {'stage-construction': 29.31007719039917, 'stage-construction-dp': 1.3131084442138672, 'stage-construction-compilation': 3.6458871364593506, 'stage-construction-profiling': 15.458236694335938}
 - Metadata:  []
 - Is need save result:  True

[TMP] Current profiling results of key `1_a40_1_n_1_d`: 26.85991859436035
[TMP] Updated profiling results stored in `./jaxpr/prof_log/optimal/bert_760M_256.pkl`...

------------------------------------------------------------------
- (3/3) Profiling bert_760M with batch size: 512...
------------------------------------------------------------------
[TMP] Existed profiling results in `./jaxpr/prof_log/optimal/bert_760M_512.pkl`, updating/rewriting it...
[I] Ray Cluster & Alpa backend initialization is completed.
[I] Device Info:
    - Devices num per node: 1
    - Nodes num: 1
[I] Loading flax model....
[I] Model 'bert' loads sucessfully. Model Info: 

FlaxBertForMaskedLMModule(
    # attributes
    config = <model.bert_model.BertConfig object at 0x7f6873165d00>
    dtype = float16
) 

[I] Manually constructing dummy batch...
[I] Initialize training state...
[I] Training state initialization is completed.
[I] Constructing Alpa parallelized train step func...
[I] Alpa parallelized train step func construction is completed.
-------------------- Automatic stage clustering --------------------
submesh_choices: ((1, 1),)
- Profiling for submesh 0 (1, 1):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(0, 5, 0, 0), 0] = ModuleProfileResult(compute_cost=0.507, peak_memory=4.815 GB, invar_size=1.221 GB, outvar_size=0.469 GB, temp_buffer_size=3.125 GB, available_memory=35.242 GB)
result[(0, 5, 0, 1), 0] = ModuleProfileResult(compute_cost=0.507, peak_memory=4.815 GB, invar_size=1.221 GB, outvar_size=0.469 GB, temp_buffer_size=3.125 GB, available_memory=35.242 GB)
result[(0, 5, 0, 0), 1] = ModuleProfileResult(compute_cost=1.863, peak_memory=26.393 GB, invar_size=3.600 GB, outvar_size=1.565 GB, temp_buffer_size=22.793 GB, available_memory=35.242 GB)
result[(0, 5, 0, 1), 1] = ModuleProfileResult(compute_cost=1.863, peak_memory=26.393 GB, invar_size=3.600 GB, outvar_size=1.565 GB, temp_buffer_size=22.793 GB, available_memory=35.242 GB)
Profiling for submesh 0 (1, 1) takes 25.97 seconds
--------------------------------------------------
Profile result saved to: profile-results-2023-11-17-13-34-23.npy
----------------------------------------------------------------------
Result forward_stage_layer_ids: [[0, 1, 2, 3, 4, 5]]
Result mesh_shapes: [(1, 1)]
Result logical_mesh_shapes: [(1, 1)]
Result autosharding_option_dicts: [{'force_batch_dim_to_mesh_dim': 0}]
 - Compile (driver): 60.54 s
compilation time breakdown: {'stage-construction': '29.43', 'stage-construction-dp': '1.24', 'stage-construction-compilation': '3.60', 'stage-construction-profiling': '15.69'}
 - Compile (worker): 17.33 s
[I] Training process warmup (2 rounds) with dummy input batch...
    - Warmup iteration: 1/2
[E] Meet unexpected error in profiling executables...

[E] Unexpected error occurred in compiling or profiling executables...
[E] Meet unexpected error in compiling and executing model...
[TMP] Current profiling results of key `1_a40_1_n_1_d`: none
[TMP] Updated profiling results stored in `./jaxpr/prof_log/optimal/bert_760M_512.pkl`...
