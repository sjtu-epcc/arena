
------------------------------------------------------------------
- (1/3) Profiling moe_690M with batch size: 256...
------------------------------------------------------------------
[TMP] Existed profiling results in `./jaxpr/prof_log/optimal/moe_690M_256.pkl`, updating/rewriting it...
[I] Ray Cluster & Alpa backend initialization is completed.
[I] Device Info:
    - Devices num per node: 2
    - Nodes num: 2
[I] Loading flax model....
[I] Model 'moe' loads sucessfully. Model Info: 

FlaxMoEForLMModule(
    # attributes
    config = <model.moe_model.MoEConfig object at 0x7f6ec2b11fd0>
    dtype = float16
    bias_init = zeros
) 

[I] Manually constructing dummy batch...
[I] Initialize training state...
[I] Training state initialization is completed.
[I] Constructing Alpa parallelized train step func...
[I] Alpa parallelized train step func construction is completed.
-------------------- Automatic stage clustering --------------------
submesh_choices: ((1, 1), (1, 2), (2, 2))
- Profiling for submesh 2 (2, 2):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(0, 7, 2, 1), 0] = ModuleProfileResult(compute_cost=0.025, peak_memory=0.944 GB, invar_size=0.628 GB, outvar_size=0.041 GB, temp_buffer_size=0.275 GB, available_memory=35.242 GB)
result[(0, 7, 2, 0), 0] = ModuleProfileResult(compute_cost=0.013, peak_memory=1.549 GB, invar_size=1.256 GB, outvar_size=0.041 GB, temp_buffer_size=0.252 GB, available_memory=35.242 GB)
result[(0, 7, 2, 0), 1] = ModuleProfileResult(compute_cost=0.111, peak_memory=4.012 GB, invar_size=2.689 GB, outvar_size=1.324 GB, temp_buffer_size=1.324 GB, available_memory=35.242 GB)
result[(0, 7, 2, 2), 0] = ModuleProfileResult(compute_cost=0.035, peak_memory=0.705 GB, invar_size=0.412 GB, outvar_size=0.041 GB, temp_buffer_size=0.252 GB, available_memory=35.242 GB)
result[(0, 7, 2, 1), 1] = ModuleProfileResult(compute_cost=0.156, peak_memory=2.283 GB, invar_size=1.365 GB, outvar_size=0.662 GB, temp_buffer_size=0.918 GB, available_memory=35.242 GB)
result[(0, 7, 2, 2), 1] = ModuleProfileResult(compute_cost=0.097, peak_memory=1.881 GB, invar_size=1.001 GB, outvar_size=0.480 GB, temp_buffer_size=0.879 GB, available_memory=35.242 GB)
Profiling for submesh 2 (2, 2) takes 46.31 seconds
--------------------------------------------------
- Profiling for submesh 1 (1, 2):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(1, 3, 1, 0), 0] = ModuleProfileResult(compute_cost=0.012, peak_memory=1.038 GB, invar_size=0.627 GB, outvar_size=0.035 GB, temp_buffer_size=0.375 GB, available_memory=35.242 GB)
result[(1, 3, 1, 1), 0] = ModuleProfileResult(compute_cost=0.038, peak_memory=0.765 GB, invar_size=0.331 GB, outvar_size=0.059 GB, temp_buffer_size=0.376 GB, available_memory=35.242 GB)
result[(0, 3, 1, 2), 0] = ModuleProfileResult(compute_cost=0.020, peak_memory=0.937 GB, invar_size=0.386 GB, outvar_size=0.047 GB, temp_buffer_size=0.504 GB, available_memory=35.242 GB)
result[(0, 3, 1, 1), 0] = ModuleProfileResult(compute_cost=0.049, peak_memory=0.904 GB, invar_size=0.334 GB, outvar_size=0.082 GB, temp_buffer_size=0.488 GB, available_memory=35.242 GB)
result[(0, 2, 1, 2), 0] = ModuleProfileResult(compute_cost=0.017, peak_memory=0.899 GB, invar_size=0.359 GB, outvar_size=0.035 GB, temp_buffer_size=0.504 GB, available_memory=35.242 GB)
result[(0, 3, 1, 0), 0] = ModuleProfileResult(compute_cost=0.015, peak_memory=1.218 GB, invar_size=0.667 GB, outvar_size=0.047 GB, temp_buffer_size=0.504 GB, available_memory=35.242 GB)
result[(0, 2, 1, 0), 0] = ModuleProfileResult(compute_cost=0.013, peak_memory=1.180 GB, invar_size=0.641 GB, outvar_size=0.035 GB, temp_buffer_size=0.504 GB, available_memory=35.242 GB)
result[(1, 3, 1, 0), 1] = ModuleProfileResult(compute_cost=0.039, peak_memory=2.744 GB, invar_size=1.278 GB, outvar_size=0.627 GB, temp_buffer_size=1.455 GB, available_memory=35.242 GB)
result[(0, 2, 1, 1), 0] = ModuleProfileResult(compute_cost=0.036, peak_memory=0.867 GB, invar_size=0.320 GB, outvar_size=0.059 GB, temp_buffer_size=0.488 GB, available_memory=35.242 GB)
result[(0, 2, 1, 2), 1] = ModuleProfileResult(compute_cost=0.042, peak_memory=2.221 GB, invar_size=0.766 GB, outvar_size=0.359 GB, temp_buffer_size=1.455 GB, available_memory=35.242 GB)
result[(0, 3, 1, 0), 1] = ModuleProfileResult(compute_cost=0.048, peak_memory=2.847 GB, invar_size=1.381 GB, outvar_size=0.667 GB, temp_buffer_size=1.466 GB, available_memory=35.242 GB)
result[(0, 3, 1, 1), 1] = ModuleProfileResult(compute_cost=0.100, peak_memory=2.453 GB, invar_size=0.761 GB, outvar_size=0.334 GB, temp_buffer_size=1.692 GB, available_memory=35.242 GB)
result[(0, 2, 1, 0), 1] = ModuleProfileResult(compute_cost=0.040, peak_memory=2.771 GB, invar_size=1.316 GB, outvar_size=0.641 GB, temp_buffer_size=1.455 GB, available_memory=35.242 GB)
result[(0, 2, 1, 1), 1] = ModuleProfileResult(compute_cost=0.075, peak_memory=2.213 GB, invar_size=0.711 GB, outvar_size=0.320 GB, temp_buffer_size=1.502 GB, available_memory=35.242 GB)
result[(1, 3, 1, 2), 0] = ModuleProfileResult(compute_cost=0.015, peak_memory=0.768 GB, invar_size=0.358 GB, outvar_size=0.035 GB, temp_buffer_size=0.376 GB, available_memory=35.242 GB)
result[(0, 3, 1, 2), 1] = ModuleProfileResult(compute_cost=0.051, peak_memory=2.320 GB, invar_size=0.830 GB, outvar_size=0.386 GB, temp_buffer_size=1.490 GB, available_memory=35.242 GB)
result[(1, 4, 1, 0), 0] = ModuleProfileResult(compute_cost=0.015, peak_memory=1.342 GB, invar_size=0.908 GB, outvar_size=0.047 GB, temp_buffer_size=0.387 GB, available_memory=35.242 GB)
result[(1, 4, 1, 1), 0] = ModuleProfileResult(compute_cost=0.046, peak_memory=0.953 GB, invar_size=0.472 GB, outvar_size=0.082 GB, temp_buffer_size=0.399 GB, available_memory=35.242 GB)
result[(1, 4, 1, 2), 0] = ModuleProfileResult(compute_cost=0.021, peak_memory=0.932 GB, invar_size=0.498 GB, outvar_size=0.047 GB, temp_buffer_size=0.387 GB, available_memory=35.242 GB)
result[(1, 3, 1, 1), 1] = ModuleProfileResult(compute_cost=0.081, peak_memory=2.412 GB, invar_size=0.709 GB, outvar_size=0.319 GB, temp_buffer_size=1.691 GB, available_memory=35.242 GB)
result[(1, 5, 1, 0), 0] = ModuleProfileResult(compute_cost=0.017, peak_memory=1.369 GB, invar_size=0.935 GB, outvar_size=0.059 GB, temp_buffer_size=0.375 GB, available_memory=35.242 GB)
result[(1, 3, 1, 2), 1] = ModuleProfileResult(compute_cost=0.041, peak_memory=2.229 GB, invar_size=0.739 GB, outvar_size=0.346 GB, temp_buffer_size=1.478 GB, available_memory=35.242 GB)
result[(2, 5, 1, 0), 0] = ModuleProfileResult(compute_cost=0.013, peak_memory=1.071 GB, invar_size=0.649 GB, outvar_size=0.047 GB, temp_buffer_size=0.375 GB, available_memory=35.242 GB)
result[(1, 5, 1, 1), 0] = ModuleProfileResult(compute_cost=0.059, peak_memory=0.989 GB, invar_size=0.485 GB, outvar_size=0.105 GB, temp_buffer_size=0.399 GB, available_memory=35.242 GB)
result[(1, 5, 1, 2), 0] = ModuleProfileResult(compute_cost=0.024, peak_memory=0.959 GB, invar_size=0.525 GB, outvar_size=0.059 GB, temp_buffer_size=0.376 GB, available_memory=35.242 GB)
result[(1, 4, 1, 0), 1] = ModuleProfileResult(compute_cost=0.051, peak_memory=3.318 GB, invar_size=1.852 GB, outvar_size=0.908 GB, temp_buffer_size=1.455 GB, available_memory=35.242 GB)
result[(1, 4, 1, 1), 1] = ModuleProfileResult(compute_cost=0.097, peak_memory=2.741 GB, invar_size=1.014 GB, outvar_size=0.460 GB, temp_buffer_size=1.716 GB, available_memory=35.242 GB)
result[(2, 5, 1, 1), 0] = ModuleProfileResult(compute_cost=0.048, peak_memory=0.823 GB, invar_size=0.342 GB, outvar_size=0.082 GB, temp_buffer_size=0.399 GB, available_memory=35.242 GB)
result[(2, 5, 1, 2), 0] = ModuleProfileResult(compute_cost=0.018, peak_memory=0.790 GB, invar_size=0.368 GB, outvar_size=0.047 GB, temp_buffer_size=0.376 GB, available_memory=35.242 GB)
result[(1, 4, 1, 2), 1] = ModuleProfileResult(compute_cost=0.055, peak_memory=2.523 GB, invar_size=1.020 GB, outvar_size=0.486 GB, temp_buffer_size=1.491 GB, available_memory=35.242 GB)
result[(2, 6, 1, 0), 0] = ModuleProfileResult(compute_cost=0.017, peak_memory=1.376 GB, invar_size=0.930 GB, outvar_size=0.059 GB, temp_buffer_size=0.387 GB, available_memory=35.242 GB)
result[(1, 5, 1, 0), 1] = ModuleProfileResult(compute_cost=0.059, peak_memory=3.383 GB, invar_size=1.916 GB, outvar_size=0.935 GB, temp_buffer_size=1.455 GB, available_memory=35.242 GB)
result[(2, 5, 1, 0), 1] = ModuleProfileResult(compute_cost=0.045, peak_memory=2.800 GB, invar_size=1.333 GB, outvar_size=0.649 GB, temp_buffer_size=1.455 GB, available_memory=35.242 GB)
result[(1, 5, 1, 1), 1] = ModuleProfileResult(compute_cost=0.123, peak_memory=2.979 GB, invar_size=1.064 GB, outvar_size=0.473 GB, temp_buffer_size=1.903 GB, available_memory=35.242 GB)
result[(3, 6, 1, 0), 0] = ModuleProfileResult(compute_cost=0.012, peak_memory=1.061 GB, invar_size=0.627 GB, outvar_size=0.047 GB, temp_buffer_size=0.387 GB, available_memory=35.242 GB)
result[(2, 5, 1, 1), 1] = ModuleProfileResult(compute_cost=0.101, peak_memory=2.658 GB, invar_size=0.755 GB, outvar_size=0.342 GB, temp_buffer_size=1.880 GB, available_memory=35.242 GB)
result[(2, 6, 1, 1), 0] = ModuleProfileResult(compute_cost=0.055, peak_memory=0.987 GB, invar_size=0.483 GB, outvar_size=0.105 GB, temp_buffer_size=0.399 GB, available_memory=35.242 GB)
result[(3, 6, 1, 1), 0] = ModuleProfileResult(compute_cost=0.039, peak_memory=0.812 GB, invar_size=0.331 GB, outvar_size=0.082 GB, temp_buffer_size=0.399 GB, available_memory=35.242 GB)
result[(2, 6, 1, 2), 0] = ModuleProfileResult(compute_cost=0.024, peak_memory=1.005 GB, invar_size=0.508 GB, outvar_size=0.059 GB, temp_buffer_size=0.438 GB, available_memory=35.242 GB)
result[(1, 5, 1, 2), 1] = ModuleProfileResult(compute_cost=0.063, peak_memory=2.599 GB, invar_size=1.096 GB, outvar_size=0.513 GB, temp_buffer_size=1.491 GB, available_memory=35.242 GB)
result[(2, 5, 1, 2), 1] = ModuleProfileResult(compute_cost=0.048, peak_memory=2.286 GB, invar_size=0.783 GB, outvar_size=0.368 GB, temp_buffer_size=1.491 GB, available_memory=35.242 GB)
result[(3, 6, 1, 2), 0] = ModuleProfileResult(compute_cost=0.016, peak_memory=0.780 GB, invar_size=0.346 GB, outvar_size=0.047 GB, temp_buffer_size=0.387 GB, available_memory=35.242 GB)
result[(3, 7, 1, 0), 0] = ModuleProfileResult(compute_cost=0.012, peak_memory=1.061 GB, invar_size=0.627 GB, outvar_size=0.047 GB, temp_buffer_size=0.387 GB, available_memory=35.242 GB)
result[(3, 6, 1, 0), 1] = ModuleProfileResult(compute_cost=0.039, peak_memory=2.677 GB, invar_size=1.289 GB, outvar_size=0.627 GB, temp_buffer_size=1.376 GB, available_memory=35.242 GB)
result[(3, 7, 1, 1), 0] = ModuleProfileResult(compute_cost=0.039, peak_memory=0.812 GB, invar_size=0.331 GB, outvar_size=0.082 GB, temp_buffer_size=0.399 GB, available_memory=35.242 GB)
result[(2, 6, 1, 0), 1] = ModuleProfileResult(compute_cost=0.056, peak_memory=3.374 GB, invar_size=1.908 GB, outvar_size=0.930 GB, temp_buffer_size=1.455 GB, available_memory=35.242 GB)
result[(3, 7, 1, 2), 0] = ModuleProfileResult(compute_cost=0.016, peak_memory=0.780 GB, invar_size=0.346 GB, outvar_size=0.047 GB, temp_buffer_size=0.387 GB, available_memory=35.242 GB)
result[(4, 7, 1, 0), 0] = ModuleProfileResult(compute_cost=0.009, peak_memory=1.023 GB, invar_size=0.601 GB, outvar_size=0.035 GB, temp_buffer_size=0.387 GB, available_memory=35.242 GB)
result[(2, 6, 1, 1), 1] = ModuleProfileResult(compute_cost=0.117, peak_memory=2.988 GB, invar_size=1.059 GB, outvar_size=0.483 GB, temp_buffer_size=1.905 GB, available_memory=35.242 GB)
result[(3, 6, 1, 1), 1] = ModuleProfileResult(compute_cost=0.084, peak_memory=2.346 GB, invar_size=0.733 GB, outvar_size=0.331 GB, temp_buffer_size=1.590 GB, available_memory=35.242 GB)
result[(4, 7, 1, 1), 0] = ModuleProfileResult(compute_cost=0.025, peak_memory=0.776 GB, invar_size=0.318 GB, outvar_size=0.059 GB, temp_buffer_size=0.399 GB, available_memory=35.242 GB)
result[(2, 6, 1, 2), 1] = ModuleProfileResult(compute_cost=0.062, peak_memory=2.580 GB, invar_size=1.064 GB, outvar_size=0.508 GB, temp_buffer_size=1.504 GB, available_memory=35.242 GB)
result[(3, 6, 1, 2), 1] = ModuleProfileResult(compute_cost=0.043, peak_memory=2.115 GB, invar_size=0.727 GB, outvar_size=0.346 GB, temp_buffer_size=1.376 GB, available_memory=35.242 GB)
result[(4, 7, 1, 2), 0] = ModuleProfileResult(compute_cost=0.013, peak_memory=0.827 GB, invar_size=0.331 GB, outvar_size=0.035 GB, temp_buffer_size=0.461 GB, available_memory=35.242 GB)
result[(4, 7, 1, 0), 1] = ModuleProfileResult(compute_cost=0.046, peak_memory=3.119 GB, invar_size=1.361 GB, outvar_size=0.669 GB, temp_buffer_size=1.747 GB, available_memory=35.242 GB)
result[(3, 7, 1, 1), 1] = ModuleProfileResult(compute_cost=0.117, peak_memory=2.619 GB, invar_size=0.789 GB, outvar_size=0.365 GB, temp_buffer_size=1.807 GB, available_memory=35.242 GB)
result[(3, 7, 1, 0), 1] = ModuleProfileResult(compute_cost=0.054, peak_memory=3.184 GB, invar_size=1.425 GB, outvar_size=0.695 GB, temp_buffer_size=1.747 GB, available_memory=35.242 GB)
result[(3, 7, 1, 2), 1] = ModuleProfileResult(compute_cost=0.063, peak_memory=2.587 GB, invar_size=0.817 GB, outvar_size=0.391 GB, temp_buffer_size=1.759 GB, available_memory=35.242 GB)
result[(4, 7, 1, 1), 1] = ModuleProfileResult(compute_cost=0.088, peak_memory=2.581 GB, invar_size=0.739 GB, outvar_size=0.340 GB, temp_buffer_size=1.830 GB, available_memory=35.242 GB)
result[(4, 7, 1, 2), 1] = ModuleProfileResult(compute_cost=0.054, peak_memory=2.534 GB, invar_size=0.764 GB, outvar_size=0.364 GB, temp_buffer_size=1.759 GB, available_memory=35.242 GB)
Profiling for submesh 1 (1, 2) takes 49.26 seconds
--------------------------------------------------
- Profiling for submesh 0 (1, 1):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(2, 3, 0, 0), 0] = ModuleProfileResult(compute_cost=0.014, peak_memory=1.151 GB, invar_size=0.353 GB, outvar_size=0.047 GB, temp_buffer_size=0.750 GB, available_memory=35.242 GB)
result[(3, 4, 0, 1), 0] = ModuleProfileResult(compute_cost=0.011, peak_memory=1.152 GB, invar_size=0.331 GB, outvar_size=0.047 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(3, 4, 0, 0), 0] = ModuleProfileResult(compute_cost=0.011, peak_memory=1.152 GB, invar_size=0.331 GB, outvar_size=0.047 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(2, 3, 0, 1), 0] = ModuleProfileResult(compute_cost=0.014, peak_memory=1.151 GB, invar_size=0.353 GB, outvar_size=0.047 GB, temp_buffer_size=0.750 GB, available_memory=35.242 GB)
result[(0, 1, 0, 0), 0] = ModuleProfileResult(compute_cost=0.014, peak_memory=1.392 GB, invar_size=0.338 GB, outvar_size=0.047 GB, temp_buffer_size=1.008 GB, available_memory=35.242 GB)
result[(0, 1, 0, 1), 0] = ModuleProfileResult(compute_cost=0.014, peak_memory=1.392 GB, invar_size=0.338 GB, outvar_size=0.047 GB, temp_buffer_size=1.008 GB, available_memory=35.242 GB)
result[(3, 5, 0, 0), 0] = ModuleProfileResult(compute_cost=0.015, peak_memory=1.178 GB, invar_size=0.358 GB, outvar_size=0.070 GB, temp_buffer_size=0.751 GB, available_memory=35.242 GB)
result[(0, 1, 0, 1), 1] = ModuleProfileResult(compute_cost=0.036, peak_memory=3.076 GB, invar_size=0.722 GB, outvar_size=0.337 GB, temp_buffer_size=2.354 GB, available_memory=35.242 GB)
result[(2, 3, 0, 0), 1] = ModuleProfileResult(compute_cost=0.040, peak_memory=4.038 GB, invar_size=0.730 GB, outvar_size=0.353 GB, temp_buffer_size=3.284 GB, available_memory=35.242 GB)
result[(3, 4, 0, 0), 1] = ModuleProfileResult(compute_cost=0.031, peak_memory=3.462 GB, invar_size=0.686 GB, outvar_size=0.331 GB, temp_buffer_size=2.753 GB, available_memory=35.242 GB)
result[(0, 1, 0, 0), 1] = ModuleProfileResult(compute_cost=0.036, peak_memory=3.076 GB, invar_size=0.722 GB, outvar_size=0.337 GB, temp_buffer_size=2.354 GB, available_memory=35.242 GB)
result[(3, 4, 0, 1), 1] = ModuleProfileResult(compute_cost=0.031, peak_memory=3.462 GB, invar_size=0.686 GB, outvar_size=0.331 GB, temp_buffer_size=2.753 GB, available_memory=35.242 GB)
result[(2, 3, 0, 1), 1] = ModuleProfileResult(compute_cost=0.040, peak_memory=4.038 GB, invar_size=0.730 GB, outvar_size=0.353 GB, temp_buffer_size=3.284 GB, available_memory=35.242 GB)
result[(4, 5, 0, 0), 0] = ModuleProfileResult(compute_cost=0.011, peak_memory=1.129 GB, invar_size=0.331 GB, outvar_size=0.047 GB, temp_buffer_size=0.750 GB, available_memory=35.242 GB)
result[(3, 5, 0, 1), 0] = ModuleProfileResult(compute_cost=0.015, peak_memory=1.178 GB, invar_size=0.358 GB, outvar_size=0.070 GB, temp_buffer_size=0.751 GB, available_memory=35.242 GB)
result[(4, 5, 0, 1), 0] = ModuleProfileResult(compute_cost=0.011, peak_memory=1.129 GB, invar_size=0.331 GB, outvar_size=0.047 GB, temp_buffer_size=0.750 GB, available_memory=35.242 GB)
result[(5, 6, 0, 0), 0] = ModuleProfileResult(compute_cost=0.011, peak_memory=1.152 GB, invar_size=0.331 GB, outvar_size=0.047 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(3, 5, 0, 0), 1] = ModuleProfileResult(compute_cost=0.044, peak_memory=4.008 GB, invar_size=0.762 GB, outvar_size=0.358 GB, temp_buffer_size=3.222 GB, available_memory=35.242 GB)
result[(5, 6, 0, 1), 0] = ModuleProfileResult(compute_cost=0.011, peak_memory=1.152 GB, invar_size=0.331 GB, outvar_size=0.047 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(6, 7, 0, 0), 0] = ModuleProfileResult(compute_cost=0.006, peak_memory=1.102 GB, invar_size=0.305 GB, outvar_size=0.023 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(6, 7, 0, 1), 0] = ModuleProfileResult(compute_cost=0.006, peak_memory=1.102 GB, invar_size=0.305 GB, outvar_size=0.023 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(4, 5, 0, 1), 1] = ModuleProfileResult(compute_cost=0.031, peak_memory=3.414 GB, invar_size=0.686 GB, outvar_size=0.331 GB, temp_buffer_size=2.705 GB, available_memory=35.242 GB)
result[(4, 5, 0, 0), 1] = ModuleProfileResult(compute_cost=0.031, peak_memory=3.414 GB, invar_size=0.686 GB, outvar_size=0.331 GB, temp_buffer_size=2.705 GB, available_memory=35.242 GB)
result[(5, 6, 0, 0), 1] = ModuleProfileResult(compute_cost=0.031, peak_memory=3.439 GB, invar_size=0.686 GB, outvar_size=0.331 GB, temp_buffer_size=2.730 GB, available_memory=35.242 GB)
result[(6, 7, 0, 0), 1] = ModuleProfileResult(compute_cost=0.045, peak_memory=4.263 GB, invar_size=0.745 GB, outvar_size=0.373 GB, temp_buffer_size=3.494 GB, available_memory=35.242 GB)
result[(5, 6, 0, 1), 1] = ModuleProfileResult(compute_cost=0.031, peak_memory=3.439 GB, invar_size=0.686 GB, outvar_size=0.331 GB, temp_buffer_size=2.730 GB, available_memory=35.242 GB)
result[(3, 5, 0, 1), 1] = ModuleProfileResult(compute_cost=0.044, peak_memory=4.008 GB, invar_size=0.762 GB, outvar_size=0.358 GB, temp_buffer_size=3.222 GB, available_memory=35.242 GB)
result[(6, 7, 0, 1), 1] = ModuleProfileResult(compute_cost=0.045, peak_memory=4.263 GB, invar_size=0.745 GB, outvar_size=0.373 GB, temp_buffer_size=3.494 GB, available_memory=35.242 GB)
Profiling for submesh 0 (1, 1) takes 16.94 seconds
--------------------------------------------------
----------------------------------------------------------------------
Result forward_stage_layer_ids: [[0, 1], [2, 3], [4, 5, 6, 7]]
Result mesh_shapes: [(1, 1), (1, 1), (1, 2)]
Result logical_mesh_shapes: [(1, 1), (1, 1), (2, 1)]
Result autosharding_option_dicts: [{'force_batch_dim_to_mesh_dim': 0}, {'force_batch_dim_to_mesh_dim': 0}, {'force_batch_dim_to_mesh_dim': 0}]
 - Compile (driver): 137.37 s
compilation time breakdown: {'stage-construction': '115.19', 'stage-construction-dp': '1.37', 'stage-construction-compilation': '50.20', 'stage-construction-profiling': '32.32'}
 - Compile (worker): 8.24 s
[I] Training process warmup (2 rounds) with dummy input batch...
    - Warmup iteration: 1/2
    - Warmup iteration: 2/2
[I] Ready to perform training process.
[I] Benchmark the training process with entire dataset and profile with driver overhead...
    - Iteration 1 / 5 is performed...
    - Iteration 2 / 5 is performed...
    - Iteration 3 / 5 is performed...
    - Iteration 4 / 5 is performed...
 - Benchmark: 32.88 s

[8.387746334075928, 3.8979406356811523, 3.6994211673736572, 3.6494500637054443, 3.716655969619751, 3.6302108764648438, 3.8353402614593506]


[I] Performance metrics:
 - Iteration count: 5.
 - Total e2e training time : 19.174 s.
 - Average e2e iteration time: 3.8350002765655518 s.
 - Total local training time: 18.5310001373291 s.
 - Average local iteration time: 3.7060000896453857 s.
 - Max allocated memory among devices: 5.425 GB.
 - Compilation times:  {'stage-construction': 115.19421744346619, 'stage-construction-dp': 1.3746142387390137, 'stage-construction-compilation': 50.20033240318298, 'stage-construction-profiling': 32.32226634025574}
 - Metadata:  []
 - Is need save result:  True

[TMP] Current profiling results of key `2_a40_2_n_2_d`: 3.7062156200408936
[TMP] Updated profiling results stored in `./jaxpr/prof_log/optimal/moe_690M_256.pkl`...

------------------------------------------------------------------
- (2/3) Profiling moe_690M with batch size: 512...
------------------------------------------------------------------
[TMP] Existed profiling results in `./jaxpr/prof_log/optimal/moe_690M_512.pkl`, updating/rewriting it...
[I] Ray Cluster & Alpa backend initialization is completed.
[I] Device Info:
    - Devices num per node: 2
    - Nodes num: 2
[I] Loading flax model....
[I] Model 'moe' loads sucessfully. Model Info: 

FlaxMoEForLMModule(
    # attributes
    config = <model.moe_model.MoEConfig object at 0x7fe815d50670>
    dtype = float16
    bias_init = zeros
) 

[I] Manually constructing dummy batch...
[I] Initialize training state...
[I] Training state initialization is completed.
[I] Constructing Alpa parallelized train step func...
[I] Alpa parallelized train step func construction is completed.
-------------------- Automatic stage clustering --------------------
submesh_choices: ((1, 1), (1, 2), (2, 2))
- Profiling for submesh 2 (2, 2):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(0, 7, 2, 0), 0] = ModuleProfileResult(compute_cost=0.024, peak_memory=1.842 GB, invar_size=1.256 GB, outvar_size=0.082 GB, temp_buffer_size=0.504 GB, available_memory=35.242 GB)
result[(0, 7, 2, 1), 0] = ModuleProfileResult(compute_cost=0.041, peak_memory=1.241 GB, invar_size=0.632 GB, outvar_size=0.082 GB, temp_buffer_size=0.527 GB, available_memory=35.242 GB)
result[(0, 7, 2, 2), 0] = ModuleProfileResult(compute_cost=0.063, peak_memory=0.998 GB, invar_size=0.412 GB, outvar_size=0.082 GB, temp_buffer_size=0.504 GB, available_memory=35.242 GB)
result[(0, 7, 2, 0), 1] = ModuleProfileResult(compute_cost=0.149, peak_memory=4.488 GB, invar_size=2.730 GB, outvar_size=1.324 GB, temp_buffer_size=1.759 GB, available_memory=35.242 GB)
result[(0, 7, 2, 1), 1] = ModuleProfileResult(compute_cost=0.228, peak_memory=3.245 GB, invar_size=1.415 GB, outvar_size=0.666 GB, temp_buffer_size=1.830 GB, available_memory=35.242 GB)
result[(0, 7, 2, 2), 1] = ModuleProfileResult(compute_cost=0.166, peak_memory=2.801 GB, invar_size=1.042 GB, outvar_size=0.480 GB, temp_buffer_size=1.759 GB, available_memory=35.242 GB)
Profiling for submesh 2 (2, 2) takes 47.26 seconds
--------------------------------------------------
- Profiling for submesh 1 (1, 2):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(0, 2, 1, 2), 0] = ModuleProfileResult(compute_cost=0.033, peak_memory=1.438 GB, invar_size=0.360 GB, outvar_size=0.070 GB, temp_buffer_size=1.008 GB, available_memory=35.242 GB)
result[(0, 3, 1, 2), 0] = ModuleProfileResult(compute_cost=0.037, peak_memory=1.487 GB, invar_size=0.386 GB, outvar_size=0.094 GB, temp_buffer_size=1.008 GB, available_memory=35.242 GB)
result[(0, 3, 1, 1), 0] = ModuleProfileResult(compute_cost=0.095, peak_memory=1.475 GB, invar_size=0.334 GB, outvar_size=0.164 GB, temp_buffer_size=0.977 GB, available_memory=35.242 GB)
result[(0, 2, 1, 1), 0] = ModuleProfileResult(compute_cost=0.069, peak_memory=1.414 GB, invar_size=0.321 GB, outvar_size=0.117 GB, temp_buffer_size=0.977 GB, available_memory=35.242 GB)
result[(1, 3, 1, 1), 0] = ModuleProfileResult(compute_cost=0.073, peak_memory=1.223 GB, invar_size=0.355 GB, outvar_size=0.117 GB, temp_buffer_size=0.751 GB, available_memory=35.242 GB)
result[(1, 3, 1, 0), 0] = ModuleProfileResult(compute_cost=0.021, peak_memory=1.460 GB, invar_size=0.639 GB, outvar_size=0.070 GB, temp_buffer_size=0.751 GB, available_memory=35.242 GB)
result[(0, 3, 1, 0), 0] = ModuleProfileResult(compute_cost=0.028, peak_memory=1.769 GB, invar_size=0.667 GB, outvar_size=0.094 GB, temp_buffer_size=1.008 GB, available_memory=35.242 GB)
result[(0, 2, 1, 0), 0] = ModuleProfileResult(compute_cost=0.024, peak_memory=1.719 GB, invar_size=0.641 GB, outvar_size=0.070 GB, temp_buffer_size=1.008 GB, available_memory=35.242 GB)
result[(0, 2, 1, 0), 1] = ModuleProfileResult(compute_cost=0.069, peak_memory=4.261 GB, invar_size=1.352 GB, outvar_size=0.641 GB, temp_buffer_size=2.909 GB, available_memory=35.242 GB)
result[(0, 2, 1, 2), 1] = ModuleProfileResult(compute_cost=0.078, peak_memory=3.723 GB, invar_size=0.813 GB, outvar_size=0.359 GB, temp_buffer_size=2.910 GB, available_memory=35.242 GB)
result[(1, 3, 1, 0), 1] = ModuleProfileResult(compute_cost=0.067, peak_memory=4.257 GB, invar_size=1.325 GB, outvar_size=0.639 GB, temp_buffer_size=2.909 GB, available_memory=35.242 GB)
result[(1, 3, 1, 2), 0] = ModuleProfileResult(compute_cost=0.029, peak_memory=1.202 GB, invar_size=0.381 GB, outvar_size=0.070 GB, temp_buffer_size=0.751 GB, available_memory=35.242 GB)
result[(0, 3, 1, 0), 1] = ModuleProfileResult(compute_cost=0.082, peak_memory=4.360 GB, invar_size=1.428 GB, outvar_size=0.667 GB, temp_buffer_size=2.932 GB, available_memory=35.242 GB)
result[(0, 2, 1, 1), 1] = ModuleProfileResult(compute_cost=0.143, peak_memory=3.786 GB, invar_size=0.782 GB, outvar_size=0.320 GB, temp_buffer_size=3.004 GB, available_memory=35.242 GB)
result[(1, 4, 1, 0), 0] = ModuleProfileResult(compute_cost=0.027, peak_memory=1.788 GB, invar_size=0.920 GB, outvar_size=0.094 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(0, 3, 1, 1), 1] = ModuleProfileResult(compute_cost=0.192, peak_memory=4.237 GB, invar_size=0.855 GB, outvar_size=0.334 GB, temp_buffer_size=3.382 GB, available_memory=35.242 GB)
result[(0, 3, 1, 2), 1] = ModuleProfileResult(compute_cost=0.093, peak_memory=3.869 GB, invar_size=0.889 GB, outvar_size=0.386 GB, temp_buffer_size=2.980 GB, available_memory=35.242 GB)
result[(1, 3, 1, 1), 1] = ModuleProfileResult(compute_cost=0.156, peak_memory=4.207 GB, invar_size=0.803 GB, outvar_size=0.331 GB, temp_buffer_size=3.381 GB, available_memory=35.242 GB)
result[(1, 4, 1, 1), 0] = ModuleProfileResult(compute_cost=0.087, peak_memory=1.457 GB, invar_size=0.495 GB, outvar_size=0.164 GB, temp_buffer_size=0.798 GB, available_memory=35.242 GB)
result[(1, 4, 1, 2), 0] = ModuleProfileResult(compute_cost=0.039, peak_memory=1.390 GB, invar_size=0.522 GB, outvar_size=0.094 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(1, 3, 1, 2), 1] = ModuleProfileResult(compute_cost=0.075, peak_memory=3.789 GB, invar_size=0.809 GB, outvar_size=0.358 GB, temp_buffer_size=2.957 GB, available_memory=35.242 GB)
result[(1, 5, 1, 0), 0] = ModuleProfileResult(compute_cost=0.032, peak_memory=1.814 GB, invar_size=0.947 GB, outvar_size=0.117 GB, temp_buffer_size=0.751 GB, available_memory=35.242 GB)
result[(2, 5, 1, 0), 0] = ModuleProfileResult(compute_cost=0.025, peak_memory=1.505 GB, invar_size=0.661 GB, outvar_size=0.094 GB, temp_buffer_size=0.751 GB, available_memory=35.242 GB)
result[(1, 4, 1, 0), 1] = ModuleProfileResult(compute_cost=0.087, peak_memory=4.843 GB, invar_size=1.910 GB, outvar_size=0.920 GB, temp_buffer_size=2.909 GB, available_memory=35.242 GB)
result[(1, 4, 1, 1), 1] = ModuleProfileResult(compute_cost=0.188, peak_memory=4.585 GB, invar_size=1.131 GB, outvar_size=0.472 GB, temp_buffer_size=3.430 GB, available_memory=35.242 GB)
result[(1, 5, 1, 2), 0] = ModuleProfileResult(compute_cost=0.044, peak_memory=1.416 GB, invar_size=0.548 GB, outvar_size=0.117 GB, temp_buffer_size=0.751 GB, available_memory=35.242 GB)
result[(1, 5, 1, 1), 0] = ModuleProfileResult(compute_cost=0.113, peak_memory=1.517 GB, invar_size=0.509 GB, outvar_size=0.211 GB, temp_buffer_size=0.798 GB, available_memory=35.242 GB)
result[(2, 5, 1, 1), 0] = ModuleProfileResult(compute_cost=0.092, peak_memory=1.328 GB, invar_size=0.366 GB, outvar_size=0.164 GB, temp_buffer_size=0.798 GB, available_memory=35.242 GB)
result[(2, 5, 1, 2), 0] = ModuleProfileResult(compute_cost=0.034, peak_memory=1.348 GB, invar_size=0.380 GB, outvar_size=0.094 GB, temp_buffer_size=0.875 GB, available_memory=35.242 GB)
result[(1, 4, 1, 2), 1] = ModuleProfileResult(compute_cost=0.102, peak_memory=4.096 GB, invar_size=1.090 GB, outvar_size=0.498 GB, temp_buffer_size=2.983 GB, available_memory=35.242 GB)
result[(2, 6, 1, 0), 0] = ModuleProfileResult(compute_cost=0.031, peak_memory=1.833 GB, invar_size=0.942 GB, outvar_size=0.117 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(2, 5, 1, 0), 1] = ModuleProfileResult(compute_cost=0.077, peak_memory=4.324 GB, invar_size=1.392 GB, outvar_size=0.661 GB, temp_buffer_size=2.909 GB, available_memory=35.242 GB)
result[(3, 6, 1, 0), 0] = ModuleProfileResult(compute_cost=0.021, peak_memory=1.507 GB, invar_size=0.639 GB, outvar_size=0.094 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(2, 5, 1, 1), 1] = ModuleProfileResult(compute_cost=0.194, peak_memory=4.677 GB, invar_size=0.872 GB, outvar_size=0.366 GB, temp_buffer_size=3.758 GB, available_memory=35.242 GB)
result[(1, 5, 1, 0), 1] = ModuleProfileResult(compute_cost=0.101, peak_memory=4.919 GB, invar_size=1.987 GB, outvar_size=0.946 GB, temp_buffer_size=2.909 GB, available_memory=35.242 GB)
result[(2, 6, 1, 1), 0] = ModuleProfileResult(compute_cost=0.106, peak_memory=1.515 GB, invar_size=0.506 GB, outvar_size=0.211 GB, temp_buffer_size=0.798 GB, available_memory=35.242 GB)
result[(1, 5, 1, 1), 1] = ModuleProfileResult(compute_cost=0.236, peak_memory=5.033 GB, invar_size=1.204 GB, outvar_size=0.485 GB, temp_buffer_size=3.805 GB, available_memory=35.242 GB)
result[(2, 6, 1, 2), 0] = ModuleProfileResult(compute_cost=0.044, peak_memory=1.412 GB, invar_size=0.520 GB, outvar_size=0.117 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(1, 5, 1, 2), 1] = ModuleProfileResult(compute_cost=0.116, peak_memory=4.196 GB, invar_size=1.190 GB, outvar_size=0.525 GB, temp_buffer_size=2.983 GB, available_memory=35.242 GB)
result[(3, 6, 1, 1), 0] = ModuleProfileResult(compute_cost=0.074, peak_memory=1.317 GB, invar_size=0.355 GB, outvar_size=0.164 GB, temp_buffer_size=0.798 GB, available_memory=35.242 GB)
result[(2, 5, 1, 2), 1] = ModuleProfileResult(compute_cost=0.088, peak_memory=3.859 GB, invar_size=0.853 GB, outvar_size=0.380 GB, temp_buffer_size=2.983 GB, available_memory=35.242 GB)
result[(3, 6, 1, 2), 0] = ModuleProfileResult(compute_cost=0.030, peak_memory=1.225 GB, invar_size=0.358 GB, outvar_size=0.094 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(3, 7, 1, 0), 0] = ModuleProfileResult(compute_cost=0.021, peak_memory=1.507 GB, invar_size=0.639 GB, outvar_size=0.094 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(3, 6, 1, 0), 1] = ModuleProfileResult(compute_cost=0.067, peak_memory=4.123 GB, invar_size=1.348 GB, outvar_size=0.639 GB, temp_buffer_size=2.752 GB, available_memory=35.242 GB)
result[(3, 7, 1, 2), 0] = ModuleProfileResult(compute_cost=0.030, peak_memory=1.225 GB, invar_size=0.358 GB, outvar_size=0.094 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(3, 7, 1, 1), 0] = ModuleProfileResult(compute_cost=0.074, peak_memory=1.317 GB, invar_size=0.355 GB, outvar_size=0.164 GB, temp_buffer_size=0.798 GB, available_memory=35.242 GB)
result[(2, 6, 1, 0), 1] = ModuleProfileResult(compute_cost=0.097, peak_memory=4.910 GB, invar_size=1.978 GB, outvar_size=0.942 GB, temp_buffer_size=2.909 GB, available_memory=35.242 GB)
result[(4, 7, 1, 0), 0] = ModuleProfileResult(compute_cost=0.017, peak_memory=1.457 GB, invar_size=0.612 GB, outvar_size=0.070 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(2, 6, 1, 1), 1] = ModuleProfileResult(compute_cost=0.226, peak_memory=5.055 GB, invar_size=1.200 GB, outvar_size=0.506 GB, temp_buffer_size=3.808 GB, available_memory=35.242 GB)
result[(3, 6, 1, 1), 1] = ModuleProfileResult(compute_cost=0.161, peak_memory=4.075 GB, invar_size=0.850 GB, outvar_size=0.355 GB, temp_buffer_size=3.179 GB, available_memory=35.242 GB)
result[(2, 6, 1, 2), 1] = ModuleProfileResult(compute_cost=0.114, peak_memory=4.166 GB, invar_size=1.134 GB, outvar_size=0.520 GB, temp_buffer_size=3.008 GB, available_memory=35.242 GB)
result[(3, 6, 1, 2), 1] = ModuleProfileResult(compute_cost=0.080, peak_memory=3.561 GB, invar_size=0.785 GB, outvar_size=0.358 GB, temp_buffer_size=2.752 GB, available_memory=35.242 GB)
result[(4, 7, 1, 1), 0] = ModuleProfileResult(compute_cost=0.049, peak_memory=1.257 GB, invar_size=0.341 GB, outvar_size=0.117 GB, temp_buffer_size=0.798 GB, available_memory=35.242 GB)
result[(4, 7, 1, 2), 0] = ModuleProfileResult(compute_cost=0.024, peak_memory=1.223 GB, invar_size=0.355 GB, outvar_size=0.070 GB, temp_buffer_size=0.798 GB, available_memory=35.242 GB)
result[(3, 7, 1, 0), 1] = ModuleProfileResult(compute_cost=0.095, peak_memory=5.001 GB, invar_size=1.484 GB, outvar_size=0.707 GB, temp_buffer_size=3.494 GB, available_memory=35.242 GB)
result[(4, 7, 1, 0), 1] = ModuleProfileResult(compute_cost=0.082, peak_memory=4.925 GB, invar_size=1.407 GB, outvar_size=0.680 GB, temp_buffer_size=3.494 GB, available_memory=35.242 GB)
result[(3, 7, 1, 1), 1] = ModuleProfileResult(compute_cost=0.226, peak_memory=4.555 GB, invar_size=0.894 GB, outvar_size=0.388 GB, temp_buffer_size=3.613 GB, available_memory=35.242 GB)
result[(3, 7, 1, 2), 1] = ModuleProfileResult(compute_cost=0.108, peak_memory=4.439 GB, invar_size=0.921 GB, outvar_size=0.425 GB, temp_buffer_size=3.494 GB, available_memory=35.242 GB)
result[(4, 7, 1, 1), 1] = ModuleProfileResult(compute_cost=0.171, peak_memory=4.504 GB, invar_size=0.821 GB, outvar_size=0.352 GB, temp_buffer_size=3.659 GB, available_memory=35.242 GB)
result[(4, 7, 1, 2), 1] = ModuleProfileResult(compute_cost=0.093, peak_memory=4.386 GB, invar_size=0.868 GB, outvar_size=0.399 GB, temp_buffer_size=3.494 GB, available_memory=35.242 GB)
Profiling for submesh 1 (1, 2) takes 52.11 seconds
--------------------------------------------------
- Profiling for submesh 0 (1, 1):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(3, 4, 0, 1), 0] = ModuleProfileResult(compute_cost=0.021, peak_memory=1.996 GB, invar_size=0.355 GB, outvar_size=0.094 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(3, 4, 0, 0), 0] = ModuleProfileResult(compute_cost=0.021, peak_memory=1.996 GB, invar_size=0.355 GB, outvar_size=0.094 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(2, 3, 0, 0), 0] = ModuleProfileResult(compute_cost=0.027, peak_memory=1.971 GB, invar_size=0.377 GB, outvar_size=0.094 GB, temp_buffer_size=1.501 GB, available_memory=35.242 GB)
result[(2, 3, 0, 1), 0] = ModuleProfileResult(compute_cost=0.027, peak_memory=1.971 GB, invar_size=0.377 GB, outvar_size=0.094 GB, temp_buffer_size=1.501 GB, available_memory=35.242 GB)
result[(3, 5, 0, 0), 0] = ModuleProfileResult(compute_cost=0.029, peak_memory=2.023 GB, invar_size=0.381 GB, outvar_size=0.141 GB, temp_buffer_size=1.501 GB, available_memory=35.242 GB)
result[(0, 1, 0, 0), 0] = ModuleProfileResult(compute_cost=0.028, peak_memory=2.447 GB, invar_size=0.338 GB, outvar_size=0.094 GB, temp_buffer_size=2.016 GB, available_memory=35.242 GB)
result[(0, 1, 0, 1), 0] = ModuleProfileResult(compute_cost=0.028, peak_memory=2.447 GB, invar_size=0.338 GB, outvar_size=0.094 GB, temp_buffer_size=2.016 GB, available_memory=35.242 GB)
result[(0, 1, 0, 1), 1] = ModuleProfileResult(compute_cost=0.070, peak_memory=5.477 GB, invar_size=0.769 GB, outvar_size=0.337 GB, temp_buffer_size=4.709 GB, available_memory=35.242 GB)
result[(3, 4, 0, 1), 1] = ModuleProfileResult(compute_cost=0.060, peak_memory=6.309 GB, invar_size=0.756 GB, outvar_size=0.355 GB, temp_buffer_size=5.506 GB, available_memory=35.242 GB)
result[(2, 3, 0, 0), 1] = ModuleProfileResult(compute_cost=0.078, peak_memory=7.415 GB, invar_size=0.800 GB, outvar_size=0.377 GB, temp_buffer_size=6.569 GB, available_memory=35.242 GB)
result[(3, 5, 0, 1), 0] = ModuleProfileResult(compute_cost=0.029, peak_memory=2.023 GB, invar_size=0.381 GB, outvar_size=0.141 GB, temp_buffer_size=1.501 GB, available_memory=35.242 GB)
result[(4, 5, 0, 0), 0] = ModuleProfileResult(compute_cost=0.021, peak_memory=1.949 GB, invar_size=0.355 GB, outvar_size=0.094 GB, temp_buffer_size=1.501 GB, available_memory=35.242 GB)
result[(0, 1, 0, 0), 1] = ModuleProfileResult(compute_cost=0.070, peak_memory=5.477 GB, invar_size=0.769 GB, outvar_size=0.337 GB, temp_buffer_size=4.709 GB, available_memory=35.242 GB)
result[(2, 3, 0, 1), 1] = ModuleProfileResult(compute_cost=0.078, peak_memory=7.415 GB, invar_size=0.800 GB, outvar_size=0.377 GB, temp_buffer_size=6.569 GB, available_memory=35.242 GB)
result[(4, 5, 0, 1), 0] = ModuleProfileResult(compute_cost=0.021, peak_memory=1.949 GB, invar_size=0.355 GB, outvar_size=0.094 GB, temp_buffer_size=1.501 GB, available_memory=35.242 GB)
result[(3, 4, 0, 0), 1] = ModuleProfileResult(compute_cost=0.060, peak_memory=6.309 GB, invar_size=0.756 GB, outvar_size=0.355 GB, temp_buffer_size=5.506 GB, available_memory=35.242 GB)
result[(5, 6, 0, 0), 0] = ModuleProfileResult(compute_cost=0.021, peak_memory=1.996 GB, invar_size=0.355 GB, outvar_size=0.094 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(3, 5, 0, 0), 1] = ModuleProfileResult(compute_cost=0.086, peak_memory=7.346 GB, invar_size=0.856 GB, outvar_size=0.381 GB, temp_buffer_size=6.444 GB, available_memory=35.242 GB)
result[(5, 6, 0, 1), 0] = ModuleProfileResult(compute_cost=0.021, peak_memory=1.996 GB, invar_size=0.355 GB, outvar_size=0.094 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(4, 5, 0, 0), 1] = ModuleProfileResult(compute_cost=0.060, peak_memory=6.213 GB, invar_size=0.756 GB, outvar_size=0.355 GB, temp_buffer_size=5.410 GB, available_memory=35.242 GB)
result[(6, 7, 0, 0), 0] = ModuleProfileResult(compute_cost=0.012, peak_memory=1.923 GB, invar_size=0.328 GB, outvar_size=0.047 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(6, 7, 0, 1), 0] = ModuleProfileResult(compute_cost=0.012, peak_memory=1.923 GB, invar_size=0.328 GB, outvar_size=0.047 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(4, 5, 0, 1), 1] = ModuleProfileResult(compute_cost=0.060, peak_memory=6.213 GB, invar_size=0.756 GB, outvar_size=0.355 GB, temp_buffer_size=5.410 GB, available_memory=35.242 GB)
result[(5, 6, 0, 0), 1] = ModuleProfileResult(compute_cost=0.060, peak_memory=6.262 GB, invar_size=0.756 GB, outvar_size=0.355 GB, temp_buffer_size=5.459 GB, available_memory=35.242 GB)
result[(3, 5, 0, 1), 1] = ModuleProfileResult(compute_cost=0.086, peak_memory=7.346 GB, invar_size=0.856 GB, outvar_size=0.381 GB, temp_buffer_size=6.444 GB, available_memory=35.242 GB)
result[(6, 7, 0, 0), 1] = ModuleProfileResult(compute_cost=0.089, peak_memory=7.827 GB, invar_size=0.792 GB, outvar_size=0.396 GB, temp_buffer_size=6.988 GB, available_memory=35.242 GB)
result[(6, 7, 0, 1), 1] = ModuleProfileResult(compute_cost=0.089, peak_memory=7.827 GB, invar_size=0.792 GB, outvar_size=0.396 GB, temp_buffer_size=6.988 GB, available_memory=35.242 GB)
result[(5, 6, 0, 1), 1] = ModuleProfileResult(compute_cost=0.060, peak_memory=6.262 GB, invar_size=0.756 GB, outvar_size=0.355 GB, temp_buffer_size=5.459 GB, available_memory=35.242 GB)
Profiling for submesh 0 (1, 1) takes 17.44 seconds
--------------------------------------------------
----------------------------------------------------------------------
Result forward_stage_layer_ids: [[0, 1], [2, 3, 4, 5], [6, 7]]
Result mesh_shapes: [(1, 1), (1, 2), (1, 1)]
Result logical_mesh_shapes: [(1, 1), (2, 1), (1, 1)]
Result autosharding_option_dicts: [{}, {'force_batch_dim_to_mesh_dim': 0}, {}]
 - Compile (driver): 142.63 s
compilation time breakdown: {'stage-construction': '119.41', 'stage-construction-dp': '1.39', 'stage-construction-compilation': '50.72', 'stage-construction-profiling': '33.06'}
 - Compile (worker): 9.76 s
[I] Training process warmup (2 rounds) with dummy input batch...
    - Warmup iteration: 1/2
    - Warmup iteration: 2/2
[I] Ready to perform training process.
[I] Benchmark the training process with entire dataset and profile with driver overhead...
    - Iteration 1 / 5 is performed...
    - Iteration 2 / 5 is performed...
    - Iteration 3 / 5 is performed...
    - Iteration 4 / 5 is performed...
 - Benchmark: 54.88 s

[11.398616075515747, 6.862389326095581, 6.904036521911621, 6.841710329055786, 6.540846824645996, 6.701834440231323, 6.839282274246216]


[I] Performance metrics:
 - Iteration count: 5.
 - Total e2e training time : 34.999 s.
 - Average e2e iteration time: 7.000000476837158 s.
 - Total local training time: 33.8280029296875 s.
 - Average local iteration time: 6.766000270843506 s.
 - Max allocated memory among devices: 9.937 GB.
 - Compilation times:  {'stage-construction': 119.40537595748901, 'stage-construction-dp': 1.3894495964050293, 'stage-construction-compilation': 50.72225093841553, 'stage-construction-profiling': 33.05749869346619}
 - Metadata:  []
 - Is need save result:  True

[TMP] Current profiling results of key `2_a40_2_n_2_d`: 6.765542030334473
[TMP] Updated profiling results stored in `./jaxpr/prof_log/optimal/moe_690M_512.pkl`...

------------------------------------------------------------------
- (3/3) Profiling moe_690M with batch size: 1024...
------------------------------------------------------------------
[TMP] Existed profiling results in `./jaxpr/prof_log/optimal/moe_690M_1024.pkl`, updating/rewriting it...
[I] Ray Cluster & Alpa backend initialization is completed.
[I] Device Info:
    - Devices num per node: 2
    - Nodes num: 2
[I] Loading flax model....
[I] Model 'moe' loads sucessfully. Model Info: 

FlaxMoEForLMModule(
    # attributes
    config = <model.moe_model.MoEConfig object at 0x7feb868ce640>
    dtype = float16
    bias_init = zeros
) 

[I] Manually constructing dummy batch...
[I] Initialize training state...
[I] Training state initialization is completed.
[I] Constructing Alpa parallelized train step func...
[I] Alpa parallelized train step func construction is completed.
-------------------- Automatic stage clustering --------------------
submesh_choices: ((1, 1), (1, 2), (2, 2))
- Profiling for submesh 2 (2, 2):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(0, 7, 2, 1), 0] = ModuleProfileResult(compute_cost=0.070, peak_memory=1.889 GB, invar_size=0.670 GB, outvar_size=0.164 GB, temp_buffer_size=1.055 GB, available_memory=35.242 GB)
result[(0, 7, 2, 0), 0] = ModuleProfileResult(compute_cost=0.045, peak_memory=2.428 GB, invar_size=1.256 GB, outvar_size=0.164 GB, temp_buffer_size=1.008 GB, available_memory=35.242 GB)
result[(0, 7, 2, 0), 1] = ModuleProfileResult(compute_cost=0.219, peak_memory=6.329 GB, invar_size=2.812 GB, outvar_size=1.324 GB, temp_buffer_size=3.517 GB, available_memory=35.242 GB)
result[(0, 7, 2, 2), 0] = ModuleProfileResult(compute_cost=0.109, peak_memory=1.584 GB, invar_size=0.412 GB, outvar_size=0.164 GB, temp_buffer_size=1.008 GB, available_memory=35.242 GB)
result[(0, 7, 2, 1), 1] = ModuleProfileResult(compute_cost=0.259, peak_memory=5.135 GB, invar_size=1.594 GB, outvar_size=0.715 GB, temp_buffer_size=3.541 GB, available_memory=35.242 GB)
result[(0, 7, 2, 2), 1] = ModuleProfileResult(compute_cost=0.286, peak_memory=4.642 GB, invar_size=1.124 GB, outvar_size=0.480 GB, temp_buffer_size=3.517 GB, available_memory=35.242 GB)
Profiling for submesh 2 (2, 2) takes 45.42 seconds
--------------------------------------------------
- Profiling for submesh 1 (1, 2):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(0, 3, 1, 2), 0] = ModuleProfileResult(compute_cost=0.073, peak_memory=2.589 GB, invar_size=0.386 GB, outvar_size=0.188 GB, temp_buffer_size=2.016 GB, available_memory=35.242 GB)
result[(1, 3, 1, 0), 0] = ModuleProfileResult(compute_cost=0.041, peak_memory=2.304 GB, invar_size=0.662 GB, outvar_size=0.141 GB, temp_buffer_size=1.501 GB, available_memory=35.242 GB)
result[(0, 3, 1, 1), 0] = ModuleProfileResult(compute_cost=0.186, peak_memory=2.616 GB, invar_size=0.334 GB, outvar_size=0.328 GB, temp_buffer_size=1.953 GB, available_memory=35.242 GB)
result[(1, 3, 1, 1), 0] = ModuleProfileResult(compute_cost=0.144, peak_memory=2.138 GB, invar_size=0.402 GB, outvar_size=0.234 GB, temp_buffer_size=1.502 GB, available_memory=35.242 GB)
result[(0, 2, 1, 0), 0] = ModuleProfileResult(compute_cost=0.046, peak_memory=2.797 GB, invar_size=0.641 GB, outvar_size=0.141 GB, temp_buffer_size=2.016 GB, available_memory=35.242 GB)
result[(0, 2, 1, 2), 0] = ModuleProfileResult(compute_cost=0.064, peak_memory=2.516 GB, invar_size=0.360 GB, outvar_size=0.141 GB, temp_buffer_size=2.016 GB, available_memory=35.242 GB)
result[(0, 2, 1, 1), 0] = ModuleProfileResult(compute_cost=0.136, peak_memory=2.509 GB, invar_size=0.321 GB, outvar_size=0.234 GB, temp_buffer_size=1.953 GB, available_memory=35.242 GB)
result[(0, 3, 1, 0), 0] = ModuleProfileResult(compute_cost=0.055, peak_memory=2.870 GB, invar_size=0.667 GB, outvar_size=0.188 GB, temp_buffer_size=2.016 GB, available_memory=35.242 GB)
result[(1, 3, 1, 0), 1] = ModuleProfileResult(compute_cost=0.124, peak_memory=7.283 GB, invar_size=1.418 GB, outvar_size=0.662 GB, temp_buffer_size=5.818 GB, available_memory=35.242 GB)
result[(0, 3, 1, 1), 1] = ModuleProfileResult(compute_cost=0.378, peak_memory=7.806 GB, invar_size=1.043 GB, outvar_size=0.334 GB, temp_buffer_size=6.763 GB, available_memory=35.242 GB)
result[(0, 2, 1, 0), 1] = ModuleProfileResult(compute_cost=0.129, peak_memory=7.240 GB, invar_size=1.422 GB, outvar_size=0.641 GB, temp_buffer_size=5.818 GB, available_memory=35.242 GB)
result[(0, 2, 1, 2), 1] = ModuleProfileResult(compute_cost=0.151, peak_memory=6.727 GB, invar_size=0.907 GB, outvar_size=0.359 GB, temp_buffer_size=5.820 GB, available_memory=35.242 GB)
result[(0, 2, 1, 1), 1] = ModuleProfileResult(compute_cost=0.282, peak_memory=6.931 GB, invar_size=0.923 GB, outvar_size=0.320 GB, temp_buffer_size=6.008 GB, available_memory=35.242 GB)
result[(0, 3, 1, 0), 1] = ModuleProfileResult(compute_cost=0.155, peak_memory=7.387 GB, invar_size=1.522 GB, outvar_size=0.667 GB, temp_buffer_size=5.865 GB, available_memory=35.242 GB)
result[(1, 3, 1, 2), 0] = ModuleProfileResult(compute_cost=0.055, peak_memory=2.319 GB, invar_size=0.428 GB, outvar_size=0.141 GB, temp_buffer_size=1.750 GB, available_memory=35.242 GB)
result[(0, 3, 1, 2), 1] = ModuleProfileResult(compute_cost=0.181, peak_memory=6.967 GB, invar_size=1.006 GB, outvar_size=0.386 GB, temp_buffer_size=5.961 GB, available_memory=35.242 GB)
result[(1, 4, 1, 0), 0] = ModuleProfileResult(compute_cost=0.053, peak_memory=2.679 GB, invar_size=0.944 GB, outvar_size=0.188 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(1, 4, 1, 1), 0] = ModuleProfileResult(compute_cost=0.171, peak_memory=2.466 GB, invar_size=0.542 GB, outvar_size=0.328 GB, temp_buffer_size=1.596 GB, available_memory=35.242 GB)
result[(1, 4, 1, 2), 0] = ModuleProfileResult(compute_cost=0.076, peak_memory=2.305 GB, invar_size=0.569 GB, outvar_size=0.188 GB, temp_buffer_size=1.549 GB, available_memory=35.242 GB)
result[(1, 3, 1, 1), 1] = ModuleProfileResult(compute_cost=0.307, peak_memory=7.798 GB, invar_size=0.991 GB, outvar_size=0.355 GB, temp_buffer_size=6.761 GB, available_memory=35.242 GB)
result[(1, 3, 1, 2), 1] = ModuleProfileResult(compute_cost=0.146, peak_memory=6.910 GB, invar_size=0.950 GB, outvar_size=0.381 GB, temp_buffer_size=5.914 GB, available_memory=35.242 GB)
result[(1, 5, 1, 0), 0] = ModuleProfileResult(compute_cost=0.062, peak_memory=2.705 GB, invar_size=0.970 GB, outvar_size=0.234 GB, temp_buffer_size=1.501 GB, available_memory=35.242 GB)
result[(1, 5, 1, 1), 0] = ModuleProfileResult(compute_cost=0.222, peak_memory=2.573 GB, invar_size=0.556 GB, outvar_size=0.422 GB, temp_buffer_size=1.596 GB, available_memory=35.242 GB)
result[(1, 5, 1, 2), 0] = ModuleProfileResult(compute_cost=0.085, peak_memory=2.331 GB, invar_size=0.595 GB, outvar_size=0.234 GB, temp_buffer_size=1.502 GB, available_memory=35.242 GB)
result[(2, 5, 1, 0), 0] = ModuleProfileResult(compute_cost=0.048, peak_memory=2.373 GB, invar_size=0.684 GB, outvar_size=0.188 GB, temp_buffer_size=1.501 GB, available_memory=35.242 GB)
result[(1, 4, 1, 0), 1] = ModuleProfileResult(compute_cost=0.161, peak_memory=7.893 GB, invar_size=2.028 GB, outvar_size=0.944 GB, temp_buffer_size=5.818 GB, available_memory=35.242 GB)
result[(1, 4, 1, 1), 1] = ModuleProfileResult(compute_cost=0.369, peak_memory=8.271 GB, invar_size=1.366 GB, outvar_size=0.495 GB, temp_buffer_size=6.859 GB, available_memory=35.242 GB)
result[(2, 5, 1, 1), 0] = ModuleProfileResult(compute_cost=0.180, peak_memory=2.337 GB, invar_size=0.413 GB, outvar_size=0.328 GB, temp_buffer_size=1.596 GB, available_memory=35.242 GB)
result[(2, 5, 1, 2), 0] = ModuleProfileResult(compute_cost=0.066, peak_memory=2.093 GB, invar_size=0.403 GB, outvar_size=0.188 GB, temp_buffer_size=1.502 GB, available_memory=35.242 GB)
result[(1, 4, 1, 2), 1] = ModuleProfileResult(compute_cost=0.198, peak_memory=7.243 GB, invar_size=1.231 GB, outvar_size=0.522 GB, temp_buffer_size=5.965 GB, available_memory=35.242 GB)
result[(2, 5, 1, 0), 1] = ModuleProfileResult(compute_cost=0.144, peak_memory=7.374 GB, invar_size=1.509 GB, outvar_size=0.684 GB, temp_buffer_size=5.818 GB, available_memory=35.242 GB)
result[(2, 6, 1, 0), 0] = ModuleProfileResult(compute_cost=0.060, peak_memory=2.748 GB, invar_size=0.966 GB, outvar_size=0.234 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(2, 5, 1, 1), 1] = ModuleProfileResult(compute_cost=0.383, peak_memory=8.715 GB, invar_size=1.106 GB, outvar_size=0.412 GB, temp_buffer_size=7.515 GB, available_memory=35.242 GB)
result[(1, 5, 1, 0), 1] = ModuleProfileResult(compute_cost=0.187, peak_memory=7.992 GB, invar_size=2.127 GB, outvar_size=0.970 GB, temp_buffer_size=5.818 GB, available_memory=35.242 GB)
result[(1, 5, 1, 1), 1] = ModuleProfileResult(compute_cost=0.466, peak_memory=9.141 GB, invar_size=1.486 GB, outvar_size=0.508 GB, temp_buffer_size=7.609 GB, available_memory=35.242 GB)
result[(3, 6, 1, 0), 0] = ModuleProfileResult(compute_cost=0.041, peak_memory=2.398 GB, invar_size=0.662 GB, outvar_size=0.188 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(2, 6, 1, 1), 0] = ModuleProfileResult(compute_cost=0.207, peak_memory=2.571 GB, invar_size=0.553 GB, outvar_size=0.422 GB, temp_buffer_size=1.596 GB, available_memory=35.242 GB)
result[(1, 5, 1, 2), 1] = ModuleProfileResult(compute_cost=0.224, peak_memory=7.389 GB, invar_size=1.377 GB, outvar_size=0.548 GB, temp_buffer_size=5.965 GB, available_memory=35.242 GB)
result[(2, 6, 1, 2), 0] = ModuleProfileResult(compute_cost=0.087, peak_memory=2.327 GB, invar_size=0.544 GB, outvar_size=0.234 GB, temp_buffer_size=1.549 GB, available_memory=35.242 GB)
result[(2, 5, 1, 2), 1] = ModuleProfileResult(compute_cost=0.170, peak_memory=7.005 GB, invar_size=0.994 GB, outvar_size=0.403 GB, temp_buffer_size=5.965 GB, available_memory=35.242 GB)
result[(3, 6, 1, 1), 0] = ModuleProfileResult(compute_cost=0.146, peak_memory=2.326 GB, invar_size=0.402 GB, outvar_size=0.328 GB, temp_buffer_size=1.596 GB, available_memory=35.242 GB)
result[(3, 6, 1, 2), 0] = ModuleProfileResult(compute_cost=0.059, peak_memory=2.116 GB, invar_size=0.381 GB, outvar_size=0.188 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(3, 7, 1, 0), 0] = ModuleProfileResult(compute_cost=0.041, peak_memory=2.398 GB, invar_size=0.662 GB, outvar_size=0.188 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(3, 7, 1, 1), 0] = ModuleProfileResult(compute_cost=0.146, peak_memory=2.326 GB, invar_size=0.402 GB, outvar_size=0.328 GB, temp_buffer_size=1.596 GB, available_memory=35.242 GB)
result[(3, 7, 1, 2), 0] = ModuleProfileResult(compute_cost=0.059, peak_memory=2.116 GB, invar_size=0.381 GB, outvar_size=0.188 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(3, 6, 1, 0), 1] = ModuleProfileResult(compute_cost=0.126, peak_memory=7.016 GB, invar_size=1.465 GB, outvar_size=0.662 GB, temp_buffer_size=5.504 GB, available_memory=35.242 GB)
result[(2, 6, 1, 0), 1] = ModuleProfileResult(compute_cost=0.181, peak_memory=7.984 GB, invar_size=2.119 GB, outvar_size=0.965 GB, temp_buffer_size=5.818 GB, available_memory=35.242 GB)
result[(2, 6, 1, 1), 1] = ModuleProfileResult(compute_cost=0.445, peak_memory=9.189 GB, invar_size=1.481 GB, outvar_size=0.553 GB, temp_buffer_size=7.613 GB, available_memory=35.242 GB)
result[(4, 7, 1, 0), 0] = ModuleProfileResult(compute_cost=0.032, peak_memory=2.324 GB, invar_size=0.636 GB, outvar_size=0.141 GB, temp_buffer_size=1.548 GB, available_memory=35.242 GB)
result[(3, 6, 1, 1), 1] = ModuleProfileResult(compute_cost=0.317, peak_memory=7.533 GB, invar_size=1.084 GB, outvar_size=0.401 GB, temp_buffer_size=6.354 GB, available_memory=35.242 GB)
result[(4, 7, 1, 1), 0] = ModuleProfileResult(compute_cost=0.095, peak_memory=2.219 GB, invar_size=0.388 GB, outvar_size=0.234 GB, temp_buffer_size=1.596 GB, available_memory=35.242 GB)
result[(3, 6, 1, 2), 1] = ModuleProfileResult(compute_cost=0.156, peak_memory=6.453 GB, invar_size=0.903 GB, outvar_size=0.381 GB, temp_buffer_size=5.504 GB, available_memory=35.242 GB)
result[(2, 6, 1, 2), 1] = ModuleProfileResult(compute_cost=0.222, peak_memory=7.338 GB, invar_size=1.275 GB, outvar_size=0.544 GB, temp_buffer_size=6.016 GB, available_memory=35.242 GB)
result[(4, 7, 1, 2), 0] = ModuleProfileResult(compute_cost=0.047, peak_memory=2.138 GB, invar_size=0.402 GB, outvar_size=0.141 GB, temp_buffer_size=1.596 GB, available_memory=35.242 GB)
result[(3, 7, 1, 1), 1] = ModuleProfileResult(compute_cost=0.447, peak_memory=8.425 GB, invar_size=1.106 GB, outvar_size=0.435 GB, temp_buffer_size=7.226 GB, available_memory=35.242 GB)
result[(4, 7, 1, 0), 1] = ModuleProfileResult(compute_cost=0.155, peak_memory=8.536 GB, invar_size=1.501 GB, outvar_size=0.704 GB, temp_buffer_size=6.988 GB, available_memory=35.242 GB)
result[(3, 7, 1, 2), 1] = ModuleProfileResult(compute_cost=0.211, peak_memory=8.073 GB, invar_size=1.038 GB, outvar_size=0.449 GB, temp_buffer_size=6.988 GB, available_memory=35.242 GB)
result[(3, 7, 1, 0), 1] = ModuleProfileResult(compute_cost=0.181, peak_memory=8.636 GB, invar_size=1.601 GB, outvar_size=0.730 GB, temp_buffer_size=6.988 GB, available_memory=35.242 GB)
result[(4, 7, 1, 1), 1] = ModuleProfileResult(compute_cost=0.337, peak_memory=8.350 GB, invar_size=0.985 GB, outvar_size=0.375 GB, temp_buffer_size=7.318 GB, available_memory=35.242 GB)
result[(4, 7, 1, 2), 1] = ModuleProfileResult(compute_cost=0.181, peak_memory=8.021 GB, invar_size=0.986 GB, outvar_size=0.422 GB, temp_buffer_size=6.988 GB, available_memory=35.242 GB)
Profiling for submesh 1 (1, 2) takes 52.16 seconds
--------------------------------------------------
- Profiling for submesh 0 (1, 1):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(0, 1, 0, 0), 0] = ModuleProfileResult(compute_cost=0.055, peak_memory=4.557 GB, invar_size=0.338 GB, outvar_size=0.188 GB, temp_buffer_size=4.031 GB, available_memory=35.242 GB)
result[(0, 1, 0, 1), 0] = ModuleProfileResult(compute_cost=0.055, peak_memory=4.557 GB, invar_size=0.338 GB, outvar_size=0.188 GB, temp_buffer_size=4.031 GB, available_memory=35.242 GB)
result[(3, 4, 0, 1), 0] = ModuleProfileResult(compute_cost=0.040, peak_memory=3.685 GB, invar_size=0.402 GB, outvar_size=0.188 GB, temp_buffer_size=3.096 GB, available_memory=35.242 GB)
result[(2, 3, 0, 0), 0] = ModuleProfileResult(compute_cost=0.053, peak_memory=3.613 GB, invar_size=0.424 GB, outvar_size=0.188 GB, temp_buffer_size=3.002 GB, available_memory=35.242 GB)
result[(3, 4, 0, 0), 0] = ModuleProfileResult(compute_cost=0.040, peak_memory=3.685 GB, invar_size=0.402 GB, outvar_size=0.188 GB, temp_buffer_size=3.096 GB, available_memory=35.242 GB)
result[(3, 4, 0, 1), 1] = ModuleProfileResult(compute_cost=0.117, peak_memory=12.001 GB, invar_size=0.897 GB, outvar_size=0.401 GB, temp_buffer_size=11.010 GB, available_memory=35.242 GB)
result[(2, 3, 0, 1), 0] = ModuleProfileResult(compute_cost=0.053, peak_memory=3.613 GB, invar_size=0.424 GB, outvar_size=0.188 GB, temp_buffer_size=3.002 GB, available_memory=35.242 GB)
result[(3, 5, 0, 0), 0] = ModuleProfileResult(compute_cost=0.057, peak_memory=3.711 GB, invar_size=0.428 GB, outvar_size=0.281 GB, temp_buffer_size=3.002 GB, available_memory=35.242 GB)
result[(0, 1, 0, 1), 1] = ModuleProfileResult(compute_cost=0.139, peak_memory=10.280 GB, invar_size=0.863 GB, outvar_size=0.337 GB, temp_buffer_size=9.417 GB, available_memory=35.242 GB)
result[(0, 1, 0, 0), 1] = ModuleProfileResult(compute_cost=0.139, peak_memory=10.280 GB, invar_size=0.863 GB, outvar_size=0.337 GB, temp_buffer_size=9.417 GB, available_memory=35.242 GB)
result[(3, 4, 0, 0), 1] = ModuleProfileResult(compute_cost=0.117, peak_memory=12.001 GB, invar_size=0.897 GB, outvar_size=0.401 GB, temp_buffer_size=11.010 GB, available_memory=35.242 GB)
result[(2, 3, 0, 0), 1] = ModuleProfileResult(compute_cost=0.152, peak_memory=14.171 GB, invar_size=0.941 GB, outvar_size=0.423 GB, temp_buffer_size=13.137 GB, available_memory=35.242 GB)
result[(4, 5, 0, 0), 0] = ModuleProfileResult(compute_cost=0.040, peak_memory=3.591 GB, invar_size=0.402 GB, outvar_size=0.188 GB, temp_buffer_size=3.002 GB, available_memory=35.242 GB)
result[(2, 3, 0, 1), 1] = ModuleProfileResult(compute_cost=0.152, peak_memory=14.171 GB, invar_size=0.941 GB, outvar_size=0.423 GB, temp_buffer_size=13.137 GB, available_memory=35.242 GB)
result[(3, 5, 0, 1), 0] = ModuleProfileResult(compute_cost=0.057, peak_memory=3.711 GB, invar_size=0.428 GB, outvar_size=0.281 GB, temp_buffer_size=3.002 GB, available_memory=35.242 GB)
result[(4, 5, 0, 1), 0] = ModuleProfileResult(compute_cost=0.040, peak_memory=3.591 GB, invar_size=0.402 GB, outvar_size=0.188 GB, temp_buffer_size=3.002 GB, available_memory=35.242 GB)
result[(5, 6, 0, 0), 0] = ModuleProfileResult(compute_cost=0.040, peak_memory=3.685 GB, invar_size=0.402 GB, outvar_size=0.188 GB, temp_buffer_size=3.096 GB, available_memory=35.242 GB)
result[(3, 5, 0, 0), 1] = ModuleProfileResult(compute_cost=0.166, peak_memory=14.023 GB, invar_size=1.043 GB, outvar_size=0.428 GB, temp_buffer_size=12.886 GB, available_memory=35.242 GB)
result[(5, 6, 0, 1), 0] = ModuleProfileResult(compute_cost=0.040, peak_memory=3.685 GB, invar_size=0.402 GB, outvar_size=0.188 GB, temp_buffer_size=3.096 GB, available_memory=35.242 GB)
result[(4, 5, 0, 0), 1] = ModuleProfileResult(compute_cost=0.117, peak_memory=11.810 GB, invar_size=0.897 GB, outvar_size=0.401 GB, temp_buffer_size=10.819 GB, available_memory=35.242 GB)
result[(6, 7, 0, 0), 0] = ModuleProfileResult(compute_cost=0.024, peak_memory=3.564 GB, invar_size=0.375 GB, outvar_size=0.094 GB, temp_buffer_size=3.096 GB, available_memory=35.242 GB)
result[(4, 5, 0, 1), 1] = ModuleProfileResult(compute_cost=0.117, peak_memory=11.810 GB, invar_size=0.897 GB, outvar_size=0.401 GB, temp_buffer_size=10.819 GB, available_memory=35.242 GB)
result[(6, 7, 0, 1), 0] = ModuleProfileResult(compute_cost=0.024, peak_memory=3.564 GB, invar_size=0.375 GB, outvar_size=0.094 GB, temp_buffer_size=3.096 GB, available_memory=35.242 GB)
result[(5, 6, 0, 0), 1] = ModuleProfileResult(compute_cost=0.117, peak_memory=11.907 GB, invar_size=0.897 GB, outvar_size=0.401 GB, temp_buffer_size=10.916 GB, available_memory=35.242 GB)
result[(5, 6, 0, 1), 1] = ModuleProfileResult(compute_cost=0.117, peak_memory=11.907 GB, invar_size=0.897 GB, outvar_size=0.401 GB, temp_buffer_size=10.916 GB, available_memory=35.242 GB)
result[(3, 5, 0, 1), 1] = ModuleProfileResult(compute_cost=0.166, peak_memory=14.023 GB, invar_size=1.043 GB, outvar_size=0.428 GB, temp_buffer_size=12.886 GB, available_memory=35.242 GB)
result[(6, 7, 0, 0), 1] = ModuleProfileResult(compute_cost=0.175, peak_memory=14.956 GB, invar_size=0.886 GB, outvar_size=0.443 GB, temp_buffer_size=13.976 GB, available_memory=35.242 GB)
result[(6, 7, 0, 1), 1] = ModuleProfileResult(compute_cost=0.175, peak_memory=14.956 GB, invar_size=0.886 GB, outvar_size=0.443 GB, temp_buffer_size=13.976 GB, available_memory=35.242 GB)
Profiling for submesh 0 (1, 1) takes 17.46 seconds
--------------------------------------------------
----------------------------------------------------------------------
Result forward_stage_layer_ids: [[0, 1, 2, 3], [4, 5, 6, 7]]
Result mesh_shapes: [(1, 2), (1, 2)]
Result logical_mesh_shapes: [(2, 1), (2, 1)]
Result autosharding_option_dicts: [{'force_batch_dim_to_mesh_dim': 0}, {'force_batch_dim_to_mesh_dim': 0}]
 - Compile (driver): 144.13 s
compilation time breakdown: {'stage-construction': '117.65', 'stage-construction-dp': '1.39', 'stage-construction-compilation': '48.91', 'stage-construction-profiling': '32.49'}
 - Compile (worker): 8.98 s
[I] Training process warmup (2 rounds) with dummy input batch...
    - Warmup iteration: 1/2
    - Warmup iteration: 2/2
[I] Ready to perform training process.
[I] Benchmark the training process with entire dataset and profile with driver overhead...
    - Iteration 1 / 5 is performed...
    - Iteration 2 / 5 is performed...
    - Iteration 3 / 5 is performed...
    - Iteration 4 / 5 is performed...
 - Benchmark: 82.13 s

[15.612112998962402, 10.21189022064209, 10.376355648040771, 10.14173698425293, 10.23136830329895, 10.03790283203125, 10.241304159164429]


[I] Performance metrics:
 - Iteration count: 5.
 - Total e2e training time : 53.912 s.
 - Average e2e iteration time: 10.782000541687012 s.
 - Total local training time: 51.02900314331055 s.
 - Average local iteration time: 10.206000328063965 s.
 - Max allocated memory among devices: 12.011 GB.
 - Compilation times:  {'stage-construction': 117.64633965492249, 'stage-construction-dp': 1.392521619796753, 'stage-construction-compilation': 48.91492319107056, 'stage-construction-profiling': 32.494248151779175}
 - Metadata:  []
 - Is need save result:  True

[TMP] Current profiling results of key `2_a40_2_n_2_d`: 10.205734252929688
[TMP] Updated profiling results stored in `./jaxpr/prof_log/optimal/moe_690M_1024.pkl`...
