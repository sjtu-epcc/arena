
------------------------------------------------------------------
- (1/3) Profiling bert_1.3B with batch size: 128...
------------------------------------------------------------------
[TMP] Existed profiling results in `./jaxpr/prof_log/optimal/bert_1.3B_128.pkl`, updating/rewriting it...
[I] Ray Cluster & Alpa backend initialization is completed.
[I] Device Info:
    - Devices num per node: 2
    - Nodes num: 2
[I] Loading flax model....
[I] Model 'bert' loads sucessfully. Model Info: 

FlaxBertForMaskedLMModule(
    # attributes
    config = <model.bert_model.BertConfig object at 0x7f0b0edeea60>
    dtype = float16
) 

[I] Manually constructing dummy batch...
[I] Initialize training state...
[I] Training state initialization is completed.
[I] Constructing Alpa parallelized train step func...
[I] Alpa parallelized train step func construction is completed.
-------------------- Automatic stage clustering --------------------
submesh_choices: ((1, 1), (1, 2), (2, 2))
- Profiling for submesh 2 (2, 2):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(0, 5, 2, 0), 0] = ModuleProfileResult(compute_cost=0.043, peak_memory=2.339 GB, invar_size=2.105 GB, outvar_size=0.039 GB, temp_buffer_size=0.195 GB, available_memory=35.242 GB)
result[(0, 5, 2, 1), 0] = ModuleProfileResult(compute_cost=0.140, peak_memory=1.318 GB, invar_size=1.053 GB, outvar_size=0.070 GB, temp_buffer_size=0.195 GB, available_memory=35.242 GB)
result[(0, 5, 2, 2), 0] = ModuleProfileResult(compute_cost=0.068, peak_memory=2.222 GB, invar_size=1.957 GB, outvar_size=0.039 GB, temp_buffer_size=0.227 GB, available_memory=35.242 GB)
result[(0, 5, 2, 0), 1] = ModuleProfileResult(compute_cost=0.289, peak_memory=7.994 GB, invar_size=5.342 GB, outvar_size=2.652 GB, temp_buffer_size=2.652 GB, available_memory=35.242 GB)
result[(0, 5, 2, 1), 1] = ModuleProfileResult(compute_cost=0.491, peak_memory=4.662 GB, invar_size=2.723 GB, outvar_size=1.326 GB, temp_buffer_size=1.939 GB, available_memory=35.242 GB)
result[(0, 5, 2, 2), 1] = ModuleProfileResult(compute_cost=0.328, peak_memory=7.218 GB, invar_size=4.754 GB, outvar_size=2.357 GB, temp_buffer_size=2.464 GB, available_memory=35.242 GB)
Profiling for submesh 2 (2, 2) takes 129.84 seconds
--------------------------------------------------
- Profiling for submesh 1 (1, 2):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(1, 3, 1, 1), 0] = ModuleProfileResult(compute_cost=0.161, peak_memory=1.001 GB, invar_size=0.610 GB, outvar_size=0.078 GB, temp_buffer_size=0.313 GB, available_memory=35.242 GB)
result[(1, 3, 1, 0), 0] = ModuleProfileResult(compute_cost=0.045, peak_memory=1.516 GB, invar_size=1.173 GB, outvar_size=0.047 GB, temp_buffer_size=0.297 GB, available_memory=35.242 GB)
result[(0, 2, 1, 0), 0] = ModuleProfileResult(compute_cost=0.051, peak_memory=1.792 GB, invar_size=1.354 GB, outvar_size=0.047 GB, temp_buffer_size=0.391 GB, available_memory=35.242 GB)
result[(0, 2, 1, 1), 0] = ModuleProfileResult(compute_cost=0.172, peak_memory=1.146 GB, invar_size=0.677 GB, outvar_size=0.078 GB, temp_buffer_size=0.391 GB, available_memory=35.242 GB)
result[(1, 3, 1, 2), 0] = ModuleProfileResult(compute_cost=0.045, peak_memory=1.516 GB, invar_size=1.173 GB, outvar_size=0.047 GB, temp_buffer_size=0.297 GB, available_memory=35.242 GB)
result[(0, 2, 1, 2), 0] = ModuleProfileResult(compute_cost=0.056, peak_memory=1.724 GB, invar_size=1.256 GB, outvar_size=0.047 GB, temp_buffer_size=0.422 GB, available_memory=35.242 GB)
result[(2, 4, 1, 0), 0] = ModuleProfileResult(compute_cost=0.045, peak_memory=1.516 GB, invar_size=1.173 GB, outvar_size=0.047 GB, temp_buffer_size=0.297 GB, available_memory=35.242 GB)
result[(2, 4, 1, 1), 0] = ModuleProfileResult(compute_cost=0.161, peak_memory=1.001 GB, invar_size=0.610 GB, outvar_size=0.078 GB, temp_buffer_size=0.313 GB, available_memory=35.242 GB)
result[(2, 4, 1, 2), 0] = ModuleProfileResult(compute_cost=0.045, peak_memory=1.516 GB, invar_size=1.173 GB, outvar_size=0.047 GB, temp_buffer_size=0.297 GB, available_memory=35.242 GB)
result[(3, 5, 1, 0), 0] = ModuleProfileResult(compute_cost=0.029, peak_memory=1.094 GB, invar_size=0.766 GB, outvar_size=0.031 GB, temp_buffer_size=0.297 GB, available_memory=35.242 GB)
result[(3, 5, 1, 1), 0] = ModuleProfileResult(compute_cost=0.105, peak_memory=0.782 GB, invar_size=0.407 GB, outvar_size=0.062 GB, temp_buffer_size=0.313 GB, available_memory=35.242 GB)
result[(1, 3, 1, 2), 1] = ModuleProfileResult(compute_cost=0.144, peak_memory=6.005 GB, invar_size=2.376 GB, outvar_size=1.173 GB, temp_buffer_size=3.613 GB, available_memory=35.242 GB)
result[(0, 2, 1, 0), 1] = ModuleProfileResult(compute_cost=0.158, peak_memory=6.368 GB, invar_size=2.755 GB, outvar_size=1.354 GB, temp_buffer_size=3.613 GB, available_memory=35.242 GB)
result[(0, 2, 1, 1), 1] = ModuleProfileResult(compute_cost=0.378, peak_memory=5.642 GB, invar_size=1.448 GB, outvar_size=0.677 GB, temp_buffer_size=4.194 GB, available_memory=35.242 GB)
result[(1, 3, 1, 0), 1] = ModuleProfileResult(compute_cost=0.144, peak_memory=6.005 GB, invar_size=2.376 GB, outvar_size=1.173 GB, temp_buffer_size=3.613 GB, available_memory=35.242 GB)
result[(1, 3, 1, 1), 1] = ModuleProfileResult(compute_cost=0.367, peak_memory=5.640 GB, invar_size=1.282 GB, outvar_size=0.610 GB, temp_buffer_size=4.326 GB, available_memory=35.242 GB)
result[(3, 5, 1, 2), 0] = ModuleProfileResult(compute_cost=0.029, peak_memory=1.094 GB, invar_size=0.766 GB, outvar_size=0.031 GB, temp_buffer_size=0.297 GB, available_memory=35.242 GB)
result[(0, 2, 1, 2), 1] = ModuleProfileResult(compute_cost=0.162, peak_memory=6.202 GB, invar_size=2.574 GB, outvar_size=1.256 GB, temp_buffer_size=3.628 GB, available_memory=35.242 GB)
result[(2, 4, 1, 1), 1] = ModuleProfileResult(compute_cost=0.367, peak_memory=5.865 GB, invar_size=1.282 GB, outvar_size=0.610 GB, temp_buffer_size=4.551 GB, available_memory=35.242 GB)
result[(2, 4, 1, 0), 1] = ModuleProfileResult(compute_cost=0.144, peak_memory=6.005 GB, invar_size=2.376 GB, outvar_size=1.172 GB, temp_buffer_size=3.613 GB, available_memory=35.242 GB)
result[(2, 4, 1, 2), 1] = ModuleProfileResult(compute_cost=0.144, peak_memory=6.005 GB, invar_size=2.376 GB, outvar_size=1.172 GB, temp_buffer_size=3.613 GB, available_memory=35.242 GB)
result[(3, 5, 1, 0), 1] = ModuleProfileResult(compute_cost=0.156, peak_memory=5.863 GB, invar_size=2.642 GB, outvar_size=1.313 GB, temp_buffer_size=3.206 GB, available_memory=35.242 GB)
result[(3, 5, 1, 1), 1] = ModuleProfileResult(compute_cost=0.374, peak_memory=5.095 GB, invar_size=1.392 GB, outvar_size=0.680 GB, temp_buffer_size=3.672 GB, available_memory=35.242 GB)
result[(3, 5, 1, 2), 1] = ModuleProfileResult(compute_cost=0.161, peak_memory=5.684 GB, invar_size=2.447 GB, outvar_size=1.215 GB, temp_buffer_size=3.221 GB, available_memory=35.242 GB)
Profiling for submesh 1 (1, 2) takes 47.99 seconds
--------------------------------------------------
- Profiling for submesh 0 (1, 1):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(0, 0, 0, 1), 0] = ModuleProfileResult(compute_cost=0.039, peak_memory=1.393 GB, invar_size=0.573 GB, outvar_size=0.031 GB, temp_buffer_size=0.789 GB, available_memory=35.242 GB)
result[(0, 0, 0, 0), 0] = ModuleProfileResult(compute_cost=0.039, peak_memory=1.393 GB, invar_size=0.573 GB, outvar_size=0.031 GB, temp_buffer_size=0.789 GB, available_memory=35.242 GB)
result[(0, 0, 0, 1), 1] = ModuleProfileResult(compute_cost=0.103, peak_memory=8.128 GB, invar_size=1.176 GB, outvar_size=0.572 GB, temp_buffer_size=6.952 GB, available_memory=35.242 GB)
result[(3, 4, 0, 0), 0] = ModuleProfileResult(compute_cost=0.054, peak_memory=1.438 GB, invar_size=0.782 GB, outvar_size=0.062 GB, temp_buffer_size=0.594 GB, available_memory=35.242 GB)
result[(0, 0, 0, 0), 1] = ModuleProfileResult(compute_cost=0.103, peak_memory=8.128 GB, invar_size=1.176 GB, outvar_size=0.572 GB, temp_buffer_size=6.952 GB, available_memory=35.242 GB)
result[(3, 4, 0, 1), 0] = ModuleProfileResult(compute_cost=0.054, peak_memory=1.438 GB, invar_size=0.782 GB, outvar_size=0.062 GB, temp_buffer_size=0.594 GB, available_memory=35.242 GB)
result[(3, 4, 0, 0), 1] = ModuleProfileResult(compute_cost=0.161, peak_memory=8.859 GB, invar_size=1.595 GB, outvar_size=0.782 GB, temp_buffer_size=7.233 GB, available_memory=35.242 GB)
result[(3, 4, 0, 1), 1] = ModuleProfileResult(compute_cost=0.161, peak_memory=8.859 GB, invar_size=1.595 GB, outvar_size=0.782 GB, temp_buffer_size=7.233 GB, available_memory=35.242 GB)
Profiling for submesh 0 (1, 1) takes 13.62 seconds
--------------------------------------------------
----------------------------------------------------------------------
Result forward_stage_layer_ids: [[0, 1, 2], [3, 4, 5]]
Result mesh_shapes: [(1, 2), (1, 2)]
Result logical_mesh_shapes: [(2, 1), (2, 1)]
Result autosharding_option_dicts: [{'force_batch_dim_to_mesh_dim': 0}, {'force_batch_dim_to_mesh_dim': 0}]
 - Compile (driver): 235.74 s
compilation time breakdown: {'stage-construction': '194.90', 'stage-construction-dp': '1.38', 'stage-construction-compilation': '128.50', 'stage-construction-profiling': '35.61'}
 - Compile (worker): 9.12 s
[I] Training process warmup (2 rounds) with dummy input batch...
    - Warmup iteration: 1/2
    - Warmup iteration: 2/2
[I] Ready to perform training process.
[I] Benchmark the training process with entire dataset and profile with driver overhead...
    - Iteration 1 / 5 is performed...
    - Iteration 2 / 5 is performed...
    - Iteration 3 / 5 is performed...
    - Iteration 4 / 5 is performed...
 - Benchmark: 63.22 s

[11.945879220962524, 7.318824291229248, 7.414027452468872, 7.5340306758880615, 7.335223197937012, 7.4286346435546875, 7.5263831615448]


[I] Performance metrics:
 - Iteration count: 5.
 - Total e2e training time : 39.826 s.
 - Average e2e iteration time: 7.965000152587891 s.
 - Total local training time: 37.23800277709961 s.
 - Average local iteration time: 7.448000431060791 s.
 - Max allocated memory among devices: 10.915 GB.
 - Compilation times:  {'stage-construction': 194.90314388275146, 'stage-construction-dp': 1.3783676624298096, 'stage-construction-compilation': 128.49906396865845, 'stage-construction-profiling': 35.60810685157776}
 - Metadata:  []
 - Is need save result:  True

[TMP] Current profiling results of key `2_a40_2_n_2_d`: 7.447659969329834
[TMP] Updated profiling results stored in `./jaxpr/prof_log/optimal/bert_1.3B_128.pkl`...

------------------------------------------------------------------
- (2/3) Profiling bert_1.3B with batch size: 256...
------------------------------------------------------------------
[TMP] Existed profiling results in `./jaxpr/prof_log/optimal/bert_1.3B_256.pkl`, updating/rewriting it...
[I] Ray Cluster & Alpa backend initialization is completed.
[I] Device Info:
    - Devices num per node: 2
    - Nodes num: 2
[I] Loading flax model....
[I] Model 'bert' loads sucessfully. Model Info: 

FlaxBertForMaskedLMModule(
    # attributes
    config = <model.bert_model.BertConfig object at 0x7f2e0bf8d5e0>
    dtype = float16
) 

[I] Manually constructing dummy batch...
[I] Initialize training state...
[I] Training state initialization is completed.
[I] Constructing Alpa parallelized train step func...
[I] Alpa parallelized train step func construction is completed.
-------------------- Automatic stage clustering --------------------
submesh_choices: ((1, 1), (1, 2), (2, 2))
- Profiling for submesh 2 (2, 2):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(0, 5, 2, 0), 0] = ModuleProfileResult(compute_cost=0.080, peak_memory=2.573 GB, invar_size=2.105 GB, outvar_size=0.078 GB, temp_buffer_size=0.391 GB, available_memory=35.242 GB)
result[(0, 5, 2, 1), 0] = ModuleProfileResult(compute_cost=0.205, peak_memory=1.568 GB, invar_size=1.053 GB, outvar_size=0.125 GB, temp_buffer_size=0.391 GB, available_memory=35.242 GB)
result[(0, 5, 2, 2), 0] = ModuleProfileResult(compute_cost=0.130, peak_memory=2.488 GB, invar_size=1.957 GB, outvar_size=0.078 GB, temp_buffer_size=0.453 GB, available_memory=35.242 GB)
result[(0, 5, 2, 0), 1] = ModuleProfileResult(compute_cost=0.424, peak_memory=9.011 GB, invar_size=5.382 GB, outvar_size=2.652 GB, temp_buffer_size=3.629 GB, available_memory=35.242 GB)
result[(0, 5, 2, 1), 1] = ModuleProfileResult(compute_cost=0.861, peak_memory=6.656 GB, invar_size=2.778 GB, outvar_size=1.326 GB, temp_buffer_size=3.879 GB, available_memory=35.242 GB)
result[(0, 5, 2, 2), 1] = ModuleProfileResult(compute_cost=0.520, peak_memory=8.421 GB, invar_size=4.793 GB, outvar_size=2.357 GB, temp_buffer_size=3.628 GB, available_memory=35.242 GB)
Profiling for submesh 2 (2, 2) takes 138.31 seconds
--------------------------------------------------
- Profiling for submesh 1 (1, 2):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(1, 3, 1, 2), 0] = ModuleProfileResult(compute_cost=0.083, peak_memory=1.876 GB, invar_size=1.188 GB, outvar_size=0.094 GB, temp_buffer_size=0.594 GB, available_memory=35.242 GB)
result[(1, 3, 1, 0), 0] = ModuleProfileResult(compute_cost=0.083, peak_memory=1.876 GB, invar_size=1.188 GB, outvar_size=0.094 GB, temp_buffer_size=0.594 GB, available_memory=35.242 GB)
result[(0, 2, 1, 2), 0] = ModuleProfileResult(compute_cost=0.105, peak_memory=2.193 GB, invar_size=1.256 GB, outvar_size=0.094 GB, temp_buffer_size=0.844 GB, available_memory=35.242 GB)
result[(1, 3, 1, 1), 0] = ModuleProfileResult(compute_cost=0.313, peak_memory=1.422 GB, invar_size=0.641 GB, outvar_size=0.156 GB, temp_buffer_size=0.625 GB, available_memory=35.242 GB)
result[(0, 2, 1, 0), 0] = ModuleProfileResult(compute_cost=0.096, peak_memory=2.229 GB, invar_size=1.354 GB, outvar_size=0.094 GB, temp_buffer_size=0.781 GB, available_memory=35.242 GB)
result[(0, 2, 1, 1), 0] = ModuleProfileResult(compute_cost=0.335, peak_memory=1.615 GB, invar_size=0.677 GB, outvar_size=0.156 GB, temp_buffer_size=0.781 GB, available_memory=35.242 GB)
result[(2, 4, 1, 0), 0] = ModuleProfileResult(compute_cost=0.083, peak_memory=1.876 GB, invar_size=1.188 GB, outvar_size=0.094 GB, temp_buffer_size=0.594 GB, available_memory=35.242 GB)
result[(2, 4, 1, 2), 0] = ModuleProfileResult(compute_cost=0.083, peak_memory=1.876 GB, invar_size=1.188 GB, outvar_size=0.094 GB, temp_buffer_size=0.594 GB, available_memory=35.242 GB)
result[(2, 4, 1, 1), 0] = ModuleProfileResult(compute_cost=0.313, peak_memory=1.422 GB, invar_size=0.641 GB, outvar_size=0.156 GB, temp_buffer_size=0.625 GB, available_memory=35.242 GB)
result[(3, 5, 1, 0), 0] = ModuleProfileResult(compute_cost=0.054, peak_memory=1.438 GB, invar_size=0.782 GB, outvar_size=0.062 GB, temp_buffer_size=0.594 GB, available_memory=35.242 GB)
result[(3, 5, 1, 1), 0] = ModuleProfileResult(compute_cost=0.205, peak_memory=1.188 GB, invar_size=0.438 GB, outvar_size=0.125 GB, temp_buffer_size=0.625 GB, available_memory=35.242 GB)
result[(0, 2, 1, 1), 1] = ModuleProfileResult(compute_cost=0.735, peak_memory=9.921 GB, invar_size=1.542 GB, outvar_size=0.677 GB, temp_buffer_size=8.379 GB, available_memory=35.242 GB)
result[(1, 3, 1, 1), 1] = ModuleProfileResult(compute_cost=0.713, peak_memory=10.116 GB, invar_size=1.407 GB, outvar_size=0.641 GB, temp_buffer_size=8.647 GB, available_memory=35.242 GB)
result[(1, 3, 1, 0), 1] = ModuleProfileResult(compute_cost=0.260, peak_memory=9.695 GB, invar_size=2.439 GB, outvar_size=1.188 GB, temp_buffer_size=7.225 GB, available_memory=35.242 GB)
result[(0, 2, 1, 0), 1] = ModuleProfileResult(compute_cost=0.284, peak_memory=10.027 GB, invar_size=2.802 GB, outvar_size=1.354 GB, temp_buffer_size=7.225 GB, available_memory=35.242 GB)
result[(1, 3, 1, 2), 1] = ModuleProfileResult(compute_cost=0.260, peak_memory=9.695 GB, invar_size=2.439 GB, outvar_size=1.188 GB, temp_buffer_size=7.225 GB, available_memory=35.242 GB)
result[(0, 2, 1, 2), 1] = ModuleProfileResult(compute_cost=0.295, peak_memory=9.893 GB, invar_size=2.636 GB, outvar_size=1.256 GB, temp_buffer_size=7.256 GB, available_memory=35.242 GB)
result[(3, 5, 1, 2), 0] = ModuleProfileResult(compute_cost=0.054, peak_memory=1.438 GB, invar_size=0.782 GB, outvar_size=0.062 GB, temp_buffer_size=0.594 GB, available_memory=35.242 GB)
result[(2, 4, 1, 1), 1] = ModuleProfileResult(compute_cost=0.713, peak_memory=10.562 GB, invar_size=1.407 GB, outvar_size=0.641 GB, temp_buffer_size=9.092 GB, available_memory=35.242 GB)
result[(2, 4, 1, 2), 1] = ModuleProfileResult(compute_cost=0.260, peak_memory=9.696 GB, invar_size=2.439 GB, outvar_size=1.188 GB, temp_buffer_size=7.226 GB, available_memory=35.242 GB)
result[(2, 4, 1, 0), 1] = ModuleProfileResult(compute_cost=0.260, peak_memory=9.696 GB, invar_size=2.439 GB, outvar_size=1.188 GB, temp_buffer_size=7.226 GB, available_memory=35.242 GB)
result[(3, 5, 1, 0), 1] = ModuleProfileResult(compute_cost=0.284, peak_memory=9.131 GB, invar_size=2.689 GB, outvar_size=1.329 GB, temp_buffer_size=6.411 GB, available_memory=35.242 GB)
result[(3, 5, 1, 1), 1] = ModuleProfileResult(compute_cost=0.729, peak_memory=8.885 GB, invar_size=1.485 GB, outvar_size=0.711 GB, temp_buffer_size=7.337 GB, available_memory=35.242 GB)
result[(3, 5, 1, 2), 1] = ModuleProfileResult(compute_cost=0.294, peak_memory=8.967 GB, invar_size=2.494 GB, outvar_size=1.231 GB, temp_buffer_size=6.443 GB, available_memory=35.242 GB)
Profiling for submesh 1 (1, 2) takes 47.02 seconds
--------------------------------------------------
- Profiling for submesh 0 (1, 1):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(0, 0, 0, 1), 0] = ModuleProfileResult(compute_cost=0.077, peak_memory=2.213 GB, invar_size=0.573 GB, outvar_size=0.062 GB, temp_buffer_size=1.578 GB, available_memory=35.242 GB)
result[(0, 0, 0, 0), 0] = ModuleProfileResult(compute_cost=0.077, peak_memory=2.213 GB, invar_size=0.573 GB, outvar_size=0.062 GB, temp_buffer_size=1.578 GB, available_memory=35.242 GB)
result[(0, 0, 0, 1), 1] = ModuleProfileResult(compute_cost=0.201, peak_memory=15.111 GB, invar_size=1.208 GB, outvar_size=0.572 GB, temp_buffer_size=13.903 GB, available_memory=35.242 GB)
result[(0, 0, 0, 0), 1] = ModuleProfileResult(compute_cost=0.201, peak_memory=15.111 GB, invar_size=1.208 GB, outvar_size=0.572 GB, temp_buffer_size=13.903 GB, available_memory=35.242 GB)
result[(3, 4, 0, 0), 0] = ModuleProfileResult(compute_cost=0.103, peak_memory=2.125 GB, invar_size=0.813 GB, outvar_size=0.125 GB, temp_buffer_size=1.188 GB, available_memory=35.242 GB)
result[(3, 4, 0, 1), 0] = ModuleProfileResult(compute_cost=0.103, peak_memory=2.125 GB, invar_size=0.813 GB, outvar_size=0.125 GB, temp_buffer_size=1.188 GB, available_memory=35.242 GB)
result[(3, 4, 0, 0), 1] = ModuleProfileResult(compute_cost=0.310, peak_memory=16.212 GB, invar_size=1.688 GB, outvar_size=0.813 GB, temp_buffer_size=14.461 GB, available_memory=35.242 GB)
result[(3, 4, 0, 1), 1] = ModuleProfileResult(compute_cost=0.310, peak_memory=16.212 GB, invar_size=1.688 GB, outvar_size=0.813 GB, temp_buffer_size=14.461 GB, available_memory=35.242 GB)
Profiling for submesh 0 (1, 1) takes 13.97 seconds
--------------------------------------------------
----------------------------------------------------------------------
Result forward_stage_layer_ids: [[0, 1, 2], [3, 4, 5]]
Result mesh_shapes: [(1, 2), (1, 2)]
Result logical_mesh_shapes: [(2, 1), (2, 1)]
Result autosharding_option_dicts: [{'force_batch_dim_to_mesh_dim': 0}, {'force_batch_dim_to_mesh_dim': 0}]
 - Compile (driver): 243.06 s
compilation time breakdown: {'stage-construction': '202.81', 'stage-construction-dp': '1.20', 'stage-construction-compilation': '137.22', 'stage-construction-profiling': '36.46'}
 - Compile (worker): 9.38 s
[I] Training process warmup (2 rounds) with dummy input batch...
    - Warmup iteration: 1/2
    - Warmup iteration: 2/2
[I] Ready to perform training process.
[I] Benchmark the training process with entire dataset and profile with driver overhead...
    - Iteration 1 / 5 is performed...
    - Iteration 2 / 5 is performed...
    - Iteration 3 / 5 is performed...
    - Iteration 4 / 5 is performed...
 - Benchmark: 111.34 s

[20.110050201416016, 13.927488803863525, 13.840299129486084, 14.04353404045105, 14.060085535049438, 13.931169271469116, 13.895528078079224]


[I] Performance metrics:
 - Iteration count: 5.
 - Total e2e training time : 73.795 s.
 - Average e2e iteration time: 14.759000778198242 s.
 - Total local training time: 69.77100372314453 s.
 - Average local iteration time: 13.954000473022461 s.
 - Max allocated memory among devices: 15.06 GB.
 - Compilation times:  {'stage-construction': 202.8070366382599, 'stage-construction-dp': 1.203704833984375, 'stage-construction-compilation': 137.2219569683075, 'stage-construction-profiling': 36.45552372932434}
 - Metadata:  []
 - Is need save result:  True

[TMP] Current profiling results of key `2_a40_2_n_2_d`: 13.954123497009277
[TMP] Updated profiling results stored in `./jaxpr/prof_log/optimal/bert_1.3B_256.pkl`...

------------------------------------------------------------------
- (3/3) Profiling bert_1.3B with batch size: 512...
------------------------------------------------------------------
[TMP] Existed profiling results in `./jaxpr/prof_log/optimal/bert_1.3B_512.pkl`, updating/rewriting it...
[I] Ray Cluster & Alpa backend initialization is completed.
[I] Device Info:
    - Devices num per node: 2
    - Nodes num: 2
[I] Loading flax model....
[I] Model 'bert' loads sucessfully. Model Info: 

FlaxBertForMaskedLMModule(
    # attributes
    config = <model.bert_model.BertConfig object at 0x7f63466e4400>
    dtype = float16
) 

[I] Manually constructing dummy batch...
[I] Initialize training state...
[I] Training state initialization is completed.
[I] Constructing Alpa parallelized train step func...
[I] Alpa parallelized train step func construction is completed.
-------------------- Automatic stage clustering --------------------
submesh_choices: ((1, 1), (1, 2), (2, 2))
- Profiling for submesh 2 (2, 2):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(0, 5, 2, 1), 0] = ModuleProfileResult(compute_cost=0.243, peak_memory=3.467 GB, invar_size=1.053 GB, outvar_size=0.156 GB, temp_buffer_size=2.258 GB, available_memory=35.242 GB)
result[(0, 5, 2, 0), 0] = ModuleProfileResult(compute_cost=0.149, peak_memory=3.042 GB, invar_size=2.105 GB, outvar_size=0.156 GB, temp_buffer_size=0.781 GB, available_memory=35.242 GB)
result[(0, 5, 2, 2), 0] = ModuleProfileResult(compute_cost=0.149, peak_memory=3.042 GB, invar_size=2.105 GB, outvar_size=0.156 GB, temp_buffer_size=0.781 GB, available_memory=35.242 GB)
result[(0, 5, 2, 0), 1] = ModuleProfileResult(compute_cost=0.678, peak_memory=12.717 GB, invar_size=5.460 GB, outvar_size=2.652 GB, temp_buffer_size=7.257 GB, available_memory=35.242 GB)
result[(0, 5, 2, 2), 1] = ModuleProfileResult(compute_cost=0.678, peak_memory=12.717 GB, invar_size=5.460 GB, outvar_size=2.652 GB, temp_buffer_size=7.257 GB, available_memory=35.242 GB)
result[(0, 5, 2, 1), 1] = ModuleProfileResult(compute_cost=1.549, peak_memory=13.722 GB, invar_size=2.809 GB, outvar_size=1.326 GB, temp_buffer_size=10.913 GB, available_memory=35.242 GB)
Profiling for submesh 2 (2, 2) takes 117.20 seconds
--------------------------------------------------
- Profiling for submesh 1 (1, 2):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(0, 2, 1, 0), 0] = ModuleProfileResult(compute_cost=0.185, peak_memory=3.104 GB, invar_size=1.354 GB, outvar_size=0.188 GB, temp_buffer_size=1.563 GB, available_memory=35.242 GB)
result[(0, 2, 1, 1), 0] = ModuleProfileResult(compute_cost=0.663, peak_memory=2.553 GB, invar_size=0.678 GB, outvar_size=0.312 GB, temp_buffer_size=1.563 GB, available_memory=35.242 GB)
result[(1, 3, 1, 2), 0] = ModuleProfileResult(compute_cost=0.160, peak_memory=2.594 GB, invar_size=1.219 GB, outvar_size=0.188 GB, temp_buffer_size=1.188 GB, available_memory=35.242 GB)
result[(0, 2, 1, 2), 0] = ModuleProfileResult(compute_cost=0.185, peak_memory=3.104 GB, invar_size=1.354 GB, outvar_size=0.188 GB, temp_buffer_size=1.563 GB, available_memory=35.242 GB)
result[(1, 3, 1, 0), 0] = ModuleProfileResult(compute_cost=0.160, peak_memory=2.594 GB, invar_size=1.219 GB, outvar_size=0.188 GB, temp_buffer_size=1.188 GB, available_memory=35.242 GB)
result[(1, 3, 1, 1), 0] = ModuleProfileResult(compute_cost=0.619, peak_memory=2.266 GB, invar_size=0.704 GB, outvar_size=0.312 GB, temp_buffer_size=1.250 GB, available_memory=35.242 GB)
result[(2, 4, 1, 0), 0] = ModuleProfileResult(compute_cost=0.160, peak_memory=2.594 GB, invar_size=1.219 GB, outvar_size=0.188 GB, temp_buffer_size=1.188 GB, available_memory=35.242 GB)
result[(2, 4, 1, 1), 0] = ModuleProfileResult(compute_cost=0.619, peak_memory=2.266 GB, invar_size=0.704 GB, outvar_size=0.312 GB, temp_buffer_size=1.250 GB, available_memory=35.242 GB)
result[(2, 4, 1, 2), 0] = ModuleProfileResult(compute_cost=0.160, peak_memory=2.594 GB, invar_size=1.219 GB, outvar_size=0.188 GB, temp_buffer_size=1.188 GB, available_memory=35.242 GB)
result[(3, 5, 1, 0), 0] = ModuleProfileResult(compute_cost=0.103, peak_memory=2.125 GB, invar_size=0.813 GB, outvar_size=0.125 GB, temp_buffer_size=1.188 GB, available_memory=35.242 GB)
result[(0, 2, 1, 1), 1] = ModuleProfileResult(compute_cost=1.451, peak_memory=18.476 GB, invar_size=1.730 GB, outvar_size=0.677 GB, temp_buffer_size=16.746 GB, available_memory=35.242 GB)
result[(3, 5, 1, 1), 0] = ModuleProfileResult(compute_cost=0.406, peak_memory=2.000 GB, invar_size=0.500 GB, outvar_size=0.250 GB, temp_buffer_size=1.250 GB, available_memory=35.242 GB)
result[(0, 2, 1, 0), 1] = ModuleProfileResult(compute_cost=0.538, peak_memory=17.346 GB, invar_size=2.896 GB, outvar_size=1.354 GB, temp_buffer_size=14.450 GB, available_memory=35.242 GB)
result[(1, 3, 1, 1), 1] = ModuleProfileResult(compute_cost=1.405, peak_memory=19.067 GB, invar_size=1.657 GB, outvar_size=0.704 GB, temp_buffer_size=17.285 GB, available_memory=35.242 GB)
result[(0, 2, 1, 2), 1] = ModuleProfileResult(compute_cost=0.538, peak_memory=17.471 GB, invar_size=2.958 GB, outvar_size=1.354 GB, temp_buffer_size=14.513 GB, available_memory=35.242 GB)
result[(3, 5, 1, 2), 0] = ModuleProfileResult(compute_cost=0.103, peak_memory=2.125 GB, invar_size=0.813 GB, outvar_size=0.125 GB, temp_buffer_size=1.188 GB, available_memory=35.242 GB)
result[(1, 3, 1, 2), 1] = ModuleProfileResult(compute_cost=0.491, peak_memory=17.077 GB, invar_size=2.564 GB, outvar_size=1.219 GB, temp_buffer_size=14.451 GB, available_memory=35.242 GB)
result[(1, 3, 1, 0), 1] = ModuleProfileResult(compute_cost=0.491, peak_memory=17.077 GB, invar_size=2.564 GB, outvar_size=1.219 GB, temp_buffer_size=14.451 GB, available_memory=35.242 GB)
result[(2, 4, 1, 0), 1] = ModuleProfileResult(compute_cost=0.491, peak_memory=17.077 GB, invar_size=2.564 GB, outvar_size=1.219 GB, temp_buffer_size=14.451 GB, available_memory=35.242 GB)
result[(2, 4, 1, 1), 1] = ModuleProfileResult(compute_cost=1.405, peak_memory=19.954 GB, invar_size=1.657 GB, outvar_size=0.704 GB, temp_buffer_size=18.172 GB, available_memory=35.242 GB)
result[(2, 4, 1, 2), 1] = ModuleProfileResult(compute_cost=0.491, peak_memory=17.077 GB, invar_size=2.564 GB, outvar_size=1.219 GB, temp_buffer_size=14.451 GB, available_memory=35.242 GB)
result[(3, 5, 1, 1), 1] = ModuleProfileResult(compute_cost=1.439, peak_memory=16.462 GB, invar_size=1.673 GB, outvar_size=0.774 GB, temp_buffer_size=14.664 GB, available_memory=35.242 GB)
result[(3, 5, 1, 0), 1] = ModuleProfileResult(compute_cost=0.539, peak_memory=15.668 GB, invar_size=2.783 GB, outvar_size=1.360 GB, temp_buffer_size=12.822 GB, available_memory=35.242 GB)
result[(3, 5, 1, 2), 1] = ModuleProfileResult(compute_cost=0.562, peak_memory=15.535 GB, invar_size=2.587 GB, outvar_size=1.262 GB, temp_buffer_size=12.885 GB, available_memory=35.242 GB)
Profiling for submesh 1 (1, 2) takes 48.36 seconds
--------------------------------------------------
- Profiling for submesh 0 (1, 1):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(0, 0, 0, 1), 0] = ModuleProfileResult(compute_cost=0.153, peak_memory=3.854 GB, invar_size=0.573 GB, outvar_size=0.125 GB, temp_buffer_size=3.156 GB, available_memory=35.242 GB)
result[(0, 0, 0, 0), 0] = ModuleProfileResult(compute_cost=0.153, peak_memory=3.854 GB, invar_size=0.573 GB, outvar_size=0.125 GB, temp_buffer_size=3.156 GB, available_memory=35.242 GB)
result[(0, 0, 0, 1), 1] = ModuleProfileResult(compute_cost=0.400, peak_memory=29.077 GB, invar_size=1.270 GB, outvar_size=0.572 GB, temp_buffer_size=27.807 GB, available_memory=35.242 GB)
result[(3, 4, 0, 0), 0] = ModuleProfileResult(compute_cost=0.206, peak_memory=3.501 GB, invar_size=0.876 GB, outvar_size=0.250 GB, temp_buffer_size=2.375 GB, available_memory=35.242 GB)
result[(0, 0, 0, 0), 1] = ModuleProfileResult(compute_cost=0.400, peak_memory=29.077 GB, invar_size=1.270 GB, outvar_size=0.572 GB, temp_buffer_size=27.807 GB, available_memory=35.242 GB)
result[(3, 4, 0, 1), 0] = ModuleProfileResult(compute_cost=0.206, peak_memory=3.501 GB, invar_size=0.876 GB, outvar_size=0.250 GB, temp_buffer_size=2.375 GB, available_memory=35.242 GB)
result[(3, 4, 0, 0), 1] = ModuleProfileResult(compute_cost=0.617, peak_memory=30.917 GB, invar_size=1.876 GB, outvar_size=0.875 GB, temp_buffer_size=28.916 GB, available_memory=35.242 GB)
result[(3, 4, 0, 1), 1] = ModuleProfileResult(compute_cost=0.617, peak_memory=30.917 GB, invar_size=1.876 GB, outvar_size=0.875 GB, temp_buffer_size=28.916 GB, available_memory=35.242 GB)
Profiling for submesh 0 (1, 1) takes 14.29 seconds
--------------------------------------------------
----------------------------------------------------------------------
Result forward_stage_layer_ids: [[0, 1, 2], [3, 4, 5]]
Result mesh_shapes: [(1, 2), (1, 2)]
Result logical_mesh_shapes: [(2, 1), (2, 1)]
Result autosharding_option_dicts: [{}, {'force_batch_dim_to_mesh_dim': 0}]
 - Compile (driver): 236.61 s
compilation time breakdown: {'stage-construction': '183.68', 'stage-construction-dp': '1.41', 'stage-construction-compilation': '113.09', 'stage-construction-profiling': '37.84'}
 - Compile (worker): 9.10 s
[I] Training process warmup (2 rounds) with dummy input batch...
    - Warmup iteration: 1/2
    - Warmup iteration: 2/2
[I] Ready to perform training process.
[I] Benchmark the training process with entire dataset and profile with driver overhead...
    - Iteration 1 / 5 is performed...
    - Iteration 2 / 5 is performed...
    - Iteration 3 / 5 is performed...
    - Iteration 4 / 5 is performed...
 - Benchmark: 200.76 s

[32.7170205116272, 26.14884662628174, 26.11783456802368, 26.223921537399292, 26.22812795639038, 26.340471744537354, 26.10925316810608]


[I] Performance metrics:
 - Iteration count: 5.
 - Total e2e training time : 137.678 s.
 - Average e2e iteration time: 27.536001205444336 s.
 - Total local training time: 131.02000427246094 s.
 - Average local iteration time: 26.20400047302246 s.
 - Max allocated memory among devices: 23.474 GB.
 - Compilation times:  {'stage-construction': 183.67532658576965, 'stage-construction-dp': 1.406473159790039, 'stage-construction-compilation': 113.08807873725891, 'stage-construction-profiling': 37.84091591835022}
 - Metadata:  []
 - Is need save result:  True

[TMP] Current profiling results of key `2_a40_2_n_2_d`: 26.203922271728516
[TMP] Updated profiling results stored in `./jaxpr/prof_log/optimal/bert_1.3B_512.pkl`...
