
------------------------------------------------------------------
- (1/3) Profiling moe_10B with batch size: 256...
------------------------------------------------------------------
[TMP] Profiling results not found in `./jaxpr/prof_log/optimal/moe_10B_256.pkl`, creating it...
[I] Ray Cluster & Alpa backend initialization is completed.
[I] Device Info:
    - Devices num per node: 2
    - Nodes num: 2
[I] Loading flax model....
[I] Model 'moe' loads sucessfully. Model Info: 

FlaxMoEForLMModule(
    # attributes
    config = <model.moe_model.MoEConfig object at 0x7efdbcfed9d0>
    dtype = float16
    bias_init = zeros
) 

[I] Manually constructing dummy batch...
[I] Initialize training state...
[I] Training state initialization is completed.
[I] Constructing Alpa parallelized train step func...
[I] Alpa parallelized train step func construction is completed.
-------------------- Automatic stage clustering --------------------
submesh_choices: ((1, 1), (1, 2), (2, 2))
- Profiling for submesh 2 (2, 2):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(0, 7, 2, 0), 0] = ModuleProfileResult(compute_cost=0.071, peak_memory=17.053 GB, invar_size=16.584 GB, outvar_size=0.082 GB, temp_buffer_size=0.387 GB, available_memory=35.242 GB)
result[(0, 7, 2, 1), 0] = ModuleProfileResult(compute_cost=0.142, peak_memory=8.814 GB, invar_size=8.293 GB, outvar_size=0.117 GB, temp_buffer_size=0.404 GB, available_memory=35.242 GB)
result[(0, 7, 2, 2), 0] = ModuleProfileResult(compute_cost=0.136, peak_memory=5.240 GB, invar_size=4.771 GB, outvar_size=0.082 GB, temp_buffer_size=0.387 GB, available_memory=35.242 GB)
result[(0, 7, 2, 0), 1] = ModuleProfileResult(compute_cost=1.208, peak_memory=57.176 GB, invar_size=38.144 GB, outvar_size=19.031 GB, temp_buffer_size=19.031 GB, available_memory=35.242 GB)
result[(0, 7, 2, 1), 1] = ModuleProfileResult(compute_cost=1.202, peak_memory=28.666 GB, invar_size=19.149 GB, outvar_size=9.516 GB, temp_buffer_size=9.516 GB, available_memory=35.242 GB)
result[(0, 7, 2, 2), 1] = ModuleProfileResult(compute_cost=0.444, peak_memory=12.993 GB, invar_size=11.144 GB, outvar_size=5.531 GB, temp_buffer_size=1.849 GB, available_memory=35.242 GB)
Profiling for submesh 2 (2, 2) takes 89.15 seconds
--------------------------------------------------
- Profiling for submesh 1 (1, 2):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(1, 4, 1, 1), 0] = ModuleProfileResult(compute_cost=0.197, peak_memory=5.778 GB, invar_size=4.793 GB, outvar_size=0.188 GB, temp_buffer_size=0.797 GB, available_memory=35.242 GB)
result[(1, 4, 1, 0), 0] = ModuleProfileResult(compute_cost=0.078, peak_memory=10.384 GB, invar_size=9.516 GB, outvar_size=0.094 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(0, 3, 1, 0), 0] = ModuleProfileResult(compute_cost=0.074, peak_memory=10.314 GB, invar_size=9.447 GB, outvar_size=0.094 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(0, 3, 1, 2), 0] = ModuleProfileResult(compute_cost=0.092, peak_memory=5.814 GB, invar_size=4.947 GB, outvar_size=0.094 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(1, 4, 1, 2), 0] = ModuleProfileResult(compute_cost=0.095, peak_memory=5.884 GB, invar_size=5.016 GB, outvar_size=0.094 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(0, 3, 1, 1), 0] = ModuleProfileResult(compute_cost=0.180, peak_memory=5.685 GB, invar_size=4.724 GB, outvar_size=0.164 GB, temp_buffer_size=0.797 GB, available_memory=35.242 GB)
result[(2, 5, 1, 0), 0] = ModuleProfileResult(compute_cost=0.078, peak_memory=10.384 GB, invar_size=9.516 GB, outvar_size=0.094 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(2, 5, 1, 1), 0] = ModuleProfileResult(compute_cost=0.197, peak_memory=5.778 GB, invar_size=4.793 GB, outvar_size=0.188 GB, temp_buffer_size=0.797 GB, available_memory=35.242 GB)
result[(2, 5, 1, 2), 0] = ModuleProfileResult(compute_cost=0.095, peak_memory=5.884 GB, invar_size=5.016 GB, outvar_size=0.094 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(0, 3, 1, 1), 1] = ModuleProfileResult(compute_cost=0.434, peak_memory=13.408 GB, invar_size=9.634 GB, outvar_size=4.723 GB, temp_buffer_size=3.774 GB, available_memory=35.242 GB)
result[(0, 3, 1, 0), 1] = ModuleProfileResult(compute_cost=0.303, peak_memory=28.434 GB, invar_size=18.987 GB, outvar_size=9.447 GB, temp_buffer_size=9.447 GB, available_memory=35.242 GB)
result[(3, 6, 1, 0), 0] = ModuleProfileResult(compute_cost=0.078, peak_memory=10.384 GB, invar_size=9.516 GB, outvar_size=0.094 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(0, 3, 1, 2), 1] = ModuleProfileResult(compute_cost=0.254, peak_memory=12.891 GB, invar_size=9.987 GB, outvar_size=4.947 GB, temp_buffer_size=2.904 GB, available_memory=35.242 GB)
result[(1, 4, 1, 2), 1] = ModuleProfileResult(compute_cost=0.268, peak_memory=13.464 GB, invar_size=10.126 GB, outvar_size=5.016 GB, temp_buffer_size=3.314 GB, available_memory=35.242 GB)
result[(1, 4, 1, 0), 1] = ModuleProfileResult(compute_cost=0.317, peak_memory=28.619 GB, invar_size=19.103 GB, outvar_size=9.516 GB, temp_buffer_size=9.493 GB, available_memory=35.242 GB)
result[(3, 6, 1, 1), 0] = ModuleProfileResult(compute_cost=0.197, peak_memory=5.778 GB, invar_size=4.793 GB, outvar_size=0.188 GB, temp_buffer_size=0.797 GB, available_memory=35.242 GB)
result[(1, 4, 1, 1), 1] = ModuleProfileResult(compute_cost=0.462, peak_memory=14.200 GB, invar_size=9.727 GB, outvar_size=4.793 GB, temp_buffer_size=4.426 GB, available_memory=35.242 GB)
result[(3, 6, 1, 2), 0] = ModuleProfileResult(compute_cost=0.095, peak_memory=5.884 GB, invar_size=5.016 GB, outvar_size=0.094 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(2, 5, 1, 0), 1] = ModuleProfileResult(compute_cost=0.317, peak_memory=28.619 GB, invar_size=19.103 GB, outvar_size=9.516 GB, temp_buffer_size=9.493 GB, available_memory=35.242 GB)
result[(4, 7, 1, 0), 0] = ModuleProfileResult(compute_cost=0.059, peak_memory=8.005 GB, invar_size=7.161 GB, outvar_size=0.070 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(2, 5, 1, 1), 1] = ModuleProfileResult(compute_cost=0.462, peak_memory=14.060 GB, invar_size=9.727 GB, outvar_size=4.793 GB, temp_buffer_size=4.286 GB, available_memory=35.242 GB)
result[(4, 7, 1, 2), 0] = ModuleProfileResult(compute_cost=0.073, peak_memory=4.630 GB, invar_size=3.786 GB, outvar_size=0.070 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(4, 7, 1, 1), 0] = ModuleProfileResult(compute_cost=0.151, peak_memory=4.554 GB, invar_size=3.616 GB, outvar_size=0.141 GB, temp_buffer_size=0.797 GB, available_memory=35.242 GB)
result[(3, 6, 1, 1), 1] = ModuleProfileResult(compute_cost=0.462, peak_memory=14.159 GB, invar_size=9.727 GB, outvar_size=4.793 GB, temp_buffer_size=4.385 GB, available_memory=35.242 GB)
result[(2, 5, 1, 2), 1] = ModuleProfileResult(compute_cost=0.268, peak_memory=13.441 GB, invar_size=10.103 GB, outvar_size=5.016 GB, temp_buffer_size=3.314 GB, available_memory=35.242 GB)
result[(3, 6, 1, 0), 1] = ModuleProfileResult(compute_cost=0.317, peak_memory=28.619 GB, invar_size=19.103 GB, outvar_size=9.516 GB, temp_buffer_size=9.493 GB, available_memory=35.242 GB)
result[(4, 7, 1, 0), 1] = ModuleProfileResult(compute_cost=0.335, peak_memory=28.871 GB, invar_size=19.263 GB, outvar_size=9.608 GB, temp_buffer_size=9.585 GB, available_memory=35.242 GB)
result[(3, 6, 1, 2), 1] = ModuleProfileResult(compute_cost=0.268, peak_memory=13.441 GB, invar_size=10.103 GB, outvar_size=5.016 GB, temp_buffer_size=3.314 GB, available_memory=35.242 GB)
result[(4, 7, 1, 1), 1] = ModuleProfileResult(compute_cost=0.486, peak_memory=14.484 GB, invar_size=9.772 GB, outvar_size=4.839 GB, temp_buffer_size=4.665 GB, available_memory=35.242 GB)
result[(4, 7, 1, 2), 1] = ModuleProfileResult(compute_cost=0.294, peak_memory=13.893 GB, invar_size=10.171 GB, outvar_size=5.062 GB, temp_buffer_size=3.698 GB, available_memory=35.242 GB)
Profiling for submesh 1 (1, 2) takes 51.18 seconds
--------------------------------------------------
- Profiling for submesh 0 (1, 1):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(3, 4, 0, 0), 0] = ModuleProfileResult(compute_cost=0.081, peak_memory=6.470 GB, invar_size=4.829 GB, outvar_size=0.094 GB, temp_buffer_size=1.547 GB, available_memory=35.242 GB)
result[(1, 2, 0, 1), 0] = ModuleProfileResult(compute_cost=0.072, peak_memory=6.399 GB, invar_size=4.758 GB, outvar_size=0.094 GB, temp_buffer_size=1.547 GB, available_memory=35.242 GB)
result[(2, 3, 0, 0), 0] = ModuleProfileResult(compute_cost=0.072, peak_memory=6.399 GB, invar_size=4.758 GB, outvar_size=0.094 GB, temp_buffer_size=1.547 GB, available_memory=35.242 GB)
result[(2, 3, 0, 1), 0] = ModuleProfileResult(compute_cost=0.072, peak_memory=6.399 GB, invar_size=4.758 GB, outvar_size=0.094 GB, temp_buffer_size=1.547 GB, available_memory=35.242 GB)
result[(0, 1, 0, 0), 0] = ModuleProfileResult(compute_cost=0.075, peak_memory=6.377 GB, invar_size=4.736 GB, outvar_size=0.094 GB, temp_buffer_size=1.547 GB, available_memory=35.242 GB)
result[(0, 1, 0, 1), 0] = ModuleProfileResult(compute_cost=0.075, peak_memory=6.377 GB, invar_size=4.736 GB, outvar_size=0.094 GB, temp_buffer_size=1.547 GB, available_memory=35.242 GB)
result[(1, 2, 0, 0), 0] = ModuleProfileResult(compute_cost=0.072, peak_memory=6.399 GB, invar_size=4.758 GB, outvar_size=0.094 GB, temp_buffer_size=1.547 GB, available_memory=35.242 GB)
result[(3, 4, 0, 0), 1] = ModuleProfileResult(compute_cost=0.234, peak_memory=16.553 GB, invar_size=9.704 GB, outvar_size=4.828 GB, temp_buffer_size=6.802 GB, available_memory=35.242 GB)
result[(0, 1, 0, 0), 1] = ModuleProfileResult(compute_cost=0.210, peak_memory=15.888 GB, invar_size=9.565 GB, outvar_size=4.735 GB, temp_buffer_size=6.324 GB, available_memory=35.242 GB)
result[(0, 1, 0, 1), 1] = ModuleProfileResult(compute_cost=0.210, peak_memory=15.888 GB, invar_size=9.565 GB, outvar_size=4.735 GB, temp_buffer_size=6.324 GB, available_memory=35.242 GB)
result[(2, 3, 0, 1), 1] = ModuleProfileResult(compute_cost=0.212, peak_memory=15.915 GB, invar_size=9.563 GB, outvar_size=4.758 GB, temp_buffer_size=6.305 GB, available_memory=35.242 GB)
result[(2, 3, 0, 0), 1] = ModuleProfileResult(compute_cost=0.212, peak_memory=15.915 GB, invar_size=9.563 GB, outvar_size=4.758 GB, temp_buffer_size=6.305 GB, available_memory=35.242 GB)
result[(1, 2, 0, 0), 1] = ModuleProfileResult(compute_cost=0.212, peak_memory=15.915 GB, invar_size=9.563 GB, outvar_size=4.758 GB, temp_buffer_size=6.305 GB, available_memory=35.242 GB)
result[(3, 4, 0, 1), 0] = ModuleProfileResult(compute_cost=0.081, peak_memory=6.470 GB, invar_size=4.829 GB, outvar_size=0.094 GB, temp_buffer_size=1.547 GB, available_memory=35.242 GB)
result[(1, 2, 0, 1), 1] = ModuleProfileResult(compute_cost=0.212, peak_memory=15.915 GB, invar_size=9.563 GB, outvar_size=4.758 GB, temp_buffer_size=6.305 GB, available_memory=35.242 GB)
result[(4, 5, 0, 0), 0] = ModuleProfileResult(compute_cost=0.081, peak_memory=6.470 GB, invar_size=4.829 GB, outvar_size=0.094 GB, temp_buffer_size=1.547 GB, available_memory=35.242 GB)
result[(4, 5, 0, 1), 0] = ModuleProfileResult(compute_cost=0.081, peak_memory=6.470 GB, invar_size=4.829 GB, outvar_size=0.094 GB, temp_buffer_size=1.547 GB, available_memory=35.242 GB)
result[(5, 6, 0, 0), 0] = ModuleProfileResult(compute_cost=0.072, peak_memory=6.399 GB, invar_size=4.758 GB, outvar_size=0.094 GB, temp_buffer_size=1.547 GB, available_memory=35.242 GB)
result[(6, 7, 0, 0), 0] = ModuleProfileResult(compute_cost=0.036, peak_memory=3.997 GB, invar_size=2.403 GB, outvar_size=0.047 GB, temp_buffer_size=1.547 GB, available_memory=35.242 GB)
result[(6, 7, 0, 1), 0] = ModuleProfileResult(compute_cost=0.036, peak_memory=3.997 GB, invar_size=2.403 GB, outvar_size=0.047 GB, temp_buffer_size=1.547 GB, available_memory=35.242 GB)
result[(5, 6, 0, 1), 0] = ModuleProfileResult(compute_cost=0.072, peak_memory=6.399 GB, invar_size=4.758 GB, outvar_size=0.094 GB, temp_buffer_size=1.547 GB, available_memory=35.242 GB)
result[(3, 4, 0, 1), 1] = ModuleProfileResult(compute_cost=0.234, peak_memory=16.553 GB, invar_size=9.704 GB, outvar_size=4.828 GB, temp_buffer_size=6.802 GB, available_memory=35.242 GB)
result[(4, 5, 0, 1), 1] = ModuleProfileResult(compute_cost=0.234, peak_memory=17.258 GB, invar_size=9.704 GB, outvar_size=4.828 GB, temp_buffer_size=7.507 GB, available_memory=35.242 GB)
result[(4, 5, 0, 0), 1] = ModuleProfileResult(compute_cost=0.234, peak_memory=17.258 GB, invar_size=9.704 GB, outvar_size=4.828 GB, temp_buffer_size=7.507 GB, available_memory=35.242 GB)
result[(5, 6, 0, 0), 1] = ModuleProfileResult(compute_cost=0.212, peak_memory=16.244 GB, invar_size=9.563 GB, outvar_size=4.758 GB, temp_buffer_size=6.634 GB, available_memory=35.242 GB)
result[(5, 6, 0, 1), 1] = ModuleProfileResult(compute_cost=0.212, peak_memory=16.244 GB, invar_size=9.563 GB, outvar_size=4.758 GB, temp_buffer_size=6.634 GB, available_memory=35.242 GB)
result[(6, 7, 0, 1), 1] = ModuleProfileResult(compute_cost=0.247, peak_memory=17.142 GB, invar_size=9.700 GB, outvar_size=4.850 GB, temp_buffer_size=7.396 GB, available_memory=35.242 GB)
result[(6, 7, 0, 0), 1] = ModuleProfileResult(compute_cost=0.247, peak_memory=17.142 GB, invar_size=9.700 GB, outvar_size=4.850 GB, temp_buffer_size=7.396 GB, available_memory=35.242 GB)
Profiling for submesh 0 (1, 1) takes 26.24 seconds
--------------------------------------------------
----------------------------------------------------------------------
Result forward_stage_layer_ids: [[0, 1], [2, 3], [4, 5], [6, 7]]
Result mesh_shapes: [(1, 1), (1, 1), (1, 1), (1, 1)]
Result logical_mesh_shapes: [(1, 1), (1, 1), (1, 1), (1, 1)]
Result autosharding_option_dicts: [{'force_batch_dim_to_mesh_dim': 0}, {}, {}, {}]
 - Compile (driver): 202.81 s
compilation time breakdown: {'stage-construction': '170.27', 'stage-construction-dp': '1.42', 'stage-construction-compilation': '81.90', 'stage-construction-profiling': '44.24'}
 - Compile (worker): 9.11 s
[I] Training process warmup (2 rounds) with dummy input batch...
    - Warmup iteration: 1/2
    - Warmup iteration: 2/2
[I] Ready to perform training process.
[I] Benchmark the training process with entire dataset and profile with driver overhead...
    - Iteration 1 / 5 is performed...
    - Iteration 2 / 5 is performed...
    - Iteration 3 / 5 is performed...
    - Iteration 4 / 5 is performed...
 - Benchmark: 152.58 s

[58.51122832298279, 12.317850112915039, 12.44877576828003, 12.416637182235718, 12.286797285079956, 12.261655569076538, 12.194683074951172]


[I] Performance metrics:
 - Iteration count: 5.
 - Total e2e training time : 64.598 s.
 - Average e2e iteration time: 12.920001029968262 s.
 - Total local training time: 61.60900115966797 s.
 - Average local iteration time: 12.322000503540039 s.
 - Max allocated memory among devices: 28.283 GB.
 - Compilation times:  {'stage-construction': 170.2652370929718, 'stage-construction-dp': 1.4209284782409668, 'stage-construction-compilation': 81.90420126914978, 'stage-construction-profiling': 44.23600125312805}
 - Metadata:  []
 - Is need save result:  True

[TMP] Current profiling results of key `2_a40_2_n_2_d`: 12.321710586547852
[TMP] Updated profiling results stored in `./jaxpr/prof_log/optimal/moe_10B_256.pkl`...

------------------------------------------------------------------
- (2/3) Profiling moe_10B with batch size: 512...
------------------------------------------------------------------
[TMP] Profiling results not found in `./jaxpr/prof_log/optimal/moe_10B_512.pkl`, creating it...
[I] Ray Cluster & Alpa backend initialization is completed.
[I] Device Info:
    - Devices num per node: 2
    - Nodes num: 2
[I] Loading flax model....
[I] Model 'moe' loads sucessfully. Model Info: 

FlaxMoEForLMModule(
    # attributes
    config = <model.moe_model.MoEConfig object at 0x7f068fe47cd0>
    dtype = float16
    bias_init = zeros
) 

[I] Manually constructing dummy batch...
[I] Initialize training state...
[I] Training state initialization is completed.
[I] Constructing Alpa parallelized train step func...
[I] Alpa parallelized train step func construction is completed.
-------------------- Automatic stage clustering --------------------
submesh_choices: ((1, 1), (1, 2), (2, 2))
- Profiling for submesh 2 (2, 2):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(0, 7, 2, 0), 0] = ModuleProfileResult(compute_cost=0.134, peak_memory=17.522 GB, invar_size=16.584 GB, outvar_size=0.164 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(0, 7, 2, 1), 0] = ModuleProfileResult(compute_cost=0.206, peak_memory=9.910 GB, invar_size=8.293 GB, outvar_size=0.164 GB, temp_buffer_size=1.453 GB, available_memory=35.242 GB)
result[(0, 7, 2, 2), 0] = ModuleProfileResult(compute_cost=0.243, peak_memory=5.709 GB, invar_size=4.772 GB, outvar_size=0.164 GB, temp_buffer_size=0.774 GB, available_memory=35.242 GB)
result[(0, 7, 2, 0), 1] = ModuleProfileResult(compute_cost=1.424, peak_memory=57.258 GB, invar_size=38.226 GB, outvar_size=19.031 GB, temp_buffer_size=19.031 GB, available_memory=35.242 GB)
result[(0, 7, 2, 1), 1] = ModuleProfileResult(compute_cost=1.621, peak_memory=28.713 GB, invar_size=19.197 GB, outvar_size=9.516 GB, temp_buffer_size=9.516 GB, available_memory=35.242 GB)
result[(0, 7, 2, 2), 1] = ModuleProfileResult(compute_cost=0.760, peak_memory=14.924 GB, invar_size=11.226 GB, outvar_size=5.531 GB, temp_buffer_size=3.698 GB, available_memory=35.242 GB)
Profiling for submesh 2 (2, 2) takes 86.44 seconds
--------------------------------------------------
- Profiling for submesh 1 (1, 2):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(2, 5, 1, 0), 0] = ModuleProfileResult(compute_cost=0.152, peak_memory=11.275 GB, invar_size=9.540 GB, outvar_size=0.188 GB, temp_buffer_size=1.547 GB, available_memory=35.242 GB)
result[(1, 4, 1, 2), 0] = ModuleProfileResult(compute_cost=0.188, peak_memory=6.775 GB, invar_size=5.040 GB, outvar_size=0.188 GB, temp_buffer_size=1.547 GB, available_memory=35.242 GB)
result[(1, 4, 1, 1), 0] = ModuleProfileResult(compute_cost=0.389, peak_memory=6.810 GB, invar_size=4.840 GB, outvar_size=0.375 GB, temp_buffer_size=1.595 GB, available_memory=35.242 GB)
result[(0, 3, 1, 0), 0] = ModuleProfileResult(compute_cost=0.147, peak_memory=11.182 GB, invar_size=9.447 GB, outvar_size=0.188 GB, temp_buffer_size=1.547 GB, available_memory=35.242 GB)
result[(1, 4, 1, 0), 0] = ModuleProfileResult(compute_cost=0.152, peak_memory=11.275 GB, invar_size=9.540 GB, outvar_size=0.188 GB, temp_buffer_size=1.547 GB, available_memory=35.242 GB)
result[(0, 3, 1, 2), 0] = ModuleProfileResult(compute_cost=0.182, peak_memory=6.682 GB, invar_size=4.947 GB, outvar_size=0.188 GB, temp_buffer_size=1.547 GB, available_memory=35.242 GB)
result[(2, 5, 1, 1), 0] = ModuleProfileResult(compute_cost=0.389, peak_memory=6.810 GB, invar_size=4.840 GB, outvar_size=0.375 GB, temp_buffer_size=1.595 GB, available_memory=35.242 GB)
result[(0, 3, 1, 1), 0] = ModuleProfileResult(compute_cost=0.355, peak_memory=6.647 GB, invar_size=4.724 GB, outvar_size=0.328 GB, temp_buffer_size=1.595 GB, available_memory=35.242 GB)
result[(2, 5, 1, 2), 0] = ModuleProfileResult(compute_cost=0.188, peak_memory=6.775 GB, invar_size=5.040 GB, outvar_size=0.188 GB, temp_buffer_size=1.547 GB, available_memory=35.242 GB)
result[(2, 5, 1, 0), 1] = ModuleProfileResult(compute_cost=0.536, peak_memory=28.760 GB, invar_size=19.220 GB, outvar_size=9.540 GB, temp_buffer_size=9.493 GB, available_memory=35.242 GB)
result[(1, 4, 1, 1), 1] = ModuleProfileResult(compute_cost=0.913, peak_memory=18.904 GB, invar_size=9.962 GB, outvar_size=4.840 GB, temp_buffer_size=8.848 GB, available_memory=35.242 GB)
result[(1, 4, 1, 0), 1] = ModuleProfileResult(compute_cost=0.536, peak_memory=28.760 GB, invar_size=19.220 GB, outvar_size=9.540 GB, temp_buffer_size=9.493 GB, available_memory=35.242 GB)
result[(0, 3, 1, 1), 1] = ModuleProfileResult(compute_cost=0.860, peak_memory=17.363 GB, invar_size=9.822 GB, outvar_size=4.723 GB, temp_buffer_size=7.541 GB, available_memory=35.242 GB)
result[(3, 6, 1, 0), 0] = ModuleProfileResult(compute_cost=0.152, peak_memory=11.275 GB, invar_size=9.540 GB, outvar_size=0.188 GB, temp_buffer_size=1.547 GB, available_memory=35.242 GB)
result[(1, 4, 1, 2), 1] = ModuleProfileResult(compute_cost=0.522, peak_memory=16.942 GB, invar_size=10.267 GB, outvar_size=5.040 GB, temp_buffer_size=6.628 GB, available_memory=35.242 GB)
result[(0, 3, 1, 0), 1] = ModuleProfileResult(compute_cost=0.511, peak_memory=28.528 GB, invar_size=19.081 GB, outvar_size=9.447 GB, temp_buffer_size=9.447 GB, available_memory=35.242 GB)
result[(0, 3, 1, 2), 1] = ModuleProfileResult(compute_cost=0.497, peak_memory=15.889 GB, invar_size=10.081 GB, outvar_size=4.947 GB, temp_buffer_size=5.808 GB, available_memory=35.242 GB)
result[(3, 6, 1, 1), 0] = ModuleProfileResult(compute_cost=0.389, peak_memory=6.810 GB, invar_size=4.840 GB, outvar_size=0.375 GB, temp_buffer_size=1.595 GB, available_memory=35.242 GB)
result[(3, 6, 1, 2), 0] = ModuleProfileResult(compute_cost=0.188, peak_memory=6.775 GB, invar_size=5.040 GB, outvar_size=0.188 GB, temp_buffer_size=1.547 GB, available_memory=35.242 GB)
result[(4, 7, 1, 0), 0] = ModuleProfileResult(compute_cost=0.117, peak_memory=8.872 GB, invar_size=7.184 GB, outvar_size=0.141 GB, temp_buffer_size=1.547 GB, available_memory=35.242 GB)
result[(2, 5, 1, 1), 1] = ModuleProfileResult(compute_cost=0.913, peak_memory=18.623 GB, invar_size=9.962 GB, outvar_size=4.840 GB, temp_buffer_size=8.567 GB, available_memory=35.242 GB)
result[(4, 7, 1, 2), 0] = ModuleProfileResult(compute_cost=0.143, peak_memory=5.497 GB, invar_size=3.809 GB, outvar_size=0.141 GB, temp_buffer_size=1.547 GB, available_memory=35.242 GB)
result[(4, 7, 1, 1), 0] = ModuleProfileResult(compute_cost=0.297, peak_memory=5.539 GB, invar_size=3.663 GB, outvar_size=0.281 GB, temp_buffer_size=1.595 GB, available_memory=35.242 GB)
result[(2, 5, 1, 2), 1] = ModuleProfileResult(compute_cost=0.522, peak_memory=16.895 GB, invar_size=10.220 GB, outvar_size=5.040 GB, temp_buffer_size=6.628 GB, available_memory=35.242 GB)
result[(3, 6, 1, 0), 1] = ModuleProfileResult(compute_cost=0.536, peak_memory=28.760 GB, invar_size=19.220 GB, outvar_size=9.540 GB, temp_buffer_size=9.493 GB, available_memory=35.242 GB)
result[(3, 6, 1, 1), 1] = ModuleProfileResult(compute_cost=0.913, peak_memory=18.820 GB, invar_size=9.962 GB, outvar_size=4.840 GB, temp_buffer_size=8.765 GB, available_memory=35.242 GB)
result[(4, 7, 1, 1), 1] = ModuleProfileResult(compute_cost=0.961, peak_memory=19.380 GB, invar_size=9.960 GB, outvar_size=4.886 GB, temp_buffer_size=9.326 GB, available_memory=35.242 GB)
result[(3, 6, 1, 2), 1] = ModuleProfileResult(compute_cost=0.522, peak_memory=16.896 GB, invar_size=10.220 GB, outvar_size=5.040 GB, temp_buffer_size=6.628 GB, available_memory=35.242 GB)
result[(4, 7, 1, 0), 1] = ModuleProfileResult(compute_cost=0.572, peak_memory=28.988 GB, invar_size=19.357 GB, outvar_size=9.631 GB, temp_buffer_size=9.585 GB, available_memory=35.242 GB)
result[(4, 7, 1, 2), 1] = ModuleProfileResult(compute_cost=0.557, peak_memory=17.752 GB, invar_size=10.357 GB, outvar_size=5.131 GB, temp_buffer_size=7.349 GB, available_memory=35.242 GB)
Profiling for submesh 1 (1, 2) takes 49.56 seconds
--------------------------------------------------
- Profiling for submesh 0 (1, 1):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(0, 1, 0, 1), 0] = ModuleProfileResult(compute_cost=0.149, peak_memory=8.018 GB, invar_size=4.736 GB, outvar_size=0.188 GB, temp_buffer_size=3.095 GB, available_memory=35.242 GB)
result[(2, 3, 0, 0), 0] = ModuleProfileResult(compute_cost=0.142, peak_memory=8.087 GB, invar_size=4.805 GB, outvar_size=0.188 GB, temp_buffer_size=3.095 GB, available_memory=35.242 GB)
result[(3, 4, 0, 0), 0] = ModuleProfileResult(compute_cost=0.160, peak_memory=8.158 GB, invar_size=4.875 GB, outvar_size=0.188 GB, temp_buffer_size=3.095 GB, available_memory=35.242 GB)
result[(2, 3, 0, 1), 0] = ModuleProfileResult(compute_cost=0.142, peak_memory=8.087 GB, invar_size=4.805 GB, outvar_size=0.188 GB, temp_buffer_size=3.095 GB, available_memory=35.242 GB)
result[(1, 2, 0, 0), 0] = ModuleProfileResult(compute_cost=0.142, peak_memory=8.087 GB, invar_size=4.805 GB, outvar_size=0.188 GB, temp_buffer_size=3.095 GB, available_memory=35.242 GB)
result[(0, 1, 0, 0), 0] = ModuleProfileResult(compute_cost=0.149, peak_memory=8.018 GB, invar_size=4.736 GB, outvar_size=0.188 GB, temp_buffer_size=3.095 GB, available_memory=35.242 GB)
result[(1, 2, 0, 1), 0] = ModuleProfileResult(compute_cost=0.142, peak_memory=8.087 GB, invar_size=4.805 GB, outvar_size=0.188 GB, temp_buffer_size=3.095 GB, available_memory=35.242 GB)
result[(3, 4, 0, 1), 0] = ModuleProfileResult(compute_cost=0.160, peak_memory=8.158 GB, invar_size=4.875 GB, outvar_size=0.188 GB, temp_buffer_size=3.095 GB, available_memory=35.242 GB)
result[(2, 3, 0, 0), 1] = ModuleProfileResult(compute_cost=0.421, peak_memory=22.405 GB, invar_size=9.704 GB, outvar_size=4.805 GB, temp_buffer_size=12.608 GB, available_memory=35.242 GB)
result[(3, 4, 0, 0), 1] = ModuleProfileResult(compute_cost=0.465, peak_memory=23.541 GB, invar_size=9.845 GB, outvar_size=4.875 GB, temp_buffer_size=13.603 GB, available_memory=35.242 GB)
result[(2, 3, 0, 1), 1] = ModuleProfileResult(compute_cost=0.421, peak_memory=22.405 GB, invar_size=9.704 GB, outvar_size=4.805 GB, temp_buffer_size=12.608 GB, available_memory=35.242 GB)
result[(0, 1, 0, 1), 1] = ModuleProfileResult(compute_cost=0.416, peak_memory=22.306 GB, invar_size=9.659 GB, outvar_size=4.735 GB, temp_buffer_size=12.647 GB, available_memory=35.242 GB)
result[(0, 1, 0, 0), 1] = ModuleProfileResult(compute_cost=0.416, peak_memory=22.306 GB, invar_size=9.659 GB, outvar_size=4.735 GB, temp_buffer_size=12.647 GB, available_memory=35.242 GB)
result[(4, 5, 0, 0), 0] = ModuleProfileResult(compute_cost=0.160, peak_memory=8.158 GB, invar_size=4.875 GB, outvar_size=0.188 GB, temp_buffer_size=3.095 GB, available_memory=35.242 GB)
result[(1, 2, 0, 0), 1] = ModuleProfileResult(compute_cost=0.421, peak_memory=22.405 GB, invar_size=9.704 GB, outvar_size=4.805 GB, temp_buffer_size=12.608 GB, available_memory=35.242 GB)
result[(1, 2, 0, 1), 1] = ModuleProfileResult(compute_cost=0.421, peak_memory=22.405 GB, invar_size=9.704 GB, outvar_size=4.805 GB, temp_buffer_size=12.608 GB, available_memory=35.242 GB)
result[(4, 5, 0, 1), 0] = ModuleProfileResult(compute_cost=0.160, peak_memory=8.158 GB, invar_size=4.875 GB, outvar_size=0.188 GB, temp_buffer_size=3.095 GB, available_memory=35.242 GB)
result[(5, 6, 0, 0), 0] = ModuleProfileResult(compute_cost=0.142, peak_memory=8.087 GB, invar_size=4.805 GB, outvar_size=0.188 GB, temp_buffer_size=3.095 GB, available_memory=35.242 GB)
result[(6, 7, 0, 0), 0] = ModuleProfileResult(compute_cost=0.071, peak_memory=5.638 GB, invar_size=2.450 GB, outvar_size=0.094 GB, temp_buffer_size=3.095 GB, available_memory=35.242 GB)
result[(6, 7, 0, 1), 0] = ModuleProfileResult(compute_cost=0.071, peak_memory=5.638 GB, invar_size=2.450 GB, outvar_size=0.094 GB, temp_buffer_size=3.095 GB, available_memory=35.242 GB)
result[(3, 4, 0, 1), 1] = ModuleProfileResult(compute_cost=0.465, peak_memory=23.541 GB, invar_size=9.845 GB, outvar_size=4.875 GB, temp_buffer_size=13.603 GB, available_memory=35.242 GB)
result[(5, 6, 0, 1), 0] = ModuleProfileResult(compute_cost=0.142, peak_memory=8.087 GB, invar_size=4.805 GB, outvar_size=0.188 GB, temp_buffer_size=3.095 GB, available_memory=35.242 GB)
result[(4, 5, 0, 0), 1] = ModuleProfileResult(compute_cost=0.465, peak_memory=24.952 GB, invar_size=9.845 GB, outvar_size=4.875 GB, temp_buffer_size=15.013 GB, available_memory=35.242 GB)
result[(4, 5, 0, 1), 1] = ModuleProfileResult(compute_cost=0.465, peak_memory=24.952 GB, invar_size=9.845 GB, outvar_size=4.875 GB, temp_buffer_size=15.013 GB, available_memory=35.242 GB)
result[(5, 6, 0, 0), 1] = ModuleProfileResult(compute_cost=0.421, peak_memory=23.062 GB, invar_size=9.704 GB, outvar_size=4.805 GB, temp_buffer_size=13.265 GB, available_memory=35.242 GB)
result[(5, 6, 0, 1), 1] = ModuleProfileResult(compute_cost=0.421, peak_memory=23.062 GB, invar_size=9.704 GB, outvar_size=4.805 GB, temp_buffer_size=13.265 GB, available_memory=35.242 GB)
result[(6, 7, 0, 0), 1] = ModuleProfileResult(compute_cost=0.490, peak_memory=24.678 GB, invar_size=9.793 GB, outvar_size=4.897 GB, temp_buffer_size=14.791 GB, available_memory=35.242 GB)
result[(6, 7, 0, 1), 1] = ModuleProfileResult(compute_cost=0.490, peak_memory=24.678 GB, invar_size=9.793 GB, outvar_size=4.897 GB, temp_buffer_size=14.791 GB, available_memory=35.242 GB)
Profiling for submesh 0 (1, 1) takes 24.19 seconds
--------------------------------------------------
----------------------------------------------------------------------
Result forward_stage_layer_ids: [[0, 1, 2, 3, 4, 5, 6, 7]]
Result mesh_shapes: [(2, 2)]
Result logical_mesh_shapes: [(4, 1)]
Result autosharding_option_dicts: [{}]
 - Compile (driver): 219.32 s
compilation time breakdown: {'stage-construction': '164.03', 'stage-construction-dp': '1.39', 'stage-construction-compilation': '78.50', 'stage-construction-profiling': '44.72'}
 - Compile (worker): 31.74 s
[I] Training process warmup (2 rounds) with dummy input batch...
    - Warmup iteration: 1/2
    - Warmup iteration: 2/2
[I] Ready to perform training process.
[I] Benchmark the training process with entire dataset and profile with driver overhead...
    - Iteration 1 / 5 is performed...
    - Iteration 2 / 5 is performed...
    - Iteration 3 / 5 is performed...
    - Iteration 4 / 5 is performed...
 - Benchmark: 238.58 s

[32.24837064743042, 28.242613554000854, 28.262545824050903, 28.50734567642212, 28.622883319854736, 28.57195210456848, 28.585927724838257]


[I] Performance metrics:
 - Iteration count: 5.
 - Total e2e training time : 144.361 s.
 - Average e2e iteration time: 28.87200164794922 s.
 - Total local training time: 142.55101013183594 s.
 - Average local iteration time: 28.51000213623047 s.
 - Max allocated memory among devices: 26.912 GB.
 - Compilation times:  {'stage-construction': 164.0327136516571, 'stage-construction-dp': 1.391918659210205, 'stage-construction-compilation': 78.49599862098694, 'stage-construction-profiling': 44.71500492095947}
 - Metadata:  []
 - Is need save result:  True

[TMP] Current profiling results of key `2_a40_2_n_2_d`: 28.5101318359375
[TMP] Updated profiling results stored in `./jaxpr/prof_log/optimal/moe_10B_512.pkl`...

------------------------------------------------------------------
- (3/3) Profiling moe_10B with batch size: 1024...
------------------------------------------------------------------
[TMP] Profiling results not found in `./jaxpr/prof_log/optimal/moe_10B_1024.pkl`, creating it...
[I] Ray Cluster & Alpa backend initialization is completed.
[I] Device Info:
    - Devices num per node: 2
    - Nodes num: 2
[I] Loading flax model....
[I] Model 'moe' loads sucessfully. Model Info: 

FlaxMoEForLMModule(
    # attributes
    config = <model.moe_model.MoEConfig object at 0x7f0c82fea9a0>
    dtype = float16
    bias_init = zeros
) 

[I] Manually constructing dummy batch...
[I] Initialize training state...
[I] Training state initialization is completed.
[I] Constructing Alpa parallelized train step func...
[I] Alpa parallelized train step func construction is completed.
-------------------- Automatic stage clustering --------------------
submesh_choices: ((1, 1), (1, 2), (2, 2))
- Profiling for submesh 2 (2, 2):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(0, 7, 2, 1), 0] = ModuleProfileResult(compute_cost=0.370, peak_memory=10.769 GB, invar_size=8.324 GB, outvar_size=0.328 GB, temp_buffer_size=2.117 GB, available_memory=35.242 GB)
result[(0, 7, 2, 0), 0] = ModuleProfileResult(compute_cost=0.263, peak_memory=18.460 GB, invar_size=16.584 GB, outvar_size=0.328 GB, temp_buffer_size=1.547 GB, available_memory=35.242 GB)
result[(0, 7, 2, 2), 0] = ModuleProfileResult(compute_cost=0.462, peak_memory=6.647 GB, invar_size=4.772 GB, outvar_size=0.328 GB, temp_buffer_size=1.547 GB, available_memory=35.242 GB)
result[(0, 7, 2, 0), 1] = ModuleProfileResult(compute_cost=1.869, peak_memory=57.422 GB, invar_size=38.391 GB, outvar_size=19.031 GB, temp_buffer_size=19.031 GB, available_memory=35.242 GB)
result[(0, 7, 2, 1), 1] = ModuleProfileResult(compute_cost=2.337, peak_memory=30.738 GB, invar_size=19.431 GB, outvar_size=9.551 GB, temp_buffer_size=11.307 GB, available_memory=35.242 GB)
result[(0, 7, 2, 2), 1] = ModuleProfileResult(compute_cost=1.411, peak_memory=18.786 GB, invar_size=11.391 GB, outvar_size=5.531 GB, temp_buffer_size=7.396 GB, available_memory=35.242 GB)
Profiling for submesh 2 (2, 2) takes 86.98 seconds
--------------------------------------------------
- Profiling for submesh 1 (1, 2):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(1, 4, 1, 2), 0] = ModuleProfileResult(compute_cost=0.373, peak_memory=8.557 GB, invar_size=5.087 GB, outvar_size=0.375 GB, temp_buffer_size=3.095 GB, available_memory=35.242 GB)
result[(2, 5, 1, 0), 0] = ModuleProfileResult(compute_cost=0.302, peak_memory=13.057 GB, invar_size=9.587 GB, outvar_size=0.375 GB, temp_buffer_size=3.095 GB, available_memory=35.242 GB)
result[(1, 4, 1, 0), 0] = ModuleProfileResult(compute_cost=0.302, peak_memory=13.057 GB, invar_size=9.587 GB, outvar_size=0.375 GB, temp_buffer_size=3.095 GB, available_memory=35.242 GB)
result[(0, 3, 1, 0), 0] = ModuleProfileResult(compute_cost=0.291, peak_memory=12.917 GB, invar_size=9.447 GB, outvar_size=0.375 GB, temp_buffer_size=3.095 GB, available_memory=35.242 GB)
result[(0, 3, 1, 2), 0] = ModuleProfileResult(compute_cost=0.361, peak_memory=8.417 GB, invar_size=4.947 GB, outvar_size=0.375 GB, temp_buffer_size=3.095 GB, available_memory=35.242 GB)
result[(1, 4, 1, 1), 0] = ModuleProfileResult(compute_cost=0.773, peak_memory=8.874 GB, invar_size=4.934 GB, outvar_size=0.750 GB, temp_buffer_size=3.190 GB, available_memory=35.242 GB)
result[(2, 5, 1, 1), 0] = ModuleProfileResult(compute_cost=0.773, peak_memory=8.874 GB, invar_size=4.934 GB, outvar_size=0.750 GB, temp_buffer_size=3.190 GB, available_memory=35.242 GB)
result[(0, 3, 1, 1), 0] = ModuleProfileResult(compute_cost=0.705, peak_memory=8.570 GB, invar_size=4.724 GB, outvar_size=0.656 GB, temp_buffer_size=3.190 GB, available_memory=35.242 GB)
result[(1, 4, 1, 1), 1] = ModuleProfileResult(compute_cost=1.815, peak_memory=28.309 GB, invar_size=10.431 GB, outvar_size=4.934 GB, temp_buffer_size=17.691 GB, available_memory=35.242 GB)
result[(2, 5, 1, 2), 0] = ModuleProfileResult(compute_cost=0.373, peak_memory=8.557 GB, invar_size=5.087 GB, outvar_size=0.375 GB, temp_buffer_size=3.095 GB, available_memory=35.242 GB)
result[(0, 3, 1, 1), 1] = ModuleProfileResult(compute_cost=1.709, peak_memory=25.269 GB, invar_size=10.198 GB, outvar_size=4.723 GB, temp_buffer_size=15.072 GB, available_memory=35.242 GB)
result[(1, 4, 1, 2), 1] = ModuleProfileResult(compute_cost=1.032, peak_memory=23.899 GB, invar_size=10.548 GB, outvar_size=5.087 GB, temp_buffer_size=13.256 GB, available_memory=35.242 GB)
result[(0, 3, 1, 2), 1] = ModuleProfileResult(compute_cost=0.982, peak_memory=21.885 GB, invar_size=10.269 GB, outvar_size=4.947 GB, temp_buffer_size=11.616 GB, available_memory=35.242 GB)
result[(3, 6, 1, 2), 0] = ModuleProfileResult(compute_cost=0.373, peak_memory=8.557 GB, invar_size=5.087 GB, outvar_size=0.375 GB, temp_buffer_size=3.095 GB, available_memory=35.242 GB)
result[(0, 3, 1, 0), 1] = ModuleProfileResult(compute_cost=0.926, peak_memory=30.885 GB, invar_size=19.269 GB, outvar_size=9.447 GB, temp_buffer_size=11.616 GB, available_memory=35.242 GB)
result[(2, 5, 1, 0), 1] = ModuleProfileResult(compute_cost=0.976, peak_memory=32.805 GB, invar_size=19.455 GB, outvar_size=9.587 GB, temp_buffer_size=13.257 GB, available_memory=35.242 GB)
result[(1, 4, 1, 0), 1] = ModuleProfileResult(compute_cost=0.976, peak_memory=32.711 GB, invar_size=19.455 GB, outvar_size=9.587 GB, temp_buffer_size=13.163 GB, available_memory=35.242 GB)
result[(3, 6, 1, 0), 0] = ModuleProfileResult(compute_cost=0.302, peak_memory=13.057 GB, invar_size=9.587 GB, outvar_size=0.375 GB, temp_buffer_size=3.095 GB, available_memory=35.242 GB)
result[(3, 6, 1, 1), 0] = ModuleProfileResult(compute_cost=0.773, peak_memory=8.874 GB, invar_size=4.934 GB, outvar_size=0.750 GB, temp_buffer_size=3.190 GB, available_memory=35.242 GB)
result[(4, 7, 1, 0), 0] = ModuleProfileResult(compute_cost=0.231, peak_memory=10.607 GB, invar_size=7.231 GB, outvar_size=0.281 GB, temp_buffer_size=3.095 GB, available_memory=35.242 GB)
result[(4, 7, 1, 1), 0] = ModuleProfileResult(compute_cost=0.591, peak_memory=7.509 GB, invar_size=3.756 GB, outvar_size=0.562 GB, temp_buffer_size=3.190 GB, available_memory=35.242 GB)
result[(2, 5, 1, 1), 1] = ModuleProfileResult(compute_cost=1.815, peak_memory=27.747 GB, invar_size=10.431 GB, outvar_size=4.934 GB, temp_buffer_size=17.129 GB, available_memory=35.242 GB)
result[(4, 7, 1, 2), 0] = ModuleProfileResult(compute_cost=0.284, peak_memory=7.232 GB, invar_size=3.856 GB, outvar_size=0.281 GB, temp_buffer_size=3.095 GB, available_memory=35.242 GB)
result[(2, 5, 1, 2), 1] = ModuleProfileResult(compute_cost=1.032, peak_memory=23.805 GB, invar_size=10.455 GB, outvar_size=5.087 GB, temp_buffer_size=13.257 GB, available_memory=35.242 GB)
result[(3, 6, 1, 1), 1] = ModuleProfileResult(compute_cost=1.815, peak_memory=28.144 GB, invar_size=10.431 GB, outvar_size=4.934 GB, temp_buffer_size=17.526 GB, available_memory=35.242 GB)
result[(3, 6, 1, 0), 1] = ModuleProfileResult(compute_cost=0.976, peak_memory=32.805 GB, invar_size=19.455 GB, outvar_size=9.587 GB, temp_buffer_size=13.257 GB, available_memory=35.242 GB)
result[(3, 6, 1, 2), 1] = ModuleProfileResult(compute_cost=1.032, peak_memory=23.805 GB, invar_size=10.455 GB, outvar_size=5.087 GB, temp_buffer_size=13.257 GB, available_memory=35.242 GB)
result[(4, 7, 1, 0), 1] = ModuleProfileResult(compute_cost=1.046, peak_memory=34.336 GB, invar_size=19.544 GB, outvar_size=9.678 GB, temp_buffer_size=14.698 GB, available_memory=35.242 GB)
result[(4, 7, 1, 1), 1] = ModuleProfileResult(compute_cost=1.913, peak_memory=29.169 GB, invar_size=10.335 GB, outvar_size=4.980 GB, temp_buffer_size=18.647 GB, available_memory=35.242 GB)
result[(4, 7, 1, 2), 1] = ModuleProfileResult(compute_cost=1.102, peak_memory=25.336 GB, invar_size=10.544 GB, outvar_size=5.178 GB, temp_buffer_size=14.698 GB, available_memory=35.242 GB)
Profiling for submesh 1 (1, 2) takes 49.08 seconds
--------------------------------------------------
- Profiling for submesh 0 (1, 1):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(3, 4, 0, 0), 0] = ModuleProfileResult(compute_cost=0.319, peak_memory=11.534 GB, invar_size=4.969 GB, outvar_size=0.375 GB, temp_buffer_size=6.190 GB, available_memory=35.242 GB)
result[(2, 3, 0, 0), 0] = ModuleProfileResult(compute_cost=0.284, peak_memory=11.464 GB, invar_size=4.899 GB, outvar_size=0.375 GB, temp_buffer_size=6.190 GB, available_memory=35.242 GB)
result[(2, 3, 0, 1), 0] = ModuleProfileResult(compute_cost=0.284, peak_memory=11.464 GB, invar_size=4.899 GB, outvar_size=0.375 GB, temp_buffer_size=6.190 GB, available_memory=35.242 GB)
result[(0, 1, 0, 1), 0] = ModuleProfileResult(compute_cost=0.296, peak_memory=11.301 GB, invar_size=4.736 GB, outvar_size=0.375 GB, temp_buffer_size=6.190 GB, available_memory=35.242 GB)
result[(1, 2, 0, 1), 0] = ModuleProfileResult(compute_cost=0.284, peak_memory=11.464 GB, invar_size=4.899 GB, outvar_size=0.375 GB, temp_buffer_size=6.190 GB, available_memory=35.242 GB)
result[(1, 2, 0, 0), 0] = ModuleProfileResult(compute_cost=0.284, peak_memory=11.464 GB, invar_size=4.899 GB, outvar_size=0.375 GB, temp_buffer_size=6.190 GB, available_memory=35.242 GB)
result[(0, 1, 0, 0), 0] = ModuleProfileResult(compute_cost=0.296, peak_memory=11.301 GB, invar_size=4.736 GB, outvar_size=0.375 GB, temp_buffer_size=6.190 GB, available_memory=35.242 GB)
result[(3, 4, 0, 1), 0] = ModuleProfileResult(compute_cost=0.319, peak_memory=11.534 GB, invar_size=4.969 GB, outvar_size=0.375 GB, temp_buffer_size=6.190 GB, available_memory=35.242 GB)
result[(2, 3, 0, 1), 1] = ModuleProfileResult(compute_cost=0.840, peak_memory=35.383 GB, invar_size=9.985 GB, outvar_size=4.899 GB, temp_buffer_size=25.211 GB, available_memory=35.242 GB)
result[(0, 1, 0, 1), 1] = ModuleProfileResult(compute_cost=0.829, peak_memory=35.141 GB, invar_size=9.847 GB, outvar_size=4.735 GB, temp_buffer_size=25.295 GB, available_memory=35.242 GB)
result[(0, 1, 0, 0), 1] = ModuleProfileResult(compute_cost=0.829, peak_memory=35.141 GB, invar_size=9.847 GB, outvar_size=4.735 GB, temp_buffer_size=25.295 GB, available_memory=35.242 GB)
result[(1, 2, 0, 0), 1] = ModuleProfileResult(compute_cost=0.840, peak_memory=35.383 GB, invar_size=9.985 GB, outvar_size=4.899 GB, temp_buffer_size=25.211 GB, available_memory=35.242 GB)
result[(1, 2, 0, 1), 1] = ModuleProfileResult(compute_cost=0.840, peak_memory=35.383 GB, invar_size=9.985 GB, outvar_size=4.899 GB, temp_buffer_size=25.211 GB, available_memory=35.242 GB)
result[(3, 4, 0, 0), 1] = ModuleProfileResult(compute_cost=0.928, peak_memory=37.518 GB, invar_size=10.126 GB, outvar_size=4.969 GB, temp_buffer_size=27.204 GB, available_memory=35.242 GB)
result[(2, 3, 0, 0), 1] = ModuleProfileResult(compute_cost=0.840, peak_memory=35.383 GB, invar_size=9.985 GB, outvar_size=4.899 GB, temp_buffer_size=25.211 GB, available_memory=35.242 GB)
result[(5, 6, 0, 0), 0] = ModuleProfileResult(compute_cost=0.284, peak_memory=11.464 GB, invar_size=4.899 GB, outvar_size=0.375 GB, temp_buffer_size=6.190 GB, available_memory=35.242 GB)
result[(4, 5, 0, 0), 0] = ModuleProfileResult(compute_cost=0.319, peak_memory=11.534 GB, invar_size=4.969 GB, outvar_size=0.375 GB, temp_buffer_size=6.190 GB, available_memory=35.242 GB)
result[(4, 5, 0, 1), 0] = ModuleProfileResult(compute_cost=0.319, peak_memory=11.534 GB, invar_size=4.969 GB, outvar_size=0.375 GB, temp_buffer_size=6.190 GB, available_memory=35.242 GB)
result[(6, 7, 0, 0), 0] = ModuleProfileResult(compute_cost=0.142, peak_memory=8.920 GB, invar_size=2.543 GB, outvar_size=0.188 GB, temp_buffer_size=6.189 GB, available_memory=35.242 GB)
result[(6, 7, 0, 1), 0] = ModuleProfileResult(compute_cost=0.142, peak_memory=8.920 GB, invar_size=2.543 GB, outvar_size=0.188 GB, temp_buffer_size=6.189 GB, available_memory=35.242 GB)
result[(5, 6, 0, 1), 0] = ModuleProfileResult(compute_cost=0.284, peak_memory=11.464 GB, invar_size=4.899 GB, outvar_size=0.375 GB, temp_buffer_size=6.190 GB, available_memory=35.242 GB)
result[(3, 4, 0, 1), 1] = ModuleProfileResult(compute_cost=0.928, peak_memory=37.518 GB, invar_size=10.126 GB, outvar_size=4.969 GB, temp_buffer_size=27.204 GB, available_memory=35.242 GB)
result[(4, 5, 0, 0), 1] = ModuleProfileResult(compute_cost=0.928, peak_memory=40.338 GB, invar_size=10.126 GB, outvar_size=4.969 GB, temp_buffer_size=30.025 GB, available_memory=35.242 GB)
result[(4, 5, 0, 1), 1] = ModuleProfileResult(compute_cost=0.928, peak_memory=40.338 GB, invar_size=10.126 GB, outvar_size=4.969 GB, temp_buffer_size=30.025 GB, available_memory=35.242 GB)
result[(6, 7, 0, 0), 1] = ModuleProfileResult(compute_cost=0.978, peak_memory=39.751 GB, invar_size=9.981 GB, outvar_size=4.990 GB, temp_buffer_size=29.582 GB, available_memory=35.242 GB)
result[(5, 6, 0, 1), 1] = ModuleProfileResult(compute_cost=0.840, peak_memory=36.697 GB, invar_size=9.985 GB, outvar_size=4.899 GB, temp_buffer_size=26.525 GB, available_memory=35.242 GB)
result[(5, 6, 0, 0), 1] = ModuleProfileResult(compute_cost=0.840, peak_memory=36.697 GB, invar_size=9.985 GB, outvar_size=4.899 GB, temp_buffer_size=26.525 GB, available_memory=35.242 GB)
result[(6, 7, 0, 1), 1] = ModuleProfileResult(compute_cost=0.978, peak_memory=39.751 GB, invar_size=9.981 GB, outvar_size=4.990 GB, temp_buffer_size=29.582 GB, available_memory=35.242 GB)
Profiling for submesh 0 (1, 1) takes 26.12 seconds
--------------------------------------------------
----------------------------------------------------------------------
Result forward_stage_layer_ids: [[0, 1, 2, 3, 4, 5, 6, 7]]
Result mesh_shapes: [(2, 2)]
Result logical_mesh_shapes: [(4, 1)]
Result autosharding_option_dicts: [{}]
 - Compile (driver): 221.49 s
compilation time breakdown: {'stage-construction': '166.45', 'stage-construction-dp': '1.37', 'stage-construction-compilation': '78.41', 'stage-construction-profiling': '44.75'}
 - Compile (worker): 31.62 s
[I] Training process warmup (2 rounds) with dummy input batch...
    - Warmup iteration: 1/2
    - Warmup iteration: 2/2
[I] Ready to perform training process.
[I] Benchmark the training process with entire dataset and profile with driver overhead...
    - Iteration 1 / 5 is performed...
    - Iteration 2 / 5 is performed...
    - Iteration 3 / 5 is performed...
    - Iteration 4 / 5 is performed...
 - Benchmark: 428.80 s

[59.86723303794861, 56.14244747161865, 56.010263204574585, 55.99474620819092, 56.10761594772339, 56.223066091537476, 57.59969687461853]


[I] Performance metrics:
 - Iteration count: 5.
 - Total e2e training time : 283.91 s.
 - Average e2e iteration time: 56.78200149536133 s.
 - Total local training time: 281.9350280761719 s.
 - Average local iteration time: 56.387001037597656 s.
 - Max allocated memory among devices: 33.237 GB.
 - Compilation times:  {'stage-construction': 166.44997191429138, 'stage-construction-dp': 1.367410659790039, 'stage-construction-compilation': 78.41182446479797, 'stage-construction-profiling': 44.745118141174316}
 - Metadata:  []
 - Is need save result:  True

[TMP] Current profiling results of key `2_a40_2_n_2_d`: 56.387081146240234
[TMP] Updated profiling results stored in `./jaxpr/prof_log/optimal/moe_10B_1024.pkl`...
