
------------------------------------------------------------------
- (1/3) Profiling moe_690M with batch size: 256...
------------------------------------------------------------------
[TMP] Existed profiling results in `./jaxpr/prof_log/optimal/moe_690M_256.pkl`, updating/rewriting it...
[TMP] Key `1_a10_1_n_1_d` has been profiled in `./jaxpr/prof_log/optimal/moe_690M_256.pkl` when optimizing with alpa, loading cache...

------------------------------------------------------------------
- (2/3) Profiling moe_690M with batch size: 512...
------------------------------------------------------------------
[TMP] Existed profiling results in `./jaxpr/prof_log/optimal/moe_690M_512.pkl`, updating/rewriting it...
[I] Ray Cluster & Alpa backend initialization is completed.
[I] Device Info:
    - Devices num per node: 1
    - Nodes num: 1
[I] Loading flax model....
[I] Model 'moe' loads sucessfully. Model Info: 

FlaxMoEForLMModule(
    # attributes
    config = <model.moe_model.MoEConfig object at 0x7f7f2742cd00>
    dtype = float16
    bias_init = zeros
) 

[I] Manually constructing dummy batch...
[I] Initialize training state...
[I] Training state initialization is completed.
[I] Constructing Alpa parallelized train step func...
[I] Alpa parallelized train step func construction is completed.
-------------------- Automatic stage clustering --------------------
submesh_choices: ((1, 1),)
- Profiling for submesh 0 (1, 1):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(0, 7, 0, 0), 0] = ModuleProfileResult(compute_cost=0.129, peak_memory=3.600 GB, invar_size=1.256 GB, outvar_size=0.328 GB, temp_buffer_size=2.016 GB, available_memory=19.578 GB)
result[(0, 7, 0, 0), 1] = ModuleProfileResult(compute_cost=0.438, peak_memory=10.762 GB, invar_size=2.976 GB, outvar_size=1.324 GB, temp_buffer_size=7.786 GB, available_memory=19.578 GB)
result[(0, 7, 0, 1), 0] = ModuleProfileResult(compute_cost=0.129, peak_memory=3.600 GB, invar_size=1.256 GB, outvar_size=0.328 GB, temp_buffer_size=2.016 GB, available_memory=19.578 GB)
result[(0, 7, 0, 1), 1] = ModuleProfileResult(compute_cost=0.438, peak_memory=10.762 GB, invar_size=2.976 GB, outvar_size=1.324 GB, temp_buffer_size=7.786 GB, available_memory=19.578 GB)
Profiling for submesh 0 (1, 1) takes 15.68 seconds
--------------------------------------------------
Profile result saved to: profile-results-2023-11-15-14-53-33.npy
----------------------------------------------------------------------
Result forward_stage_layer_ids: [[0, 1, 2, 3, 4, 5, 6, 7]]
Result mesh_shapes: [(1, 1)]
Result logical_mesh_shapes: [(1, 1)]
Result autosharding_option_dicts: [{'force_batch_dim_to_mesh_dim': 0}]
 - Compile (driver): 32.27 s
compilation time breakdown: {'stage-construction': '17.87', 'stage-construction-dp': '1.11', 'stage-construction-compilation': '2.29', 'stage-construction-profiling': '10.24'}
 - Compile (worker): 13.83 s
[I] Training process warmup (2 rounds) with dummy input batch...
    - Warmup iteration: 1/2
[E] Meet unexpected error in profiling executables...

[E] Unexpected error occurred in compiling or profiling executables...
[E] Meet unexpected error in compiling and executing model...
[TMP] Current profiling results of key `1_a10_1_n_1_d`: none
[TMP] Updated profiling results stored in `./jaxpr/prof_log/optimal/moe_690M_512.pkl`...

------------------------------------------------------------------
- (3/3) Profiling moe_690M with batch size: 1024...
------------------------------------------------------------------
[TMP] Existed profiling results in `./jaxpr/prof_log/optimal/moe_690M_1024.pkl`, updating/rewriting it...
[I] Ray Cluster & Alpa backend initialization is completed.
[I] Device Info:
    - Devices num per node: 1
    - Nodes num: 1
[I] Loading flax model....
[I] Model 'moe' loads sucessfully. Model Info: 

FlaxMoEForLMModule(
    # attributes
    config = <model.moe_model.MoEConfig object at 0x7f7f03f46a30>
    dtype = float16
    bias_init = zeros
) 

[I] Manually constructing dummy batch...
[I] Initialize training state...
[I] Training state initialization is completed.
[I] Constructing Alpa parallelized train step func...
[I] Alpa parallelized train step func construction is completed.
-------------------- Automatic stage clustering --------------------
submesh_choices: ((1, 1),)
- Profiling for submesh 0 (1, 1):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(0, 7, 0, 0), 0] = ModuleProfileResult(compute_cost=0.254, peak_memory=5.944 GB, invar_size=1.257 GB, outvar_size=0.656 GB, temp_buffer_size=4.031 GB, available_memory=19.578 GB)
result[(0, 7, 0, 1), 0] = ModuleProfileResult(compute_cost=0.254, peak_memory=5.944 GB, invar_size=1.257 GB, outvar_size=0.656 GB, temp_buffer_size=4.031 GB, available_memory=19.578 GB)
result[(0, 7, 0, 0), 1] = ModuleProfileResult(compute_cost=0.861, peak_memory=18.873 GB, invar_size=3.305 GB, outvar_size=1.324 GB, temp_buffer_size=15.568 GB, available_memory=19.578 GB)
result[(0, 7, 0, 1), 1] = ModuleProfileResult(compute_cost=0.861, peak_memory=18.873 GB, invar_size=3.305 GB, outvar_size=1.324 GB, temp_buffer_size=15.568 GB, available_memory=19.578 GB)
Profiling for submesh 0 (1, 1) takes 15.95 seconds
--------------------------------------------------
Profile result saved to: profile-results-2023-11-15-14-54-47.npy
----------------------------------------------------------------------
[E] Meet unexpected error in compiling executables...

[E] Unexpected error occurred in compiling or profiling executables...
[TMP] Current profiling results of key `1_a10_1_n_1_d`: none
[TMP] Updated profiling results stored in `./jaxpr/prof_log/optimal/moe_690M_1024.pkl`...
