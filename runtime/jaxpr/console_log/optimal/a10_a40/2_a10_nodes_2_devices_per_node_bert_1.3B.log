
------------------------------------------------------------------
- (1/3) Profiling bert_1.3B with batch size: 128...
------------------------------------------------------------------
[TMP] Existed profiling results in `./jaxpr/prof_log/optimal/bert_1.3B_128.pkl`, updating/rewriting it...
[I] Ray Cluster & Alpa backend initialization is completed.
[I] Device Info:
    - Devices num per node: 2
    - Nodes num: 2
[I] Loading flax model....
[I] Model 'bert' loads sucessfully. Model Info: 

FlaxBertForMaskedLMModule(
    # attributes
    config = <model.bert_model.BertConfig object at 0x7f71a588d2e0>
    dtype = float16
) 

[I] Manually constructing dummy batch...
[I] Initialize training state...
[I] Training state initialization is completed.
[I] Constructing Alpa parallelized train step func...
[I] Alpa parallelized train step func construction is completed.
-------------------- Automatic stage clustering --------------------
submesh_choices: ((1, 1), (1, 2), (2, 2))
- Profiling for submesh 2 (2, 2):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(0, 5, 2, 0), 0] = ModuleProfileResult(compute_cost=0.060, peak_memory=2.339 GB, invar_size=2.105 GB, outvar_size=0.039 GB, temp_buffer_size=0.195 GB, available_memory=17.402 GB)
result[(0, 5, 2, 1), 0] = ModuleProfileResult(compute_cost=0.157, peak_memory=1.318 GB, invar_size=1.053 GB, outvar_size=0.070 GB, temp_buffer_size=0.195 GB, available_memory=17.402 GB)
result[(0, 5, 2, 2), 0] = ModuleProfileResult(compute_cost=0.085, peak_memory=2.222 GB, invar_size=1.957 GB, outvar_size=0.039 GB, temp_buffer_size=0.227 GB, available_memory=17.402 GB)
result[(0, 5, 2, 0), 1] = ModuleProfileResult(compute_cost=0.348, peak_memory=7.994 GB, invar_size=5.342 GB, outvar_size=2.652 GB, temp_buffer_size=2.652 GB, available_memory=17.402 GB)
result[(0, 5, 2, 1), 1] = ModuleProfileResult(compute_cost=0.556, peak_memory=4.662 GB, invar_size=2.723 GB, outvar_size=1.326 GB, temp_buffer_size=1.939 GB, available_memory=17.402 GB)
result[(0, 5, 2, 2), 1] = ModuleProfileResult(compute_cost=0.384, peak_memory=7.218 GB, invar_size=4.754 GB, outvar_size=2.357 GB, temp_buffer_size=2.464 GB, available_memory=17.402 GB)
Profiling for submesh 2 (2, 2) takes 130.19 seconds
--------------------------------------------------
- Profiling for submesh 1 (1, 2):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(0, 2, 1, 0), 0] = ModuleProfileResult(compute_cost=0.074, peak_memory=1.792 GB, invar_size=1.354 GB, outvar_size=0.047 GB, temp_buffer_size=0.391 GB, available_memory=17.580 GB)
result[(0, 2, 1, 1), 0] = ModuleProfileResult(compute_cost=0.194, peak_memory=1.146 GB, invar_size=0.677 GB, outvar_size=0.078 GB, temp_buffer_size=0.391 GB, available_memory=17.580 GB)
result[(1, 3, 1, 2), 0] = ModuleProfileResult(compute_cost=0.064, peak_memory=1.516 GB, invar_size=1.173 GB, outvar_size=0.047 GB, temp_buffer_size=0.297 GB, available_memory=17.580 GB)
result[(0, 2, 1, 2), 0] = ModuleProfileResult(compute_cost=0.078, peak_memory=1.724 GB, invar_size=1.256 GB, outvar_size=0.047 GB, temp_buffer_size=0.422 GB, available_memory=17.580 GB)
result[(1, 3, 1, 0), 0] = ModuleProfileResult(compute_cost=0.064, peak_memory=1.516 GB, invar_size=1.173 GB, outvar_size=0.047 GB, temp_buffer_size=0.297 GB, available_memory=17.580 GB)
result[(1, 3, 1, 1), 0] = ModuleProfileResult(compute_cost=0.180, peak_memory=1.001 GB, invar_size=0.610 GB, outvar_size=0.078 GB, temp_buffer_size=0.313 GB, available_memory=17.580 GB)
result[(2, 4, 1, 0), 0] = ModuleProfileResult(compute_cost=0.064, peak_memory=1.516 GB, invar_size=1.173 GB, outvar_size=0.047 GB, temp_buffer_size=0.297 GB, available_memory=17.580 GB)
result[(2, 4, 1, 1), 0] = ModuleProfileResult(compute_cost=0.180, peak_memory=1.001 GB, invar_size=0.610 GB, outvar_size=0.078 GB, temp_buffer_size=0.313 GB, available_memory=17.580 GB)
result[(2, 4, 1, 2), 0] = ModuleProfileResult(compute_cost=0.064, peak_memory=1.516 GB, invar_size=1.173 GB, outvar_size=0.047 GB, temp_buffer_size=0.297 GB, available_memory=17.580 GB)
result[(3, 5, 1, 0), 0] = ModuleProfileResult(compute_cost=0.042, peak_memory=1.094 GB, invar_size=0.766 GB, outvar_size=0.031 GB, temp_buffer_size=0.297 GB, available_memory=17.580 GB)
result[(0, 2, 1, 0), 1] = ModuleProfileResult(compute_cost=0.223, peak_memory=6.368 GB, invar_size=2.755 GB, outvar_size=1.354 GB, temp_buffer_size=3.613 GB, available_memory=17.580 GB)
result[(3, 5, 1, 1), 0] = ModuleProfileResult(compute_cost=0.118, peak_memory=0.782 GB, invar_size=0.407 GB, outvar_size=0.062 GB, temp_buffer_size=0.313 GB, available_memory=17.580 GB)
result[(0, 2, 1, 1), 1] = ModuleProfileResult(compute_cost=0.443, peak_memory=5.642 GB, invar_size=1.448 GB, outvar_size=0.677 GB, temp_buffer_size=4.194 GB, available_memory=17.580 GB)
result[(1, 3, 1, 2), 1] = ModuleProfileResult(compute_cost=0.204, peak_memory=6.005 GB, invar_size=2.376 GB, outvar_size=1.173 GB, temp_buffer_size=3.613 GB, available_memory=17.580 GB)
result[(1, 3, 1, 0), 1] = ModuleProfileResult(compute_cost=0.204, peak_memory=6.005 GB, invar_size=2.376 GB, outvar_size=1.173 GB, temp_buffer_size=3.613 GB, available_memory=17.580 GB)
result[(1, 3, 1, 1), 1] = ModuleProfileResult(compute_cost=0.426, peak_memory=5.640 GB, invar_size=1.282 GB, outvar_size=0.610 GB, temp_buffer_size=4.326 GB, available_memory=17.580 GB)
result[(3, 5, 1, 2), 0] = ModuleProfileResult(compute_cost=0.042, peak_memory=1.094 GB, invar_size=0.766 GB, outvar_size=0.031 GB, temp_buffer_size=0.297 GB, available_memory=17.580 GB)
result[(0, 2, 1, 2), 1] = ModuleProfileResult(compute_cost=0.227, peak_memory=6.202 GB, invar_size=2.574 GB, outvar_size=1.256 GB, temp_buffer_size=3.628 GB, available_memory=17.580 GB)
result[(2, 4, 1, 0), 1] = ModuleProfileResult(compute_cost=0.204, peak_memory=6.005 GB, invar_size=2.376 GB, outvar_size=1.172 GB, temp_buffer_size=3.613 GB, available_memory=17.580 GB)
result[(2, 4, 1, 1), 1] = ModuleProfileResult(compute_cost=0.426, peak_memory=5.865 GB, invar_size=1.282 GB, outvar_size=0.610 GB, temp_buffer_size=4.551 GB, available_memory=17.580 GB)
result[(2, 4, 1, 2), 1] = ModuleProfileResult(compute_cost=0.204, peak_memory=6.005 GB, invar_size=2.376 GB, outvar_size=1.172 GB, temp_buffer_size=3.613 GB, available_memory=17.580 GB)
result[(3, 5, 1, 0), 1] = ModuleProfileResult(compute_cost=0.221, peak_memory=5.863 GB, invar_size=2.642 GB, outvar_size=1.313 GB, temp_buffer_size=3.206 GB, available_memory=17.580 GB)
result[(3, 5, 1, 1), 1] = ModuleProfileResult(compute_cost=0.439, peak_memory=5.095 GB, invar_size=1.392 GB, outvar_size=0.680 GB, temp_buffer_size=3.672 GB, available_memory=17.580 GB)
result[(3, 5, 1, 2), 1] = ModuleProfileResult(compute_cost=0.226, peak_memory=5.684 GB, invar_size=2.447 GB, outvar_size=1.215 GB, temp_buffer_size=3.221 GB, available_memory=17.580 GB)
Profiling for submesh 1 (1, 2) takes 44.19 seconds
--------------------------------------------------
- Profiling for submesh 0 (1, 1):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(0, 0, 0, 0), 0] = ModuleProfileResult(compute_cost=0.058, peak_memory=1.393 GB, invar_size=0.573 GB, outvar_size=0.031 GB, temp_buffer_size=0.789 GB, available_memory=17.580 GB)
result[(0, 0, 0, 1), 0] = ModuleProfileResult(compute_cost=0.058, peak_memory=1.393 GB, invar_size=0.573 GB, outvar_size=0.031 GB, temp_buffer_size=0.789 GB, available_memory=17.580 GB)
result[(0, 0, 0, 1), 1] = ModuleProfileResult(compute_cost=0.153, peak_memory=8.128 GB, invar_size=1.176 GB, outvar_size=0.572 GB, temp_buffer_size=6.952 GB, available_memory=17.580 GB)
result[(0, 0, 0, 0), 1] = ModuleProfileResult(compute_cost=0.153, peak_memory=8.128 GB, invar_size=1.176 GB, outvar_size=0.572 GB, temp_buffer_size=6.952 GB, available_memory=17.580 GB)
result[(3, 4, 0, 0), 0] = ModuleProfileResult(compute_cost=0.080, peak_memory=1.438 GB, invar_size=0.782 GB, outvar_size=0.062 GB, temp_buffer_size=0.594 GB, available_memory=17.580 GB)
result[(3, 4, 0, 1), 0] = ModuleProfileResult(compute_cost=0.080, peak_memory=1.438 GB, invar_size=0.782 GB, outvar_size=0.062 GB, temp_buffer_size=0.594 GB, available_memory=17.580 GB)
result[(3, 4, 0, 0), 1] = ModuleProfileResult(compute_cost=0.239, peak_memory=8.859 GB, invar_size=1.595 GB, outvar_size=0.782 GB, temp_buffer_size=7.233 GB, available_memory=17.580 GB)
result[(3, 4, 0, 1), 1] = ModuleProfileResult(compute_cost=0.239, peak_memory=8.859 GB, invar_size=1.595 GB, outvar_size=0.782 GB, temp_buffer_size=7.233 GB, available_memory=17.580 GB)
Profiling for submesh 0 (1, 1) takes 11.76 seconds
--------------------------------------------------
Profile result saved to: profile-results-2023-11-17-02-41-34.npy
----------------------------------------------------------------------
Result forward_stage_layer_ids: [[0, 1, 2], [3, 4, 5]]
Result mesh_shapes: [(1, 2), (1, 2)]
Result logical_mesh_shapes: [(2, 1), (2, 1)]
Result autosharding_option_dicts: [{'force_batch_dim_to_mesh_dim': 0}, {'force_batch_dim_to_mesh_dim': 0}]
 - Compile (driver): 226.75 s
compilation time breakdown: {'stage-construction': '189.36', 'stage-construction-dp': '1.13', 'stage-construction-compilation': '130.98', 'stage-construction-profiling': '31.25'}
 - Compile (worker): 7.46 s
[I] Training process warmup (2 rounds) with dummy input batch...
    - Warmup iteration: 1/2
    - Warmup iteration: 2/2
[I] Ready to perform training process.
[I] Benchmark the training process with entire dataset and profile with driver overhead...
    - Iteration 1 / 5 is performed...
    - Iteration 2 / 5 is performed...
    - Iteration 3 / 5 is performed...
    - Iteration 4 / 5 is performed...
 - Benchmark: 75.66 s

[14.169305562973022, 9.138150691986084, 8.90581727027893, 8.913192749023438, 8.952880620956421, 8.924818277359009, 8.966603994369507]


[I] Performance metrics:
 - Iteration count: 5.
 - Total e2e training time : 47.714 s.
 - Average e2e iteration time: 9.543000221252441 s.
 - Total local training time: 44.663002014160156 s.
 - Average local iteration time: 8.933000564575195 s.
 - Max allocated memory among devices: 10.915 GB.
 - Compilation times:  {'stage-construction': 189.35715985298157, 'stage-construction-dp': 1.1281511783599854, 'stage-construction-compilation': 130.98399090766907, 'stage-construction-profiling': 31.248947620391846}
 - Metadata:  []
 - Is need save result:  True

[TMP] Current profiling results of key `2_a10_2_n_2_d`: 8.932662963867188
[TMP] Updated profiling results stored in `./jaxpr/prof_log/optimal/bert_1.3B_128.pkl`...

------------------------------------------------------------------
- (2/3) Profiling bert_1.3B with batch size: 256...
------------------------------------------------------------------
[TMP] Existed profiling results in `./jaxpr/prof_log/optimal/bert_1.3B_256.pkl`, updating/rewriting it...
[I] Ray Cluster & Alpa backend initialization is completed.
[I] Device Info:
    - Devices num per node: 2
    - Nodes num: 2
[I] Loading flax model....
[I] Model 'bert' loads sucessfully. Model Info: 

FlaxBertForMaskedLMModule(
    # attributes
    config = <model.bert_model.BertConfig object at 0x7f680bf3e2e0>
    dtype = float16
) 

[I] Manually constructing dummy batch...
[I] Initialize training state...
[I] Training state initialization is completed.
[I] Constructing Alpa parallelized train step func...
[I] Alpa parallelized train step func construction is completed.
-------------------- Automatic stage clustering --------------------
submesh_choices: ((1, 1), (1, 2), (2, 2))
- Profiling for submesh 2 (2, 2):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(0, 5, 2, 0), 0] = ModuleProfileResult(compute_cost=0.115, peak_memory=2.573 GB, invar_size=2.105 GB, outvar_size=0.078 GB, temp_buffer_size=0.391 GB, available_memory=17.402 GB)
result[(0, 5, 2, 1), 0] = ModuleProfileResult(compute_cost=0.241, peak_memory=1.568 GB, invar_size=1.053 GB, outvar_size=0.125 GB, temp_buffer_size=0.391 GB, available_memory=17.402 GB)
result[(0, 5, 2, 2), 0] = ModuleProfileResult(compute_cost=0.164, peak_memory=2.488 GB, invar_size=1.957 GB, outvar_size=0.078 GB, temp_buffer_size=0.453 GB, available_memory=17.402 GB)
result[(0, 5, 2, 0), 1] = ModuleProfileResult(compute_cost=0.547, peak_memory=9.011 GB, invar_size=5.382 GB, outvar_size=2.652 GB, temp_buffer_size=3.629 GB, available_memory=17.402 GB)
result[(0, 5, 2, 1), 1] = ModuleProfileResult(compute_cost=0.990, peak_memory=6.656 GB, invar_size=2.778 GB, outvar_size=1.326 GB, temp_buffer_size=3.879 GB, available_memory=17.402 GB)
result[(0, 5, 2, 2), 1] = ModuleProfileResult(compute_cost=0.638, peak_memory=8.421 GB, invar_size=4.793 GB, outvar_size=2.357 GB, temp_buffer_size=3.628 GB, available_memory=17.402 GB)
Profiling for submesh 2 (2, 2) takes 128.02 seconds
--------------------------------------------------
- Profiling for submesh 1 (1, 2):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(1, 3, 1, 2), 0] = ModuleProfileResult(compute_cost=0.124, peak_memory=1.876 GB, invar_size=1.188 GB, outvar_size=0.094 GB, temp_buffer_size=0.594 GB, available_memory=17.580 GB)
result[(0, 2, 1, 0), 0] = ModuleProfileResult(compute_cost=0.142, peak_memory=2.229 GB, invar_size=1.354 GB, outvar_size=0.094 GB, temp_buffer_size=0.781 GB, available_memory=17.580 GB)
result[(0, 2, 1, 1), 0] = ModuleProfileResult(compute_cost=0.382, peak_memory=1.615 GB, invar_size=0.677 GB, outvar_size=0.156 GB, temp_buffer_size=0.781 GB, available_memory=17.580 GB)
result[(1, 3, 1, 1), 0] = ModuleProfileResult(compute_cost=0.354, peak_memory=1.422 GB, invar_size=0.641 GB, outvar_size=0.156 GB, temp_buffer_size=0.625 GB, available_memory=17.580 GB)
result[(1, 3, 1, 0), 0] = ModuleProfileResult(compute_cost=0.124, peak_memory=1.876 GB, invar_size=1.188 GB, outvar_size=0.094 GB, temp_buffer_size=0.594 GB, available_memory=17.580 GB)
result[(0, 2, 1, 2), 0] = ModuleProfileResult(compute_cost=0.151, peak_memory=2.193 GB, invar_size=1.256 GB, outvar_size=0.094 GB, temp_buffer_size=0.844 GB, available_memory=17.580 GB)
result[(2, 4, 1, 0), 0] = ModuleProfileResult(compute_cost=0.124, peak_memory=1.876 GB, invar_size=1.188 GB, outvar_size=0.094 GB, temp_buffer_size=0.594 GB, available_memory=17.580 GB)
result[(2, 4, 1, 1), 0] = ModuleProfileResult(compute_cost=0.354, peak_memory=1.422 GB, invar_size=0.641 GB, outvar_size=0.156 GB, temp_buffer_size=0.625 GB, available_memory=17.580 GB)
result[(2, 4, 1, 2), 0] = ModuleProfileResult(compute_cost=0.124, peak_memory=1.876 GB, invar_size=1.188 GB, outvar_size=0.094 GB, temp_buffer_size=0.594 GB, available_memory=17.580 GB)
result[(3, 5, 1, 0), 0] = ModuleProfileResult(compute_cost=0.080, peak_memory=1.438 GB, invar_size=0.782 GB, outvar_size=0.062 GB, temp_buffer_size=0.594 GB, available_memory=17.580 GB)
result[(0, 2, 1, 1), 1] = ModuleProfileResult(compute_cost=0.868, peak_memory=9.921 GB, invar_size=1.542 GB, outvar_size=0.677 GB, temp_buffer_size=8.379 GB, available_memory=17.580 GB)
result[(3, 5, 1, 1), 0] = ModuleProfileResult(compute_cost=0.231, peak_memory=1.188 GB, invar_size=0.438 GB, outvar_size=0.125 GB, temp_buffer_size=0.625 GB, available_memory=17.580 GB)
result[(1, 3, 1, 2), 1] = ModuleProfileResult(compute_cost=0.381, peak_memory=9.695 GB, invar_size=2.439 GB, outvar_size=1.188 GB, temp_buffer_size=7.225 GB, available_memory=17.580 GB)
result[(0, 2, 1, 0), 1] = ModuleProfileResult(compute_cost=0.416, peak_memory=10.027 GB, invar_size=2.802 GB, outvar_size=1.354 GB, temp_buffer_size=7.225 GB, available_memory=17.580 GB)
result[(1, 3, 1, 1), 1] = ModuleProfileResult(compute_cost=0.834, peak_memory=10.116 GB, invar_size=1.407 GB, outvar_size=0.641 GB, temp_buffer_size=8.647 GB, available_memory=17.580 GB)
result[(1, 3, 1, 0), 1] = ModuleProfileResult(compute_cost=0.381, peak_memory=9.695 GB, invar_size=2.439 GB, outvar_size=1.188 GB, temp_buffer_size=7.225 GB, available_memory=17.580 GB)
result[(3, 5, 1, 2), 0] = ModuleProfileResult(compute_cost=0.080, peak_memory=1.438 GB, invar_size=0.782 GB, outvar_size=0.062 GB, temp_buffer_size=0.594 GB, available_memory=17.580 GB)
result[(0, 2, 1, 2), 1] = ModuleProfileResult(compute_cost=0.426, peak_memory=9.893 GB, invar_size=2.636 GB, outvar_size=1.256 GB, temp_buffer_size=7.256 GB, available_memory=17.580 GB)
result[(2, 4, 1, 0), 1] = ModuleProfileResult(compute_cost=0.381, peak_memory=9.696 GB, invar_size=2.439 GB, outvar_size=1.188 GB, temp_buffer_size=7.226 GB, available_memory=17.580 GB)
result[(2, 4, 1, 1), 1] = ModuleProfileResult(compute_cost=0.834, peak_memory=10.562 GB, invar_size=1.407 GB, outvar_size=0.641 GB, temp_buffer_size=9.092 GB, available_memory=17.580 GB)
result[(2, 4, 1, 2), 1] = ModuleProfileResult(compute_cost=0.381, peak_memory=9.696 GB, invar_size=2.439 GB, outvar_size=1.188 GB, temp_buffer_size=7.226 GB, available_memory=17.580 GB)
result[(3, 5, 1, 0), 1] = ModuleProfileResult(compute_cost=0.416, peak_memory=9.131 GB, invar_size=2.689 GB, outvar_size=1.329 GB, temp_buffer_size=6.411 GB, available_memory=17.580 GB)
result[(3, 5, 1, 1), 1] = ModuleProfileResult(compute_cost=0.861, peak_memory=8.885 GB, invar_size=1.485 GB, outvar_size=0.711 GB, temp_buffer_size=7.337 GB, available_memory=17.580 GB)
result[(3, 5, 1, 2), 1] = ModuleProfileResult(compute_cost=0.426, peak_memory=8.967 GB, invar_size=2.494 GB, outvar_size=1.231 GB, temp_buffer_size=6.443 GB, available_memory=17.580 GB)
Profiling for submesh 1 (1, 2) takes 43.38 seconds
--------------------------------------------------
- Profiling for submesh 0 (1, 1):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(0, 0, 0, 0), 0] = ModuleProfileResult(compute_cost=0.115, peak_memory=2.213 GB, invar_size=0.573 GB, outvar_size=0.062 GB, temp_buffer_size=1.578 GB, available_memory=17.580 GB)
result[(0, 0, 0, 1), 0] = ModuleProfileResult(compute_cost=0.115, peak_memory=2.213 GB, invar_size=0.573 GB, outvar_size=0.062 GB, temp_buffer_size=1.578 GB, available_memory=17.580 GB)
result[(0, 0, 0, 0), 1] = ModuleProfileResult(compute_cost=0.304, peak_memory=15.111 GB, invar_size=1.208 GB, outvar_size=0.572 GB, temp_buffer_size=13.903 GB, available_memory=17.580 GB)
result[(0, 0, 0, 1), 1] = ModuleProfileResult(compute_cost=0.304, peak_memory=15.111 GB, invar_size=1.208 GB, outvar_size=0.572 GB, temp_buffer_size=13.903 GB, available_memory=17.580 GB)
result[(3, 4, 0, 0), 0] = ModuleProfileResult(compute_cost=0.158, peak_memory=2.125 GB, invar_size=0.813 GB, outvar_size=0.125 GB, temp_buffer_size=1.188 GB, available_memory=17.580 GB)
result[(3, 4, 0, 1), 0] = ModuleProfileResult(compute_cost=0.158, peak_memory=2.125 GB, invar_size=0.813 GB, outvar_size=0.125 GB, temp_buffer_size=1.188 GB, available_memory=17.580 GB)
result[(3, 4, 0, 0), 1] = ModuleProfileResult(compute_cost=0.474, peak_memory=16.212 GB, invar_size=1.688 GB, outvar_size=0.813 GB, temp_buffer_size=14.461 GB, available_memory=17.580 GB)
result[(3, 4, 0, 1), 1] = ModuleProfileResult(compute_cost=0.474, peak_memory=16.212 GB, invar_size=1.688 GB, outvar_size=0.813 GB, temp_buffer_size=14.461 GB, available_memory=17.580 GB)
Profiling for submesh 0 (1, 1) takes 11.91 seconds
--------------------------------------------------
Profile result saved to: profile-results-2023-11-17-02-46-52.npy
----------------------------------------------------------------------
Result forward_stage_layer_ids: [[0, 1, 2], [3, 4, 5]]
Result mesh_shapes: [(1, 2), (1, 2)]
Result logical_mesh_shapes: [(2, 1), (2, 1)]
Result autosharding_option_dicts: [{'force_batch_dim_to_mesh_dim': 0}, {'force_batch_dim_to_mesh_dim': 0}]
 - Compile (driver): 225.15 s
compilation time breakdown: {'stage-construction': '186.55', 'stage-construction-dp': '1.14', 'stage-construction-compilation': '127.40', 'stage-construction-profiling': '31.59'}
 - Compile (worker): 7.84 s
[I] Training process warmup (2 rounds) with dummy input batch...
    - Warmup iteration: 1/2
    - Warmup iteration: 2/2
[I] Ready to perform training process.
[I] Benchmark the training process with entire dataset and profile with driver overhead...
    - Iteration 1 / 5 is performed...
    - Iteration 2 / 5 is performed...
    - Iteration 3 / 5 is performed...
    - Iteration 4 / 5 is performed...
 - Benchmark: 137.90 s

[23.9287326335907, 17.75109839439392, 17.71879816055298, 17.334828853607178, 17.60725736618042, 17.579625606536865, 17.717594146728516]


[I] Performance metrics:
 - Iteration count: 5.
 - Total e2e training time : 92.791 s.
 - Average e2e iteration time: 18.558000564575195 s.
 - Total local training time: 87.9580078125 s.
 - Average local iteration time: 17.59200096130371 s.
 - Max allocated memory among devices: 15.06 GB.
 - Compilation times:  {'stage-construction': 186.54568076133728, 'stage-construction-dp': 1.1364054679870605, 'stage-construction-compilation': 127.40274167060852, 'stage-construction-profiling': 31.589560508728027}
 - Metadata:  []
 - Is need save result:  True

[TMP] Current profiling results of key `2_a10_2_n_2_d`: 17.59162139892578
[TMP] Updated profiling results stored in `./jaxpr/prof_log/optimal/bert_1.3B_256.pkl`...

------------------------------------------------------------------
- (3/3) Profiling bert_1.3B with batch size: 512...
------------------------------------------------------------------
[TMP] Profiling results not found in `./jaxpr/prof_log/optimal/bert_1.3B_512.pkl`, creating it...
[I] Ray Cluster & Alpa backend initialization is completed.
[I] Device Info:
    - Devices num per node: 2
    - Nodes num: 2
[I] Loading flax model....
[I] Model 'bert' loads sucessfully. Model Info: 

FlaxBertForMaskedLMModule(
    # attributes
    config = <model.bert_model.BertConfig object at 0x7fbec8230ca0>
    dtype = float16
) 

[I] Manually constructing dummy batch...
[I] Initialize training state...
[I] Training state initialization is completed.
[I] Constructing Alpa parallelized train step func...
[I] Alpa parallelized train step func construction is completed.
-------------------- Automatic stage clustering --------------------
submesh_choices: ((1, 1), (1, 2), (2, 2))
- Profiling for submesh 2 (2, 2):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(0, 5, 2, 0), 0] = ModuleProfileResult(compute_cost=0.222, peak_memory=3.042 GB, invar_size=2.105 GB, outvar_size=0.156 GB, temp_buffer_size=0.781 GB, available_memory=17.402 GB)
result[(0, 5, 2, 1), 0] = ModuleProfileResult(compute_cost=0.315, peak_memory=3.467 GB, invar_size=1.053 GB, outvar_size=0.156 GB, temp_buffer_size=2.258 GB, available_memory=17.402 GB)
result[(0, 5, 2, 2), 0] = ModuleProfileResult(compute_cost=0.222, peak_memory=3.042 GB, invar_size=2.105 GB, outvar_size=0.156 GB, temp_buffer_size=0.781 GB, available_memory=17.402 GB)
result[(0, 5, 2, 0), 1] = ModuleProfileResult(compute_cost=0.936, peak_memory=12.717 GB, invar_size=5.460 GB, outvar_size=2.652 GB, temp_buffer_size=7.257 GB, available_memory=17.402 GB)
result[(0, 5, 2, 2), 1] = ModuleProfileResult(compute_cost=0.936, peak_memory=12.717 GB, invar_size=5.460 GB, outvar_size=2.652 GB, temp_buffer_size=7.257 GB, available_memory=17.402 GB)
result[(0, 5, 2, 1), 1] = ModuleProfileResult(compute_cost=1.826, peak_memory=13.722 GB, invar_size=2.809 GB, outvar_size=1.326 GB, temp_buffer_size=10.913 GB, available_memory=17.402 GB)
Profiling for submesh 2 (2, 2) takes 111.67 seconds
--------------------------------------------------
- Profiling for submesh 1 (1, 2):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(0, 2, 1, 0), 0] = ModuleProfileResult(compute_cost=0.281, peak_memory=3.104 GB, invar_size=1.354 GB, outvar_size=0.188 GB, temp_buffer_size=1.563 GB, available_memory=17.580 GB)
result[(0, 2, 1, 1), 0] = ModuleProfileResult(compute_cost=0.759, peak_memory=2.553 GB, invar_size=0.678 GB, outvar_size=0.312 GB, temp_buffer_size=1.563 GB, available_memory=17.580 GB)
result[(1, 3, 1, 2), 0] = ModuleProfileResult(compute_cost=0.245, peak_memory=2.594 GB, invar_size=1.219 GB, outvar_size=0.188 GB, temp_buffer_size=1.188 GB, available_memory=17.580 GB)
result[(0, 2, 1, 2), 0] = ModuleProfileResult(compute_cost=0.281, peak_memory=3.104 GB, invar_size=1.354 GB, outvar_size=0.188 GB, temp_buffer_size=1.563 GB, available_memory=17.580 GB)
result[(1, 3, 1, 0), 0] = ModuleProfileResult(compute_cost=0.245, peak_memory=2.594 GB, invar_size=1.219 GB, outvar_size=0.188 GB, temp_buffer_size=1.188 GB, available_memory=17.580 GB)
result[(1, 3, 1, 1), 0] = ModuleProfileResult(compute_cost=0.704, peak_memory=2.266 GB, invar_size=0.704 GB, outvar_size=0.312 GB, temp_buffer_size=1.250 GB, available_memory=17.580 GB)
result[(2, 4, 1, 0), 0] = ModuleProfileResult(compute_cost=0.245, peak_memory=2.594 GB, invar_size=1.219 GB, outvar_size=0.188 GB, temp_buffer_size=1.188 GB, available_memory=17.580 GB)
result[(2, 4, 1, 2), 0] = ModuleProfileResult(compute_cost=0.245, peak_memory=2.594 GB, invar_size=1.219 GB, outvar_size=0.188 GB, temp_buffer_size=1.188 GB, available_memory=17.580 GB)
result[(2, 4, 1, 1), 0] = ModuleProfileResult(compute_cost=0.704, peak_memory=2.266 GB, invar_size=0.704 GB, outvar_size=0.312 GB, temp_buffer_size=1.250 GB, available_memory=17.580 GB)
result[(3, 5, 1, 0), 0] = ModuleProfileResult(compute_cost=0.158, peak_memory=2.125 GB, invar_size=0.813 GB, outvar_size=0.125 GB, temp_buffer_size=1.188 GB, available_memory=17.580 GB)
result[(3, 5, 1, 1), 0] = ModuleProfileResult(compute_cost=0.460, peak_memory=2.000 GB, invar_size=0.500 GB, outvar_size=0.250 GB, temp_buffer_size=1.250 GB, available_memory=17.580 GB)
result[(0, 2, 1, 1), 1] = ModuleProfileResult(compute_cost=1.725, peak_memory=18.476 GB, invar_size=1.730 GB, outvar_size=0.677 GB, temp_buffer_size=16.746 GB, available_memory=17.580 GB)
result[(0, 2, 1, 0), 1] = ModuleProfileResult(compute_cost=0.812, peak_memory=17.346 GB, invar_size=2.896 GB, outvar_size=1.354 GB, temp_buffer_size=14.450 GB, available_memory=17.580 GB)
result[(1, 3, 1, 1), 1] = ModuleProfileResult(compute_cost=1.658, peak_memory=19.067 GB, invar_size=1.657 GB, outvar_size=0.704 GB, temp_buffer_size=17.285 GB, available_memory=17.580 GB)
result[(1, 3, 1, 0), 1] = ModuleProfileResult(compute_cost=0.743, peak_memory=17.077 GB, invar_size=2.564 GB, outvar_size=1.219 GB, temp_buffer_size=14.451 GB, available_memory=17.580 GB)
result[(1, 3, 1, 2), 1] = ModuleProfileResult(compute_cost=0.743, peak_memory=17.077 GB, invar_size=2.564 GB, outvar_size=1.219 GB, temp_buffer_size=14.451 GB, available_memory=17.580 GB)
result[(3, 5, 1, 2), 0] = ModuleProfileResult(compute_cost=0.158, peak_memory=2.125 GB, invar_size=0.813 GB, outvar_size=0.125 GB, temp_buffer_size=1.188 GB, available_memory=17.580 GB)
result[(0, 2, 1, 2), 1] = ModuleProfileResult(compute_cost=0.812, peak_memory=17.471 GB, invar_size=2.958 GB, outvar_size=1.354 GB, temp_buffer_size=14.513 GB, available_memory=17.580 GB)
result[(2, 4, 1, 1), 1] = ModuleProfileResult(compute_cost=1.658, peak_memory=19.954 GB, invar_size=1.657 GB, outvar_size=0.704 GB, temp_buffer_size=18.172 GB, available_memory=17.580 GB)
result[(2, 4, 1, 0), 1] = ModuleProfileResult(compute_cost=0.743, peak_memory=17.077 GB, invar_size=2.564 GB, outvar_size=1.219 GB, temp_buffer_size=14.451 GB, available_memory=17.580 GB)
result[(2, 4, 1, 2), 1] = ModuleProfileResult(compute_cost=0.743, peak_memory=17.077 GB, invar_size=2.564 GB, outvar_size=1.219 GB, temp_buffer_size=14.451 GB, available_memory=17.580 GB)
result[(3, 5, 1, 0), 1] = ModuleProfileResult(compute_cost=0.813, peak_memory=15.668 GB, invar_size=2.783 GB, outvar_size=1.360 GB, temp_buffer_size=12.822 GB, available_memory=17.580 GB)
result[(3, 5, 1, 1), 1] = ModuleProfileResult(compute_cost=1.713, peak_memory=16.462 GB, invar_size=1.673 GB, outvar_size=0.774 GB, temp_buffer_size=14.664 GB, available_memory=17.580 GB)
result[(3, 5, 1, 2), 1] = ModuleProfileResult(compute_cost=0.835, peak_memory=15.535 GB, invar_size=2.587 GB, outvar_size=1.262 GB, temp_buffer_size=12.885 GB, available_memory=17.580 GB)
Profiling for submesh 1 (1, 2) takes 41.52 seconds
--------------------------------------------------
- Profiling for submesh 0 (1, 1):
- Generate all stage infos (Jaxpr -> HLO)
- Compile all stages
- Profile all stages
result[(0, 0, 0, 1), 0] = ModuleProfileResult(compute_cost=0.224, peak_memory=3.854 GB, invar_size=0.573 GB, outvar_size=0.125 GB, temp_buffer_size=3.156 GB, available_memory=17.580 GB)
result[(0, 0, 0, 0), 0] = ModuleProfileResult(compute_cost=0.224, peak_memory=3.854 GB, invar_size=0.573 GB, outvar_size=0.125 GB, temp_buffer_size=3.156 GB, available_memory=17.580 GB)
result[(0, 0, 0, 1), 1] = ModuleProfileResult(compute_cost=0.588, peak_memory=29.077 GB, invar_size=1.270 GB, outvar_size=0.572 GB, temp_buffer_size=27.807 GB, available_memory=17.580 GB)
result[(0, 0, 0, 0), 1] = ModuleProfileResult(compute_cost=0.588, peak_memory=29.077 GB, invar_size=1.270 GB, outvar_size=0.572 GB, temp_buffer_size=27.807 GB, available_memory=17.580 GB)
result[(3, 4, 0, 0), 0] = ModuleProfileResult(compute_cost=0.302, peak_memory=3.501 GB, invar_size=0.876 GB, outvar_size=0.250 GB, temp_buffer_size=2.375 GB, available_memory=17.580 GB)
result[(3, 4, 0, 1), 0] = ModuleProfileResult(compute_cost=0.302, peak_memory=3.501 GB, invar_size=0.876 GB, outvar_size=0.250 GB, temp_buffer_size=2.375 GB, available_memory=17.580 GB)
result[(3, 4, 0, 0), 1] = ModuleProfileResult(compute_cost=0.907, peak_memory=30.917 GB, invar_size=1.876 GB, outvar_size=0.875 GB, temp_buffer_size=28.916 GB, available_memory=17.580 GB)
result[(3, 4, 0, 1), 1] = ModuleProfileResult(compute_cost=0.907, peak_memory=30.917 GB, invar_size=1.876 GB, outvar_size=0.875 GB, temp_buffer_size=28.916 GB, available_memory=17.580 GB)
Profiling for submesh 0 (1, 1) takes 12.29 seconds
--------------------------------------------------
Profile result saved to: profile-results-2023-11-17-02-52-55.npy
----------------------------------------------------------------------
[E] Meet unexpected error in compiling executables...

[E] Unexpected error occurred in compiling or profiling executables...
[TMP] Current profiling results of key `2_a10_2_n_2_d`: none
[TMP] Updated profiling results stored in `./jaxpr/prof_log/optimal/bert_1.3B_512.pkl`...
